<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="HTML5 CANVAS 弹幕插件--DanMuer.js（V3.2.5）"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>HTML5 CANVAS 弹幕插件--DanMuer.js（V3.2.5） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/3ypeos14d1u/",
				"appid": "1613049289050283", 
				"title": "HTML5 CANVAS 弹幕插件--DanMuer.js（V3.2.5） | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-09T02:30:12"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/hlg66wy89ih/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/g3c9oft2bqb/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f&text=HTML5%20CANVAS%20%e5%bc%b9%e5%b9%95%e6%8f%92%e4%bb%b6--DanMuer.js%ef%bc%88V3.2.5%ef%bc%89"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f&text=HTML5%20CANVAS%20%e5%bc%b9%e5%b9%95%e6%8f%92%e4%bb%b6--DanMuer.js%ef%bc%88V3.2.5%ef%bc%89"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f&title=HTML5%20CANVAS%20%e5%bc%b9%e5%b9%95%e6%8f%92%e4%bb%b6--DanMuer.js%ef%bc%88V3.2.5%ef%bc%89"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f&is_video=false&description=HTML5%20CANVAS%20%e5%bc%b9%e5%b9%95%e6%8f%92%e4%bb%b6--DanMuer.js%ef%bc%88V3.2.5%ef%bc%89"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=HTML5%20CANVAS%20%e5%bc%b9%e5%b9%95%e6%8f%92%e4%bb%b6--DanMuer.js%ef%bc%88V3.2.5%ef%bc%89&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f&title=HTML5%20CANVAS%20%e5%bc%b9%e5%b9%95%e6%8f%92%e4%bb%b6--DanMuer.js%ef%bc%88V3.2.5%ef%bc%89"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f&title=HTML5%20CANVAS%20%e5%bc%b9%e5%b9%95%e6%8f%92%e4%bb%b6--DanMuer.js%ef%bc%88V3.2.5%ef%bc%89"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f&title=HTML5%20CANVAS%20%e5%bc%b9%e5%b9%95%e6%8f%92%e4%bb%b6--DanMuer.js%ef%bc%88V3.2.5%ef%bc%89"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f3ypeos14d1u%2f&title=HTML5%20CANVAS%20%e5%bc%b9%e5%b9%95%e6%8f%92%e4%bb%b6--DanMuer.js%ef%bc%88V3.2.5%ef%bc%89"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">HTML5 CANVAS 弹幕插件--DanMuer.js（V3.2.5）</h1><div class="meta"><div class="postdate"><time datetime="2019-01-09" itemprop="datePublished">2019-01-09</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e最新版本 V 3.2.5\x3c\/h2\x3e\n\x3cp\x3e新增了图片弹幕类型，修改了demo展示页面，调整了部分代码，具体请参看git里的CHANGELOG.md和README.md\x3c\/p\x3e\n\x3cp\x3e文章里主要讲实现方法和设计思想，所以有部分接口依旧是老版本接口，最新的接口请去git里面查看\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e前言\x3c\/h2\x3e\n\x3cp\x3e说实话，从\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000007951317\x22\x3e第二版\x3c\/a\x3e到现在又过了半年，本来以为可能不会写第三版的，顶多将第二版的代码重构下就可以了，没想到还是花了一个星期左右续写了第三版。主要是因为第二版中 播放器模块和弹幕模块耦合得太严重了，远远达不到我想要的效果，所以续写了第三版。这次的代码将更轻，我去除了播放器模块，使得插件的适用范围更加的扩大，而且让我有点惊喜的是在写第三版的过程中又让弹幕系统的性能进一步得到了提升，可以讲也是额外的惊喜了。\x3c\/p\x3e\n\x3cp\x3e由于第三版我是用ES6语法写的，所以兼容性不是很好（没错，我只是在针对IE），就算用babel转成ES5，IE依旧毒，目前支持IE10\x2b。\x3cdel\x3e所以后面我会抽个时间去写个ES5全兼容版本的，不考虑IE或者只是对源码感兴趣的可以尽情使用\x3c\/del\x3e。\x3c\/p\x3e\n\x3cp\x3egithub : \x3ca href=\x22https:\/\/github.com\/lonelymoon\/DanMuer\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3egithub\x3c\/a\x3e \x3cbr\x3eAPI接口都在git里面，文章不会介绍插件使用相关的内容，仅仅解释部分源码和设计思想，如果觉得插件还行，请大家git给个星，谢谢\x3cbr\x3edemo : \x3ca href=\x22http:\/\/lonelymoon.linux2.jiuhost.com\/DMv3\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e我是demo\x3c\/a\x3e\x3c\/p\x3e\n\x3ch4\x3e注意：\x3c\/h4\x3e\n\x3cp\x3e我碰到好像有人对demo不知道怎么操作，下面我简单介绍下基本操作：\x3cbr\x3e所有已发布功能项可以通过下拉框进行切换，目前包括“添加普通弹幕”，“添加高级弹幕”，“过滤”，“添加全局样式”，“控制项”\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e添加普通弹幕和添加高级弹幕都只是添加数据而已，不会运行插件，你需要跳到“控制项”点击启动，然后等弹幕出来即可\x3c\/li\x3e\n\x3cli\x3e高级弹幕的动画是属于排队动画，你要先将修改后的数据“保存为第n步”（n至少为1）后点击确定添加才可以\x3c\/li\x3e\n\x3cli\x3e过滤功能的话，最简单的“type”：“slide”，表示过滤所有滚动型的弹幕，或者“text”：“string”表示过滤包含string的所有弹幕\x3c\/li\x3e\n\x3cli\x3e你可以先启动然后添加弹幕，也是一样的，操作顺序没太高要求\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3chr\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e代码的那些事\x3c\/h2\x3e\n\x3cp\x3e源码总共由5部分组成：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e普通弹幕类\x3c\/li\x3e\n\x3cli\x3e高级弹幕类\x3c\/li\x3e\n\x3cli\x3e主程序类\x3c\/li\x3e\n\x3cli\x3e封装输出函数\x3c\/li\x3e\n\x3cli\x3eTween算法类\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e第4和第5个部分比较简单，第5部分就是Tween算法，原汁原味，第4部分则是将所有内部的接口进行过滤，选择性地暴露一些我想暴露的内部功能接口，并且提供一个对外的接口，增加一点稳定性罢了。源码如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let DanMuer = function(wrapper,opts){\n    let proxyDMer = new Proxy( new DMer(wrapper,opts), {\n        get : function(target,key){\n            if(typeof target[key] == \x26quot;function\x26quot;)\n            return target[key].bind(target);\n            return target[key];\n        }\n    }); \/\/保证this指向原对象\n\n    let DM = proxyDMer;\n\n    \/\/选择性的暴露某些接口\n    return {\n        pause : DM.pause, \/\/暂停\n        run : DM.run, \/\/继续\n        start : DM.start, \/\/运行\n        stop : DM.stop,    \/\/停止\n        changeStyle : DM.changeStyle, \/\/修改普通弹幕全局样式\n        addGradient : DM.addGradient, \/\/普通弹幕渐变\n        setSize : DM.setSize, \/\/修改宽高\n        inputData : DM.inputData, \/\/向普通弹幕插入数据\n        inputEffect : DM.inputEffect, \/\/向高级弹幕插入数据\n        clear : DM.clear, \/\/清除所有弹幕\n        reset : DM.reset, \/\/重新从某个弹幕开始\n        addFilter : DM.addFilter, \/\/添加过滤\n        removeFilter : DM.removeFilter, \/\/删除过滤\n        disableEffect : DM.disableEffect, \/\/不启用高级弹幕\n        enableEffect : DM.enableEffect, \/\/启用高级弹幕\n        getSize : DM.getSize, \/\/获取宽高,\n        getFPS : DM.getFPS \/\/获取fps\n    };\n};\n\n\/\/提供对外的引用接口\nif( typeof module != \x27undefined\x27 \x26amp;\x26amp; module.exports ){\n    module.exports = DanMuer;\n} else if( typeof define == \x26quot;function\x26quot; \x26amp;\x26amp; define.amd ){\n    define(function(){ return DanMuer;});\n} else {\n    window.DanMuer = DanMuer;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e DanMuer = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ewrapper,opts\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e proxyDMer = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eProxy\x3c\/span\x3e( \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e DMer(wrapper,opts), {\n        \x3cspan class=\x22hljs-attr\x22\x3eget\x3c\/span\x3e : \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3etarget,key\x3c\/span\x3e)\x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e target[key] == \x3cspan class=\x22hljs-string\x22\x3e\x22function\x22\x3c\/span\x3e)\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e target[key].bind(target);\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e target[key];\n        }\n    }); \x3cspan class=\x22hljs-comment\x22\x3e\/\/保证this指向原对象\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e DM = proxyDMer;\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/选择性的暴露某些接口\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-attr\x22\x3epause\x3c\/span\x3e : DM.pause, \x3cspan class=\x22hljs-comment\x22\x3e\/\/暂停\x3c\/span\x3e\n        run : DM.run, \x3cspan class=\x22hljs-comment\x22\x3e\/\/继续\x3c\/span\x3e\n        start : DM.start, \x3cspan class=\x22hljs-comment\x22\x3e\/\/运行\x3c\/span\x3e\n        stop : DM.stop,    \x3cspan class=\x22hljs-comment\x22\x3e\/\/停止\x3c\/span\x3e\n        changeStyle : DM.changeStyle, \x3cspan class=\x22hljs-comment\x22\x3e\/\/修改普通弹幕全局样式\x3c\/span\x3e\n        addGradient : DM.addGradient, \x3cspan class=\x22hljs-comment\x22\x3e\/\/普通弹幕渐变\x3c\/span\x3e\n        setSize : DM.setSize, \x3cspan class=\x22hljs-comment\x22\x3e\/\/修改宽高\x3c\/span\x3e\n        inputData : DM.inputData, \x3cspan class=\x22hljs-comment\x22\x3e\/\/向普通弹幕插入数据\x3c\/span\x3e\n        inputEffect : DM.inputEffect, \x3cspan class=\x22hljs-comment\x22\x3e\/\/向高级弹幕插入数据\x3c\/span\x3e\n        clear : DM.clear, \x3cspan class=\x22hljs-comment\x22\x3e\/\/清除所有弹幕\x3c\/span\x3e\n        reset : DM.reset, \x3cspan class=\x22hljs-comment\x22\x3e\/\/重新从某个弹幕开始\x3c\/span\x3e\n        addFilter : DM.addFilter, \x3cspan class=\x22hljs-comment\x22\x3e\/\/添加过滤\x3c\/span\x3e\n        removeFilter : DM.removeFilter, \x3cspan class=\x22hljs-comment\x22\x3e\/\/删除过滤\x3c\/span\x3e\n        disableEffect : DM.disableEffect, \x3cspan class=\x22hljs-comment\x22\x3e\/\/不启用高级弹幕\x3c\/span\x3e\n        enableEffect : DM.enableEffect, \x3cspan class=\x22hljs-comment\x22\x3e\/\/启用高级弹幕\x3c\/span\x3e\n        getSize : DM.getSize, \x3cspan class=\x22hljs-comment\x22\x3e\/\/获取宽高,\x3c\/span\x3e\n        getFPS : DM.getFPS \x3cspan class=\x22hljs-comment\x22\x3e\/\/获取fps\x3c\/span\x3e\n    };\n};\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/提供对外的引用接口\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e( \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e != \x3cspan class=\x22hljs-string\x22\x3e\x27undefined\x27\x3c\/span\x3e \x26amp;\x26amp; \x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports ){\n    \x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = DanMuer;\n} \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e( \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e define == \x3cspan class=\x22hljs-string\x22\x3e\x22function\x22\x3c\/span\x3e \x26amp;\x26amp; define.amd ){\n    define(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{ \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e DanMuer;});\n} \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.DanMuer = DanMuer;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e第3个部分属于入口类，事实上每次调用插件都会先对第3部分进行实例化，这里主要保存一些对外暴露的API接口，还有就是插件的初始化函数，事件函数以及主循环函数，用于对插件总体的控制，部分源码如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/初始化\n    constructor(wrap,opts = {}){\n\n        if(!wrap){\n            throw new Error(\x26quot;没有设置正确的wrapper\x26quot;);\n        }\n\n        \/\/datas\n        this.wrapper = wrap;\n        this.width = wrap.clientWidth;\n        this.height = wrap.clientHeight;\n        this.canvas = document.createElement(\x26quot;canvas\x26quot;);\n        this.canvas2 = document.createElement(\x26quot;canvas\x26quot;);\n\n        this.normal = new normalDM(this.canvas,opts); \/\/这里是普通弹幕的对象\n        this.effect = new effectDM(this.canvas2,opts); \/\/这里是高级弹幕的对象\n\n        this.name = opts.name || \x26quot;\x26quot;; \/\/没卵用\n        this.fps = 0;\n\n        \/\/status\n        this.drawing = opts.auto || false;\n        this.startTime = new Date().getTime();\n\n        \/\/fn\n        this[init]();\n        this[loop]();\n        if(opts.enableEvent)\n        this.initEvent(opts);\n    }\n\n    [init](){\n        \/\/生成对应的canvas\n        this.canvas.style.cssText = \x26quot;position:absolute;z-index:100;top:0px;left:0px;\x26quot;;\n        this.canvas2.style.cssText = \x26quot;position:absolute;z-index:101;top:0px;left:0px;\x26quot;;\n        this.setSize();\n        this.wrapper.appendChild(this.canvas);\n        this.wrapper.appendChild(this.canvas2);\n    }\n\n    \/\/loop\n    [loop](normal = this.normal,effect = this.effect,prev = this.startTime){\n        \n        let now = new Date().getTime();\n\n        if(!this.drawing){\n            normal.clearRect();\n            effect.clearRect();\n            return false;\n        } else {\n            let [w,h,time] = [this.width,this.height,now - prev];\n            this.fps = 1000 \/ time \x3e\x3e 0;\n            \/\/这里进行内部的循环操作\n            normal.update(w,h,time);\n            effect.update(w,h,time);\n        }\n\n        requestAnimationFrame( () =\x3e { this[loop](normal,effect,now); } );\n    }\n    \n    \/\/主要对鼠标右键进行绑定\n    initEvent(opts){\n        let [el,normal,searching] = [this.canvas2,this.normal,false];\n\n        el.onmouseup = function(e){\n            e = e || event;\n\n            if( searching ) return false;\n            searching = true;\n\n            if( e.button == 2 ){\n                let [pos,result] = [e.target.getBoundingClientRect(),\x26quot;\x26quot;];\n                let [x,y,i,items,item] = [ e.clientX - pos.left,\n                                             e.clientY - pos.top,\n                                             0, normal.save ];\n                for( ; item = items[i\x2b\x2b]; ){\n                    let [ix,iy,w,h] = [item.x, item.y, item.width \x2b 10, item.height];\n\n                    if( x \x3c ix  || x \x3e ix \x2b w || y \x3c iy - h\/2 || y \x3e iy \x2b h\/2 || item.hide || item.recovery )\n                    continue;\n\n                    result = item;\n                    break;\n                }\n            \n                let callback = opts.callback || function(){};\n\n                callback(result);\n\n                searching = false;\n            }\n\n        };\n\n        el.oncontextmenu = function(e){\n            e = e || event;\n            e.preventDefault();\n        };\n\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/初始化\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(wrap,opts = {}){\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(!wrap){\n            \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e new Error(\x3cspan class=\x22hljs-string\x22\x3e\x22没有设置正确的wrapper\x22\x3c\/span\x3e);\n        }\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/datas\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.wrapper = wrap;\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.width = wrap.clientWidth;\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.height = wrap.clientHeight;\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.canvas = document.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x22canvas\x22\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.canvas2 = document.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x22canvas\x22\x3c\/span\x3e);\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.normal = new normalDM(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.canvas,opts); \x3cspan class=\x22hljs-comment\x22\x3e\/\/这里是普通弹幕的对象\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.effect = new effectDM(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.canvas2,opts); \x3cspan class=\x22hljs-comment\x22\x3e\/\/这里是高级弹幕的对象\x3c\/span\x3e\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.name = opts.name || \x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/没卵用\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.fps = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/status\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.drawing = opts.auto || \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.startTime = new Date().getTime();\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/fn\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[init]();\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[loop]();\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(opts.enableEvent)\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.initEvent(opts);\n    }\n\n    [init](){\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/生成对应的canvas\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.canvas.style.cssText = \x3cspan class=\x22hljs-string\x22\x3e\x22position:absolute;z-index:100;top:0px;left:0px;\x22\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.canvas2.style.cssText = \x3cspan class=\x22hljs-string\x22\x3e\x22position:absolute;z-index:101;top:0px;left:0px;\x22\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setSize();\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.wrapper.appendChild(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.canvas);\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.wrapper.appendChild(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.canvas2);\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/loop\x3c\/span\x3e\n    [loop](normal = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.normal,effect = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.effect,prev = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.startTime){\n        \n        let now = new Date().getTime();\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(!\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.drawing){\n            normal.clearRect();\n            effect.clearRect();\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            let [w,h,time] = [\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.width,\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.height,now - prev];\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.fps = \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e \/ time \x26gt;\x26gt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/这里进行内部的循环操作\x3c\/span\x3e\n            normal.update(w,h,time);\n            effect.update(w,h,time);\n        }\n\n        requestAnimationFrame( () =\x26gt; { \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[loop](normal,effect,now); } );\n    }\n    \n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/主要对鼠标右键进行绑定\x3c\/span\x3e\n    initEvent(opts){\n        let [el,normal,searching] = [\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.canvas2,\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.normal,\x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e];\n\n        el.onmouseup = function(e){\n            e = e || event;\n\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e( searching ) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n            searching = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e( e.button == \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e ){\n                let [pos,result] = [e.target.getBoundingClientRect(),\x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e];\n                let [x,y,i,items,item] = [ e.clientX - pos.left,\n                                             e.clientY - pos.top,\n                                             \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, normal.save ];\n                \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e( ; item = items[i\x2b\x2b]; ){\n                    let [ix,iy,w,h] = [item.x, item.y, item.width \x2b \x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e, item.height];\n\n                    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e( x \x26lt; ix  || x \x26gt; ix \x2b w || y \x26lt; iy - h\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e || y \x26gt; iy \x2b h\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e || item.hide || item.recovery )\n                    \x3cspan class=\x22hljs-keyword\x22\x3econtinue\x3c\/span\x3e;\n\n                    result = item;\n                    \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n                }\n            \n                let callback = opts.callback || function(){};\n\n                callback(result);\n\n                searching = \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n            }\n\n        };\n\n        el.oncontextmenu = function(e){\n            e = e || event;\n            e.preventDefault();\n        };\n\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e源码最主要的就是第1部分和第2部分，大家在git-\x26gt;src里面可以看到两个类分别对应的文件，源码里面我的注释打了很多，而且每个函数的长度都不长，很容易看懂，这里就不对每一个功能做具体介绍了，下面主要讲讲几个比较重要的函数和设计思想：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/*循环，这里是对主程序暴露的主要接口，用于普通弹幕内部的循环工作，其实工作流程主要由几个步骤组成：\n** 1.判断全局样式是否发生变化，保持全局样式的准确性\n** 2.判断当前弹幕机的状态（如暂停、运行等）并进行相关操作\n** 3.更新for循环的初始下标（startIndex），主要是用于性能的优化\n** 4.计算每个弹幕的状态\n** 5.绘制弹幕\n** 6.对每个弹幕的状态进行评估，如果已经显示完成就进行回收\n** 基本上其他的功能都是围绕这些步骤开始拓展和完善，明白了工作原理后其他的函数就很好理\n** 解了，都是为了完成这些工作流程而进行的，而且基本上源码里都有注释，这里就不详细说了\n*\/\n    update(w,h,time){\n\n        let [items,cxt] = [this.save,this.cxt];\n\n        this.globalChanged \x26amp;\x26amp; this.initStyle(cxt); \/\/初始化全局样式\n\n        !this.looped \x26amp;\x26amp; this.countWidth(items); \/\/计算文本宽度以及初始化位置（只执行一次）\n\n        if( this.paused ) return false; \/\/暂停\n\n        this.refresh(items); \/\/更新初始下标startIndex\n\n        let [i,item] = [this.startIndex];\n\n        cxt.clearRect(0,0,w,h);\n\n        for(  ; item = items[i\x2b\x2b]; ){\n            this.step(item,time);\n            this.draw(item,cxt);\n            this.recovery(item,w);\n        }\n\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/*循环，这里是对主程序暴露的主要接口，用于普通弹幕内部的循环工作，其实工作流程主要由几个步骤组成：\n** 1.判断全局样式是否发生变化，保持全局样式的准确性\n** 2.判断当前弹幕机的状态（如暂停、运行等）并进行相关操作\n** 3.更新for循环的初始下标（startIndex），主要是用于性能的优化\n** 4.计算每个弹幕的状态\n** 5.绘制弹幕\n** 6.对每个弹幕的状态进行评估，如果已经显示完成就进行回收\n** 基本上其他的功能都是围绕这些步骤开始拓展和完善，明白了工作原理后其他的函数就很好理\n** 解了，都是为了完成这些工作流程而进行的，而且基本上源码里都有注释，这里就不详细说了\n*\/\x3c\/span\x3e\n    update(w,h,time){\n\n        let [items,cxt] = [\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.save,\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.cxt];\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.globalChanged \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.initStyle(cxt); \x3cspan class=\x22hljs-comment\x22\x3e\/\/初始化全局样式\x3c\/span\x3e\n\n        !\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.looped \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.countWidth(items); \x3cspan class=\x22hljs-comment\x22\x3e\/\/计算文本宽度以及初始化位置（只执行一次）\x3c\/span\x3e\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e( \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.paused ) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/暂停\x3c\/span\x3e\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.refresh(items); \x3cspan class=\x22hljs-comment\x22\x3e\/\/更新初始下标startIndex\x3c\/span\x3e\n\n        let [i,item] = [\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.startIndex];\n\n        cxt.clearRect(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,w,h);\n\n        \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(  ; item = items[i\x2b\x2b]; ){\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.step(item,time);\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.draw(item,cxt);\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.recovery(item,w);\n        }\n\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e针对普通弹幕类还有一个有点难理解的是“通道”的获取。这里的“通道”是指弹幕从右往左运行时所在的那一行位置，这些通道是在canvas尺寸变化时生成的，不同类型的弹幕都有其通道集合。当一条新弹幕需要显示在canvas上时需要去获取它被分配的位置，也就是通道，通道被占用时，该行将不会重新放置新的弹幕， 当通道已经被分配完成后，将会随机生成一条临时通道，临时通道的位置随机出现，并且临时通过被释放时不会被收回通道集合中，而正常通道会被收回到集合中以待被下一个弹幕调用。下面是代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/生成通道行\n    countRows(){\n\n        \/\/保存临时变量\n        let unitHeight = parseInt(this.globalSize) \x2b this.space;\n        let [rowNum , rows] = [\n            ( ( this.height - 20 ) \/ unitHeight ) \x3e\x3e 0,\n            this.rows\n        ];\n\n        \/\/重置通道\n        for( let key of Object.keys(rows) ){\n            rows[key] = [];\n        }\n\n        \/\/重新生成通道\n        for( let i = 0 ; i \x3c rowNum; i\x2b\x2b ){\n            let obj = {\n                idx : i,\n                y : unitHeight * i \x2b 20\n            };\n            rows.slide.push(obj);\n\n            i \x3e= rowNum \/ 2 ? rows.bottom.push(obj) : rows.top.push(obj);\n        }\n\n        \/\/更新实例属性\n        this.unitHeight = unitHeight;\n        this.rowNum = rowNum;\n    }\n\n\n\n\/\/获取通道\n    getRow(item){\n        \n        \/\/如果该弹幕正在显示中，则返回其现有通道\n        if( item.row ) \n        return item.row;\n\n        \/\/获取新通道\n        const [rows,type] = [this.rows,item.type];\n        const row = ( type != \x26quot;bottom\x26quot; ? rows[type].shift() : rows[type].pop() );\n        \/\/生成临时通道\n        const tempRow = this[\x26quot;getRow_\x26quot;\x2btype]();\n\n        if( row \x26amp;\x26amp; item.type == \x26quot;slide\x26quot; ){\n            item.x \x2b= ( row.idx * 8 );\n            item.speed \x2b= ( row.idx \/ 3 );\n        }\n\n        \/\/返回分配的通道\n        return row || tempRow;\n\n    }\n\n    getRow_bottom(){\n        return {\n            y : 20 \x2b this.unitHeight * ( ( Math.random() * this.rowNum \/ 2 \x2b this.rowNum \/ 2 ) \x3c\x3c 0 ),\n            speedChange : false,\n            tempItem : true\n        };\n    }\n\n    getRow_slide(){\n        return {\n            y : 20 \x2b this.unitHeight * ( ( Math.random() * this.rowNum ) \x3c\x3c 0 ),\n            speedChange : true,\n            tempItem : true\n        };\n    }\n\n    getRow_top(){\n        return {\n            y : 20 \x2b this.unitHeight * ( ( Math.random() * this.rowNum \/ 2 ) \x3c\x3c 0 ),\n            speedChange : false,\n            tempItem : true\n        };\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/生成通道行\x3c\/span\x3e\n    countRows(){\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/保存临时变量\x3c\/span\x3e\n        let unitHeight = parseInt(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.globalSize) \x2b \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.space;\n        let [rowNum , rows] = [\n            ( ( \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.height - \x3cspan class=\x22hljs-number\x22\x3e20\x3c\/span\x3e ) \/ unitHeight ) \x26gt;\x26gt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.rows\n        ];\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/重置通道\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e( let key of Object.keys(rows) ){\n            rows[key] = [];\n        }\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/重新生成通道\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e( let i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ; i \x26lt; rowNum; i\x2b\x2b ){\n            let obj = {\n                idx : i,\n                y : unitHeight * i \x2b \x3cspan class=\x22hljs-number\x22\x3e20\x3c\/span\x3e\n            };\n            rows.slide.push(obj);\n\n            i \x26gt;= rowNum \/ \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e ? rows.bottom.push(obj) : rows.top.push(obj);\n        }\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/更新实例属性\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.unitHeight = unitHeight;\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.rowNum = rowNum;\n    }\n\n\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/获取通道\x3c\/span\x3e\n    getRow(item){\n        \n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/如果该弹幕正在显示中，则返回其现有通道\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e( item.row ) \n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e item.row;\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/获取新通道\x3c\/span\x3e\n        const [rows,type] = [\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.rows,item.type];\n        const row = ( type != \x3cspan class=\x22hljs-string\x22\x3e\x22bottom\x22\x3c\/span\x3e ? rows[type].shift() : rows[type].pop() );\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/生成临时通道\x3c\/span\x3e\n        const tempRow = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e[\x3cspan class=\x22hljs-string\x22\x3e\x22getRow_\x22\x3c\/span\x3e\x2btype]();\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e( row \x26amp;\x26amp; item.type == \x3cspan class=\x22hljs-string\x22\x3e\x22slide\x22\x3c\/span\x3e ){\n            item.x \x2b= ( row.idx * \x3cspan class=\x22hljs-number\x22\x3e8\x3c\/span\x3e );\n            item.speed \x2b= ( row.idx \/ \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e );\n        }\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/返回分配的通道\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e row || tempRow;\n\n    }\n\n    getRow_bottom(){\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n            y : \x3cspan class=\x22hljs-number\x22\x3e20\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.unitHeight * ( ( Math.random() * \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.rowNum \/ \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.rowNum \/ \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e ) \x26lt;\x26lt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ),\n            speedChange : \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n            tempItem : \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n        };\n    }\n\n    getRow_slide(){\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n            y : \x3cspan class=\x22hljs-number\x22\x3e20\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.unitHeight * ( ( Math.random() * \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.rowNum ) \x26lt;\x26lt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ),\n            speedChange : \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n            tempItem : \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n        };\n    }\n\n    getRow_top(){\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\n            y : \x3cspan class=\x22hljs-number\x22\x3e20\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.unitHeight * ( ( Math.random() * \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.rowNum \/ \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e ) \x26lt;\x26lt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ),\n            speedChange : \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n            tempItem : \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n        };\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e高级弹幕类与普通弹幕类有点微妙的差别，但总体是一样，唯一需要在意的是与计算相关的代码，因为不难所以这里也不做继续说明了，请参看源码里的注释。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e结语\x3c\/h2\x3e\n\x3cp\x3e就第二版来说，第三版性能更好，而且实现了播放器模块和弹幕模块的解耦，也就是说相比第二版，第三版 可以适用但不限于播放器，可用性更高，而且实现了高级弹幕的发送，未来将慢慢补齐更多的功能和代码重构，希望大家遇到什么BUG或者是有某些的需求，请私信或是将反馈提交到本邮箱：454236029@qq.com || z454236029@gmail.com，如果觉得本插件对你有用欢迎给个星，谢谢。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>HTML5 CANVAS 弹幕插件&ndash;DanMuer.js（V3.2.5）</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010095752">https://segmentfault.com/a/1190000010095752</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/3ypeos14d1u/" target="_blank">https://alili.tech/archive/3ypeos14d1u/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5328xogjarn/">IndexedDB--HTML5本地存储<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/xpccu0hsqbr/">JS学习系列 01 - 编译原理和作用域<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/shv09bbtbfd/">Vue2 SSR 的优化之旅<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/5vj1ojfo6h6/">[2016年末巨献] — HTML5可交互地铁线路图（第二季：帝都进阶版）<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/m02hlm4bzh/">vue2.0开发聊天程序（三）组件的通信<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/mz5o7n90plg/">《很高兴我没有猝死》- 前端新人的 2016 年总结和感悟<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/3vhoe2mo09k/">一道颇有难度的JavaScript题<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/uj12mb7thp/">使用CANVAS实现交互性圆形马赛克效果<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/ja636h8hcxa/">写于 2016 年末<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/5uomnoq1kmi/">前端学习资源整理<aside class="dates">2019-01-28</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>