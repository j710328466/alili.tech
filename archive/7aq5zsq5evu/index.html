<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="利用express&#43;socket.io实现一个简易版聊天室"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>利用express&#43;socket.io实现一个简易版聊天室 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/7aq5zsq5evu/",
				"appid": "1613049289050283", 
				"title": "利用express&#43;socket.io实现一个简易版聊天室 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-02T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/jjcqxm4awyd/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/u3ldvzk86w/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f&text=%e5%88%a9%e7%94%a8express%2bsocket.io%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e6%98%93%e7%89%88%e8%81%8a%e5%a4%a9%e5%ae%a4"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f&text=%e5%88%a9%e7%94%a8express%2bsocket.io%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e6%98%93%e7%89%88%e8%81%8a%e5%a4%a9%e5%ae%a4"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f&title=%e5%88%a9%e7%94%a8express%2bsocket.io%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e6%98%93%e7%89%88%e8%81%8a%e5%a4%a9%e5%ae%a4"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f&is_video=false&description=%e5%88%a9%e7%94%a8express%2bsocket.io%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e6%98%93%e7%89%88%e8%81%8a%e5%a4%a9%e5%ae%a4"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%88%a9%e7%94%a8express%2bsocket.io%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e6%98%93%e7%89%88%e8%81%8a%e5%a4%a9%e5%ae%a4&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f&title=%e5%88%a9%e7%94%a8express%2bsocket.io%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e6%98%93%e7%89%88%e8%81%8a%e5%a4%a9%e5%ae%a4"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f&title=%e5%88%a9%e7%94%a8express%2bsocket.io%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e6%98%93%e7%89%88%e8%81%8a%e5%a4%a9%e5%ae%a4"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f&title=%e5%88%a9%e7%94%a8express%2bsocket.io%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e6%98%93%e7%89%88%e8%81%8a%e5%a4%a9%e5%ae%a4"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f7aq5zsq5evu%2f&title=%e5%88%a9%e7%94%a8express%2bsocket.io%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e6%98%93%e7%89%88%e8%81%8a%e5%a4%a9%e5%ae%a4"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">利用express&#43;socket.io实现一个简易版聊天室</h1><div class="meta"><div class="postdate"><time datetime="2019-02-02" itemprop="datePublished">2019-02-02</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e写在前面\x3c\/h2\x3e\n\x3cp\x3e最近由于利用\x3ccode\x3enode\x3c\/code\x3e重构某个项目，项目中有一个实时聊天的功能，于是就研究了一下聊天室，\x3ca href=\x22http:\/\/www.zp1996.top:6323\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e在线demo\x3c\/a\x3e|\x3ca href=\x22https:\/\/github.com\/zp1996\/chat\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e源码\x3c\/a\x3e，欢迎大家反馈。这个聊天室的主要利用到了\x3ccode\x3esocket.io\x3c\/code\x3e和\x3ccode\x3eexpress\x3c\/code\x3e。这个聊天室支持群聊，私聊，支持发送图片（PS：大家在体验时最好开启两个浏览器，自问自答）。下面就来和大家分享下实现过程：\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eWebSocket\x3c\/h2\x3e\n\x3cblockquote\x3e\x3cp\x3eHTML5一种新的协议。它实现了浏览器与服务器全双工通信。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e为了更好的理解\x3ccode\x3eWebSocket\x3c\/code\x3e，需要了解一下在没有\x3ccode\x3eWebSocket\x3c\/code\x3e阶段是如何写聊天室这种实时系统的：\x3cbr\x3e基于\x3ccode\x3ehttp\x3c\/code\x3e协议浏览器可以实现单向通信，只能由浏览器发起请求（Request），服务器进行响应（Response），一个请求对应一个响应。由于服务器不能主动向客户端推送消息，于是普遍采用的方式就是\x3cstrong\x3e轮询（polling）\x3c\/strong\x3e，轮询实现起来非常简单，就是定时的利用\x3ccode\x3eajax\x3c\/code\x3e向服务器端进行请求。\x3cstrong\x3e如果服务器有新的数据就返回新的数据，如果没有数据就返回空响应\x3c\/strong\x3e。用代码来模拟下就是这个样子的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 前端请求代码\nfunction update (fn) {\n    var xhr = new XMLHttpRequest();\n    xhr.open(\x26quot;get\x26quot;, \x26quot;.\/update.php\x26quot;);\n    xhr.onreadystatechange = function(){    \n    if(xhr.readyState === 4){\n      if(xhr.status == 200){    \n        const res = JSON.parse(xhr.response);\n          if (res.flag) {\n              \/\/ 进行相应操作\n              \n              \/\/ fn为接到响应后的处理函数\n              fn \x26amp;\x26amp; fn(fn);\n          }\n      }\n    }\n    };\n    xhr.send();\n}\nfunction polling () {\n    update();\n}\nsetInterval(polling, 2000);\n\/\/ 后台响应代码\n\x3c?php\n    \/\/ 利用随机数的大小来模拟是否有新数据\n    if (rand(1, 100) \x3c 35) {\n        echo json_encode(array( \n            \x26quot;flag\x26quot; =\x3e true, \n            \x26quot;data\x26quot; =\x3e \x27有新数据来了\x27\n        ));\n    } else {\n        echo json_encode(array(\n            \x26quot;flag\x26quot; =\x3e false\n        ));\n    }\n?\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 前端请求代码\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eupdate\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(fn)\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e xhr = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e XMLHttpRequest();\n    xhr.open(\x3cspan class=\x22hljs-string\x22\x3e\x22get\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22.\/update.php\x22\x3c\/span\x3e);\n    xhr.onreadystatechange = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{    \n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(xhr.readyState === \x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e){\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(xhr.status == \x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e){    \n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e res = JSON.parse(xhr.response);\n          \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res.flag) {\n              \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 进行相应操作\x3c\/span\x3e\n              \n              \x3cspan class=\x22hljs-comment\x22\x3e\/\/ fn为接到响应后的处理函数\x3c\/span\x3e\n              fn \x26amp;\x26amp; fn(fn);\n          }\n      }\n    }\n    };\n    xhr.send();\n}\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3epolling\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n    update();\n}\nsetInterval(polling, \x3cspan class=\x22hljs-number\x22\x3e2000\x3c\/span\x3e);\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 后台响应代码\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e\x26lt;?php\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 利用随机数的大小来模拟是否有新数据\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (rand(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e100\x3c\/span\x3e) \x26lt; \x3cspan class=\x22hljs-number\x22\x3e35\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3eecho\x3c\/span\x3e json_encode(\x3cspan class=\x22hljs-keyword\x22\x3earray\x3c\/span\x3e( \n            \x3cspan class=\x22hljs-string\x22\x3e\x22flag\x22\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e, \n            \x3cspan class=\x22hljs-string\x22\x3e\x22data\x22\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-string\x22\x3e\x27有新数据来了\x27\x3c\/span\x3e\n        ));\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3eecho\x3c\/span\x3e json_encode(\x3cspan class=\x22hljs-keyword\x22\x3earray\x3c\/span\x3e(\n            \x3cspan class=\x22hljs-string\x22\x3e\x22flag\x22\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-keyword\x22\x3efalse\x3c\/span\x3e\n        ));\n    }\n\x3cspan class=\x22hljs-meta\x22\x3e?\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这种定时请求的方式的关键在于间隔时间的选取，依据我在上面代码做的模拟，很少概率能拿到下真正的数据，\x3cstrong\x3e多半的\x3ccode\x3eajax\x3c\/code\x3e请求是无效的\x3c\/strong\x3e，于是又有前辈基于轮询提出来了\x3cstrong\x3eComet（服务器推）\x3c\/strong\x3e，这种技术可以通过\x3cstrong\x3e长轮询（long polling）\x3c\/strong\x3e实现（还可以利用\x3ccode\x3eiframe\x3c\/code\x3e），长轮询也是靠\x3ccode\x3eajax\x3c\/code\x3e实现客户端的请求，其流程为：\x3cstrong\x3e客户端发起请求，服务器挂起请求，假若有新的数据返回，服务器响应客户端刚才的请求，客户端得到响应后继续请求服务器\x3c\/strong\x3e。用伪代码来模拟下长轮询的过程：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 前端利用下面函数进行请求\nfunction longPolling () {\n    update(update);\n}\nlongpolling();\n\/\/ 后端代码做如下更改\n\x3c?php\n    \/\/ 利用随机数的大小来模拟是否有新数据\n    while (true) {\n        if (rand(1, 100) \x3c 5) {\n            echo json_encode(array( \n                \x26quot;flag\x26quot; =\x3e true, \n                \x26quot;data\x26quot; =\x3e \x27有新数据来了\x27\n            ));\n            break;\n        }\n    }\n?\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 前端利用下面函数进行请求\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3elongPolling\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n    update(update);\n}\nlongpolling();\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 后端代码做如下更改\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e\x26lt;?php\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 利用随机数的大小来模拟是否有新数据\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (rand(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e100\x3c\/span\x3e) \x26lt; \x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3eecho\x3c\/span\x3e json_encode(\x3cspan class=\x22hljs-keyword\x22\x3earray\x3c\/span\x3e( \n                \x3cspan class=\x22hljs-string\x22\x3e\x22flag\x22\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e, \n                \x3cspan class=\x22hljs-string\x22\x3e\x22data\x22\x3c\/span\x3e =\x26gt; \x3cspan class=\x22hljs-string\x22\x3e\x27有新数据来了\x27\x3c\/span\x3e\n            ));\n            \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n        }\n    }\n\x3cspan class=\x22hljs-meta\x22\x3e?\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e长轮询的确减少了请求的次数，但是它也有着很大的问题，\x3cstrong\x3e那就是耗费服务器的资源\x3c\/strong\x3e。\x3cbr\x3e无论是轮询还是长轮询，还有着一个问题就是\x3ccode\x3ehttp\x3c\/code\x3e并不是支持长连接很多人会说\x3ccode\x3ekeep-alive\x3c\/code\x3e不就是做到了长连接吗？然而并非如此，\x3ccode\x3ekeep-alive\x3c\/code\x3e是重用一个\x3ccode\x3eTCP\x3c\/code\x3e连接，就是说http 1.1做到了一个\x3ccode\x3eTCP\x3c\/code\x3e连接可以发送多个\x3ccode\x3ehttp\x3c\/code\x3e请求，然而每个\x3ccode\x3ehttp\x3c\/code\x3e请求还需要发送\x3ccode\x3eRequest Header\x3c\/code\x3e，每个请求的响应还会带着\x3ccode\x3eResponse Header\x3c\/code\x3e。对于轮询和长轮询来说伴随着真实数据的交换，还有进行的就是大量的\x3ccode\x3ehttp header\x3c\/code\x3e的交换。\x3cbr\x3e基于这些问题，\x3ccode\x3eWebSocket\x3c\/code\x3e被提出，\x3ccode\x3eWebSocket\x3c\/code\x3e可以理解为对\x3ccode\x3ehttp\x3c\/code\x3e的一个补丁包，\x3ccode\x3eWebSocket\x3c\/code\x3e使\x3ccode\x3ehttp\x3c\/code\x3e变成了一个真正的长连接，握手阶段利用\x3ccode\x3ehttp\x3c\/code\x3e协议，之后就不会再发起\x3ccode\x3ehttp\x3c\/code\x3e请求了。下面来看下\x3ccode\x3eWebSocket\x3c\/code\x3e握手的过程：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVEu4P\x22 src=\x22https:\/\/static.alili.tech\/img\/bVEu4P\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3cbr\x3e客户端的请求头比一般的\x3ccode\x3ehttp\x3c\/code\x3e请求多出来几个字段：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eUpgrade: websocket,Connection: Upgrade\x3c\/code\x3e，利用这两个字段来告诉服务器，我要将协议升级为\x3ccode\x3ewebsocket\x3c\/code\x3e。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eSec-WebSocket-Version: 13\x3c\/code\x3e，来告诉服务器我想要使用的\x3ccode\x3eWebSocket\x3c\/code\x3e的版本。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eSec-WebSocket-Key\x3c\/code\x3e，其值采用base64编码的随机16字节长的字符序列，这个值会在响应头中回应。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eSec-WebSocket-Extensions\x3c\/code\x3e，提供了一个客户端支持的协议扩展列表来供服务器选择，服务器只能选择一个，并且会将选择的扩展写入响应头的\x3ccode\x3eSec-WebSocket-Extensions\x3c\/code\x3e。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eSec-WebSocket-Protocol\x3c\/code\x3e，与\x3ccode\x3eSec-WebSocket-Extensions\x3c\/code\x3e原理相似，用于协商应用子协议。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e再来看看响应头：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eStatus Code\x3c\/code\x3e，值为101，表示已经升级到\x3ccode\x3eWebSocket\x3c\/code\x3e协议\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eSec-WebSocket-Extensions\x3c\/code\x3e告诉客户端服务器选择的协议扩展\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eSec-WebSocket-Protocol\x3c\/code\x3e告诉客户端服务器选择的子协议\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eSec-WebSocket-Accept\x3c\/code\x3e经服务器确认并且加密后的\x3ccode\x3eSec-WebSocket-Key\x3c\/code\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e还有一点值得关注的就是协议头由\x3ccode\x3ehttp\/https\x3c\/code\x3e换成了\x3ccode\x3ews\/wss\x3c\/code\x3e，也标识真\x3ccode\x3ehttp\x3c\/code\x3e完成了其使命，接下来的事情由\x3ccode\x3eWebSocket\x3c\/code\x3e来负责啦！\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3esocket.io\x3c\/h2\x3e\n\x3cp\x3e由于写原生的\x3ccode\x3eWebSocket\x3c\/code\x3e在处理低版本浏览器的兼容性上的困难，所以一般在写实时交互的这种项目时一般会利用到\x3ccode\x3esocket.io\x3c\/code\x3e。\x3ccode\x3esocket.io\x3c\/code\x3e并不仅仅是\x3ccode\x3eWebSocket\x3c\/code\x3e，还包含着\x3ccode\x3eAJAX long polling\x3c\/code\x3e，\x3ccode\x3eAJAX multipart streaming\x3c\/code\x3e，\x3ccode\x3eJSONP Polling\x3c\/code\x3e等。\x3ccode\x3esocket.io\x3c\/code\x3e可以看做是基于\x3ccode\x3eengine.io\x3c\/code\x3e的二次开发。通过\x3ccode\x3eemit\x3c\/code\x3e和\x3ccode\x3eon\x3c\/code\x3e可以轻松地实现服务器与客户端之间的双向通信，\x3ccode\x3eemit\x3c\/code\x3e来发布事件，\x3ccode\x3eon\x3c\/code\x3e来订阅事件。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e用户登录\/登出\x3c\/h2\x3e\n\x3cp\x3e下面开始来写代码，我利用的构建工具是\x3ccode\x3egulp\x3c\/code\x3e，模板语言是\x3ccode\x3ejade\x3c\/code\x3e，css预处理语言是\x3ccode\x3eless\x3c\/code\x3e，假若也需要使用到这些，可以关注下我所在团队搭建的一个小的\x3ca href=\x22https:\/\/github.com\/zp1996\/lsgo-cli\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e脚手架\x3c\/a\x3e，先从\x3ccode\x3eapp.js\x3c\/code\x3e开始：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const users = {}, \n    app = express(),\n    server = require(\x26quot;http\x26quot;).createServer(app),\n    io = require(\x26quot;socket.io\x26quot;).listen(server); \n\/\/ 将socket.io绑定到服务器上，使得任何连接到服务器的客户端都具有实时通信的功能\n\n\/\/ 服务器来监听客户端\nio.on(\x26quot;connection\x26quot;, (socket) =\x3e {\n    \/\/ socket是返回的连接对象,两端的交互就是通过这个对象\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs moonscript\x22\x3e\x3ccode\x3econst users = {}, \n    app = express(),\n    server = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22http\x22\x3c\/span\x3e).createServer(app),\n    \x3cspan class=\x22hljs-built_in\x22\x3eio\x3c\/span\x3e = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22socket.io\x22\x3c\/span\x3e).listen(server); \n\/\/ 将socket.\x3cspan class=\x22hljs-built_in\x22\x3eio\x3c\/span\x3e绑定到服务器上，使得任何连接到服务器的客户端都具有实时通信的功能\n\n\/\/ 服务器来监听客户端\n\x3cspan class=\x22hljs-built_in\x22\x3eio\x3c\/span\x3e.on(\x3cspan class=\x22hljs-string\x22\x3e\x22connection\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e(socket)\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \/\/ socket是返回的连接对象,两端的交互就是通过这个对象\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e需要创建一个对象（\x3ccode\x3eusers\x3c\/code\x3e）来存储在线用户，键值为用户昵称，为用户登录来订阅个事件：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22socket.on(\x26quot;login\x26quot;, (nickname) =\x3e {\n        if (users[nickname] || nickname === \x26quot;system\x26quot;) {\n            socket.emit(\x26quot;repeat\x26quot;);            \n        } else {\n            socket.nickname = nickname;\n            users[nickname] = {\n                name: nickname,\n                socket: socket,\n                lastSpeakTime: nowSecond()\n            };\n            socket.emit(\x26quot;loginSuccess\x26quot;);            \n            UsersChange(nickname, true);\n        }\n});\nsocket.on(\x26quot;disconnect\x26quot;, () =\x3e {\n    if (socket.nickname \x26amp;\x26amp; users[socket.nickname]) {\n        delete users[socket.nickname];\n        UsersChange(socket.nickname, false);\n    }\n});\nfunction UsersChange (nickname, flag) {\n    io.sockets.emit(\x26quot;system\x26quot;, {\n        nickname: nickname,\n        size: Object.keys(users).length,\n        flag: flag\n    });\n}\nfunction nowSecond () {\n    return Math.floor(new Date() \/ 1000);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs typescript\x22\x3e\x3ccode\x3esocket.on(\x3cspan class=\x22hljs-string\x22\x3e\x22login\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3enickname\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (users[nickname] || nickname === \x3cspan class=\x22hljs-string\x22\x3e\x22system\x22\x3c\/span\x3e) {\n            socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x22repeat\x22\x3c\/span\x3e);            \n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            socket.nickname = nickname;\n            users[nickname] = {\n                name: nickname,\n                socket: socket,\n                lastSpeakTime: nowSecond()\n            };\n            socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x22loginSuccess\x22\x3c\/span\x3e);            \n            UsersChange(nickname, \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e);\n        }\n});\nsocket.on(\x3cspan class=\x22hljs-string\x22\x3e\x22disconnect\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (socket.nickname \x26amp;\x26amp; users[socket.nickname]) {\n        \x3cspan class=\x22hljs-keyword\x22\x3edelete\x3c\/span\x3e users[socket.nickname];\n        UsersChange(socket.nickname, \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e);\n    }\n});\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eUsersChange\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3enickname, flag\x3c\/span\x3e) \x3c\/span\x3e{\n    io.sockets.emit(\x3cspan class=\x22hljs-string\x22\x3e\x22system\x22\x3c\/span\x3e, {\n        nickname: nickname,\n        size: \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.keys(users).length,\n        flag: flag\n    });\n}\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3enowSecond\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.floor(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e() \/ \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e用户登录时需要验证其昵称是否含有，假若函数，则触发在客户端的\x3ccode\x3ejs\x3c\/code\x3e代码中注册的\x3ccode\x3erepeat\x3c\/code\x3e事件，反之触发\x3ccode\x3eloginSuccess\x3c\/code\x3e事件并且登录成功后需要向所有的客户端来广播，所以利用了\x3ccode\x3eio.sockets.emit\x3c\/code\x3e。\x3ccode\x3erepeat\x3c\/code\x3e，\x3ccode\x3eloginSuccess\x3c\/code\x3e，\x3ccode\x3esystem\x3c\/code\x3e，在src\/js\/index.js中进行注册，主要用于页面的显示，也就是一些dom操作，所以在这里没有什么好讲的。用户退出，直接调用默认事件\x3ccode\x3edisconnect\x3c\/code\x3e就好，并将该用户从用户对象中移除。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e心跳检测\x3c\/h2\x3e\n\x3cp\x3e在用户的状态上的坑还是不少的，因为\x3ccode\x3eWebSocket\x3c\/code\x3e中间过程比较复杂，经常会出现一些异常的情况，所以需要进行\x3cstrong\x3e心跳检测\x3c\/strong\x3e，我采用的方式是服务端定时遍历用户列表，假若用户最后的发言时间与现在相比超过了5分钟，就将其视为掉线，从而避免了\x22用户undefined退出群聊\x22的这种情况。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function pong () {\n    const now = nowSecond();\n    for (let k in users) {\n        if (users[k].lastSpeakTime \x2b MAX_LEAVE_TIME \x3c now) {\n            var socket = users[k].socket;\n            users[k].socket.emit(\x26quot;disconnect\x26quot;);\n            socket.emit(\x26quot;nouser\x26quot;, \x26quot;由于长时间未说话，您已经掉线，请重新刷新页面\x26quot;);\n            socket = null;\n        } \n    }\n}\n\/\/ 心跳检测\nsetInterval(pong, PONG_TIME);\nfunction UsersChange (nickname, flag) {\n    io.sockets.emit(\x26quot;system\x26quot;, {\n        nickname: nickname,\n        size: Object.keys(users).length,\n        flag: flag\n    });\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3epong\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e now = nowSecond();\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e k \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e users) {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (users[k].lastSpeakTime \x2b MAX_LEAVE_TIME \x26lt; now) {\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e socket = users[k].socket;\n            users[k].socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x22disconnect\x22\x3c\/span\x3e);\n            socket.emit(\x3cspan class=\x22hljs-string\x22\x3e\x22nouser\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22由于长时间未说话，您已经掉线，请重新刷新页面\x22\x3c\/span\x3e);\n            socket = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n        } \n    }\n}\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 心跳检测\x3c\/span\x3e\nsetInterval(pong, PONG_TIME);\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eUsersChange\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3enickname, flag\x3c\/span\x3e) \x3c\/span\x3e{\n    io.sockets.emit(\x3cspan class=\x22hljs-string\x22\x3e\x22system\x22\x3c\/span\x3e, {\n        \x3cspan class=\x22hljs-attr\x22\x3enickname\x3c\/span\x3e: nickname,\n        \x3cspan class=\x22hljs-attr\x22\x3esize\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.keys(users).length,\n        \x3cspan class=\x22hljs-attr\x22\x3eflag\x3c\/span\x3e: flag\n    });\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e写在最后\x3c\/h2\x3e\n\x3cp\x3e其实\x3ccode\x3esocket.io\x3c\/code\x3e的使用真的非常简单，很容易就会上手，所以其余功能不再一一演示，大家可以看代码的实现（写的比较差，还请见谅），客户端代码中大量用到了\x3ccode\x3eL\x3c\/code\x3e，相当于\x3ccode\x3ezepto\x3c\/code\x3e的\x3ccode\x3e$\x3c\/code\x3e，特别需要处理的是在私信和发送图片的处理上，私信需要处理不同消息框，到底把消息添加到那个消息框中，我利用了一个对象来存储这些信息（\x3ccode\x3ecache\x3c\/code\x3e），\x3ccode\x3ecache\x3c\/code\x3e的键名为用户的昵称（因为在注册时判断了其是否唯一，所以可以将其视为唯一的）；键值为对象，对象属性如下图所示：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVEvfG\x22 src=\x22https:\/\/static.alili.tech\/img\/bVEvfG\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3cbr\x3e具体实现大家还是到源码中去看吧！\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e感谢\x3ca href=\x22https:\/\/github.com\/wayou\/HiChat\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e王哇勇大神的HiChat\x3c\/a\x3e和\x3ca href=\x22https:\/\/github.com\/barretlee\/blogChat\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e小胡子哥的blogChat\x3c\/a\x3e\x3c\/strong\x3e\x3cbr\x3e\x3cstrong\x3e由于本人水平有限，如有错误，欢迎大家指出！\x3c\/strong\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>利用express+socket.io实现一个简易版聊天室</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000007230919">https://segmentfault.com/a/1190000007230919</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/7aq5zsq5evu/" target="_blank">https://alili.tech/archive/7aq5zsq5evu/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/sj57jxyoook/">ES6 &#43; Webpack &#43; React &#43; Babel 如何在低版本浏览器上愉快的玩耍（上）<aside class="dates">2019-02-03</aside></a></li><li><a href="/archive/qsw902j95k/">ES6 &#43; Webpack &#43; React &#43; Babel 如何在低版本浏览器上愉快的玩耍（下）<aside class="dates">2019-02-03</aside></a></li><li><a href="/archive/nnpmjlot58j/">IndexedDB使用与出坑指南<aside class="dates">2019-02-03</aside></a></li><li><a href="/archive/alvlbas9oai/">JS事件模型<aside class="dates">2019-02-03</aside></a></li><li><a href="/archive/u0pzym8k36o/">JS练习实例--编写经典小游戏俄罗斯方块<aside class="dates">2019-02-03</aside></a></li><li><a href="/archive/khwpyk5yz8q/">JavaScript 事件代理和委托<aside class="dates">2019-02-03</aside></a></li><li><a href="/archive/kuocl6lc3n/">JavaScript 版俄罗斯方块<aside class="dates">2019-02-03</aside></a></li><li><a href="/archive/n8bk54lyrf/">Promise学习:基础入门<aside class="dates">2019-02-03</aside></a></li><li><a href="/archive/7bk7u30qncb/">Redux 入坑进阶 - 源码解析<aside class="dates">2019-02-03</aside></a></li><li><a href="/archive/853kqfmqmf7/">Snap.svg 基本知识入门<aside class="dates">2019-02-03</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>