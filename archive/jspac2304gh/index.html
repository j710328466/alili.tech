<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="什么是浏览器的事件循环（Event Loop）？"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>什么是浏览器的事件循环（Event Loop）？ | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/jspac2304gh/",
				"appid": "1613049289050283", 
				"title": "什么是浏览器的事件循环（Event Loop）？ | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-05T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/1w5m6w4a8yx/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/91c32yq3d4o/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f&text=%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%ef%bc%88Event%20Loop%ef%bc%89%ef%bc%9f"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f&text=%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%ef%bc%88Event%20Loop%ef%bc%89%ef%bc%9f"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f&title=%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%ef%bc%88Event%20Loop%ef%bc%89%ef%bc%9f"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f&is_video=false&description=%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%ef%bc%88Event%20Loop%ef%bc%89%ef%bc%9f"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%ef%bc%88Event%20Loop%ef%bc%89%ef%bc%9f&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f&title=%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%ef%bc%88Event%20Loop%ef%bc%89%ef%bc%9f"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f&title=%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%ef%bc%88Event%20Loop%ef%bc%89%ef%bc%9f"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f&title=%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%ef%bc%88Event%20Loop%ef%bc%89%ef%bc%9f"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fjspac2304gh%2f&title=%e4%bb%80%e4%b9%88%e6%98%af%e6%b5%8f%e8%a7%88%e5%99%a8%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af%ef%bc%88Event%20Loop%ef%bc%89%ef%bc%9f"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">什么是浏览器的事件循环（Event Loop）？</h1><div class="meta"><div class="postdate"><time datetime="2019-01-05" itemprop="datePublished">2019-01-05</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cblockquote\x3e本文围绕浏览器的事件循环，而node.js有自己的另一套事件循环机制，不在本文讨论范围。网上的许多相关技术文章提到了\x3ccode\x3eprocess.nextTick\x3c\/code\x3e和\x3ccode\x3esetImmediate\x3c\/code\x3e两个node.js的API，这里不予讨论。\x3c\/blockquote\x3e\n\x3chr\x3e\n\x3cp\x3e先看\x3ca href=\x22https:\/\/html.spec.whatwg.org\/multipage\/webappapis.html#event-loops\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eHTML标准\x3c\/a\x3e的一系列解释：\x3c\/p\x3e\n\x3cblockquote\x3e为了协调\x3ccode\x3e事件\x3c\/code\x3e（event），\x3ccode\x3e用户交互\x3c\/code\x3e（user interaction），\x3ccode\x3e脚本\x3c\/code\x3e（script），\x3ccode\x3e渲染\x3c\/code\x3e（rendering），\x3ccode\x3e网络\x3c\/code\x3e（networking）等，用户代理（user agent）必须使用\x3ccode\x3e事件循环\x3c\/code\x3e（event loops）。\x3cp\x3e有两类事件循环：一种针对\x3ccode\x3e浏览上下文\x3c\/code\x3e（browsing context），还有一种针对\x3ccode\x3eworker\x3c\/code\x3e（web worker）。\x3c\/p\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e现在我们知道了浏览器运行时有一个叫\x3cstrong\x3e事件循环\x3c\/strong\x3e的机制。\x3c\/p\x3e\n\x3cblockquote\x3e一个事件循环有一个或者多个\x3ccode\x3e任务队列\x3c\/code\x3e（task queues）。任务队列是task的有序列表，这些task是以下工作的对应算法：Events，Parsing，Callbacks，Using a resource，Reacting to DOM manipulation。\x3cp\x3e每一个任务都来自一个特定的\x3ccode\x3e任务源\x3c\/code\x3e（task source）。所有来自一个特定任务源并且属于特定事件循环的任务，通常必须被加入到同一个任务队列中，但是来自不同任务源的任务可能会放在不同的任务队列中。\x3c\/p\x3e\n\x3cp\x3e举个例子，用户代理有一个处理鼠标和键盘事件的任务队列。用户代理可以给这个队列比其他队列多3\/4的执行时间，以确保交互的响应而不让其他任务队列饿死（starving），并且不会乱序处理任何一个任务队列的事件。\x3c\/p\x3e\n\x3cp\x3e每个事件循环都有一个进入\x3ccode\x3emicrotask\x3c\/code\x3e检查点（performing a microtask checkpoint）的flag标志，这个标志初始为false。它被用来组织反复调用‘进入microtask检查点’的算法。\x3c\/p\x3e\n\x3c\/blockquote\x3e\n\x3cp\x3e总结一下，一个事件循环里有很多个任务队列（task queues）来自不同任务源，每一个任务队列里的任务是严格按照先进先出的顺序执行的，但是不同任务队列的任务的执行顺序是不确定的。按我的理解就是，浏览器会自己\x3cstrong\x3e调度\x3c\/strong\x3e不同任务队列。网上很多文章会提到\x3ccode\x3emacrotask\x3c\/code\x3e这个概念，其实就是指代了标准里阐述的\x3ccode\x3etask\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e标准同时还提到了\x3ccode\x3emicrotask\x3c\/code\x3e的概念，也就是微任务。看一下标准阐述的事件循环的进程模型：\x3c\/p\x3e\n\x3cblockquote\x3e\x3col\x3e\n\x3cli\x3e选择当前要执行的任务队列，选择一个最先进入任务队列的任务，如果没有任务可以选择，则会跳转至microtask的执行步骤。\x3c\/li\x3e\n\x3cli\x3e将事件循环的当前运行任务设置为已选择的任务。\x3c\/li\x3e\n\x3cli\x3e运行任务。\x3c\/li\x3e\n\x3cli\x3e将事件循环的当前运行任务设置为null。\x3c\/li\x3e\n\x3cli\x3e将运行完的任务从任务队列中移除。\x3c\/li\x3e\n\x3cli\x3emicrotasks步骤：进入microtask检查点（performing a microtask checkpoint ）。\x3c\/li\x3e\n\x3cli\x3e更新界面渲染。\x3c\/li\x3e\n\x3cli\x3e返回第一步。\x3c\/li\x3e\n\x3c\/ol\x3e\x3c\/blockquote\x3e\n\x3cp\x3e执行进入microtask检查点时，用户代理会执行以下步骤：\x3c\/p\x3e\n\x3cblockquote\x3e\x3col\x3e\n\x3cli\x3e设置进入microtask检查点的标志为true。\x3c\/li\x3e\n\x3cli\x3e当事件循环的微任务队列不为空时：选择一个最先进入microtask队列的microtask；设置事件循环的当前运行任务为已选择的microtask；运行microtask；设置事件循环的当前运行任务为null；将运行结束的microtask从microtask队列中移除。\x3c\/li\x3e\n\x3cli\x3e对于相应事件循环的每个环境设置对象（environment settings object）,通知它们哪些promise为rejected。\x3c\/li\x3e\n\x3cli\x3e清理indexedDB的事务。\x3c\/li\x3e\n\x3cli\x3e设置进入microtask检查点的标志为false。\x3c\/li\x3e\n\x3c\/ol\x3e\x3c\/blockquote\x3e\n\x3cp\x3e\x3cstrong\x3e现在我们知道了。在事件循环中，用户代理会不断从task队列中按顺序取task执行，每执行完一个task都会检查microtask队列是否为空（执行完一个task的具体标志是函数执行栈为空），如果不为空则会一次性执行完所有microtask。然后再进入下一个循环去task队列中取下一个task执行...\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e那么哪些行为属于task或者microtask呢？标准没有阐述，但各种技术文章总结都如下：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3ccode\x3emacrotasks\x3c\/code\x3e: script(整体代码), setTimeout, setInterval, setImmediate, I\/O, UI rendering\x3c\/li\x3e\n\x3cli\x3e\n\x3ccode\x3emicrotasks\x3c\/code\x3e: process.nextTick, Promises, Object.observe(废弃), MutationObserver\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e来看一个例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22console.log(\x27script start\x27);\n\nsetTimeout(function() {\n  console.log(\x27setTimeout\x27);\n}, 0);\n\nPromise.resolve().then(function() {\n  console.log(\x27promise1\x27);\n}).then(function() {\n  console.log(\x27promise2\x27);\n});\n\nconsole.log(\x27script end\x27);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27script start\x27\x3c\/span\x3e);\n\nsetTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27setTimeout\x27\x3c\/span\x3e);\n}, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve().then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27promise1\x27\x3c\/span\x3e);\n}).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27promise2\x27\x3c\/span\x3e);\n});\n\n\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27script end\x27\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e（代码来自\x3ca href=\x22https:\/\/jakearchibald.com\/2015\/tasks-microtasks-queues-and-schedules\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eTasks, microtasks, queues and schedules\x3c\/a\x3e，\x3cstrong\x3e推荐观看原文的代码可视化执行步骤\x3c\/strong\x3e）\x3c\/p\x3e\n\x3cp\x3e如果你测试的浏览器支持的Promise不支持Promise\/A\x2b标准，或是你使用了其他Promise polyfill，运行结果可能有差异。\x3c\/p\x3e\n\x3cp\x3e运行结果是：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22script start\nscript end\npromise1\npromise2\nsetTimeout\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs applescript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3escript\x3c\/span\x3e start\n\x3cspan class=\x22hljs-keyword\x22\x3escript\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eend\x3c\/span\x3e\npromise1\npromise2\nsetTimeout\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e解释一下过程。\x3c\/p\x3e\n\x3col\x3e\x3cli\x3e一开始task队列中只有script，则script中所有函数放入函数执行栈执行，代码按顺序执行。\x3c\/li\x3e\x3c\/ol\x3e\n\x3cp\x3e接着遇到了\x3ccode\x3esetTimeout\x3c\/code\x3e,\x3cstrong\x3e它的作用是0ms后将回调函数放入task队列中\x3c\/strong\x3e，也就是说这个函数将在下一个事件循环中执行（注意这时候setTimeout执行完毕就返回了）。\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e接着遇到了\x3ccode\x3ePromise\x3c\/code\x3e，按照前面所述Promise属于microtask，所以第一个.then()会放入microtask队列。\x3c\/li\x3e\n\x3cli\x3e当所有script代码执行完毕后，\x3cstrong\x3e此时函数执行栈为空\x3c\/strong\x3e。开始检查microtask队列，此时队列不为空,执行.then()的回调函数输出\x27promise1\x27，由于.then()返回的依然是promise,所以第二个.then()会放入microtask队列继续执行,输出\x27promise2\x27。\x3c\/li\x3e\n\x3cli\x3e此时microtask队列为空了，进入下一个事件循环，检查task队列发现了setTimeout的回调函数，立即执行回调函数输出\x27setTimeout\x27，代码执行完毕。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e继续看一个更有趣的例子：\x3c\/p\x3e\n\x3cp\x3eHTML代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cdiv class=\x26quot;outer\x26quot;\x3e\n  \x3cdiv class=\x26quot;inner\x26quot;\x3e\x3c\/div\x3e\n\x3c\/div\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22HTML\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22outer\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n  \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22inner\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eJavaScript代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ Let\x27s get hold of those elements\nvar outer = document.querySelector(\x27.outer\x27);\nvar inner = document.querySelector(\x27.inner\x27);\n\n\/\/ Let\x27s listen for attribute changes on the\n\/\/ outer element\nnew MutationObserver(function() {\n  console.log(\x27mutate\x27);\n}).observe(outer, {\n  attributes: true\n});\n\n\/\/ Here\x27s a click listener…\nfunction onClick() {\n  console.log(\x27click\x27);\n\n  setTimeout(function() {\n    console.log(\x27timeout\x27);\n  }, 0);\n\n  Promise.resolve().then(function() {\n    console.log(\x27promise\x27);\n  });\n\n  outer.setAttribute(\x27data-random\x27, Math.random());\n}\n\n\/\/ …which we\x27ll attach to both elements\ninner.addEventListener(\x27click\x27, onClick);\nouter.addEventListener(\x27click\x27, onClick);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Let\x27s get hold of those elements\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e outer = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.querySelector(\x3cspan class=\x22hljs-string\x22\x3e\x27.outer\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e inner = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.querySelector(\x3cspan class=\x22hljs-string\x22\x3e\x27.inner\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Let\x27s listen for attribute changes on the\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ outer element\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e MutationObserver(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27mutate\x27\x3c\/span\x3e);\n}).observe(outer, {\n  \x3cspan class=\x22hljs-attr\x22\x3eattributes\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n});\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ Here\x27s a click listener…\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonClick\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e);\n\n  setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27timeout\x27\x3c\/span\x3e);\n  }, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n\n  \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve().then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27promise\x27\x3c\/span\x3e);\n  });\n\n  outer.setAttribute(\x3cspan class=\x22hljs-string\x22\x3e\x27data-random\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.random());\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ …which we\x27ll attach to both elements\x3c\/span\x3e\ninner.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e, onClick);\nouter.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27click\x27\x3c\/span\x3e, onClick);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e（代码来自\x3ca href=\x22https:\/\/jakearchibald.com\/2015\/tasks-microtasks-queues-and-schedules\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eTasks, microtasks, queues and schedules\x3c\/a\x3e，\x3cstrong\x3e推荐观看原文的代码可视化执行步骤\x3c\/strong\x3e）\x3cbr\x3e点击内框后，结果如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22click\npromise\nmutate\nclick\npromise\nmutate\ntimeout\ntimeout\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs applescript\x22\x3e\x3ccode\x3eclick\npromise\nmutate\nclick\npromise\nmutate\n\x3cspan class=\x22hljs-keyword\x22\x3etimeout\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3etimeout\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e解释一下过程：\x3cbr\x3e点击inner输出\x27click\x27，Promise和设置outer属性会依次把Promise和MutationObserver推入microtask队列，setTimeout则会推入task队列。此时执行栈为空，虽然后面还有冒泡触发，但是此时microtask队列会先执行，所以依次输入\x27promise\x27和\x27mutate\x27。接下来事件冒泡再次触发事件，过程和开始一样。接着代码执行完毕，此时进入下一次事件循环，执行task队列中的任务，输出两个\x27timeout\x27。\x3c\/p\x3e\n\x3cp\x3e好了，如果你理解了这个，那么现在换一下事件触发的方式。在上面的代码后面加上\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22inner.click()\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs arduino\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3einner.\x3cspan class=\x22hljs-built_in\x22\x3eclick\x3c\/span\x3e()\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e思考看看会有什么不同。\x3c\/p\x3e\n\x3cp\x3e运行结果：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22click\nclick\npromise\nmutate\npromise\ntimeout\ntimeout\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs applescript\x22\x3e\x3ccode\x3eclick\nclick\npromise\nmutate\npromise\n\x3cspan class=\x22hljs-keyword\x22\x3etimeout\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3etimeout\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e造成这个差异的结果是什么呢？因为第一次执行完第一个click事件后函数执行栈并不为空。\x3cbr\x3e具体代码运行解释，可以查看\x3ca href=\x22https:\/\/jakearchibald.com\/2015\/tasks-microtasks-queues-and-schedules\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eTasks, microtasks, queues and schedules\x3c\/a\x3e。\x3c\/p\x3e\n\x3cp\x3e本文参考：\x3cbr\x3e\x3ca href=\x22https:\/\/html.spec.whatwg.org\/multipage\/webappapis.html#event-loops\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehtml.spec.whatwg.org\x3c\/a\x3e\x3cbr\x3e\x3ca href=\x22https:\/\/blog.keifergu.me\/2017\/03\/23\/difference-between-javascript-macrotask-and-microtask\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3edifference-between-javascript-macrotask-and-microtask\x3c\/a\x3e\x3cbr\x3e\x3ca href=\x22http:\/\/www.jianshu.com\/p\/1ee6c21f6efa\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eEvent loop\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e墙裂建议大家阅读HTML标准里阐述的Event Loop，欢迎指正和建议。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>什么是浏览器的事件循环（Event Loop）？</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010622146">https://segmentfault.com/a/1190000010622146</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/jspac2304gh/" target="_blank">https://alili.tech/archive/jspac2304gh/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/t42iv2yle7e/">2016-我的前端之路:工具化与工程化<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/xlhryjzdso/">2016年总结--成长<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/4wvjfeus9ur/">2016年末总结，我的前端之路<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/w7062tmcw3/">3D 视差效果<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/5jt1iw1t77b/">AlloyTouch实战--60行代码搞定QQ看点资料卡<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/kquf0fxkw2j/">ES6，你不得不学！<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/r5b6g4133jh/">Emmet-前端开发神器<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/5dbaikv4emi/">FreeCodeCamp中级算法题答案<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/iuyeljg6lm/">JSONP是什么<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/23ftsgrtzzc/">JS中的观察者模式(发布订阅)<aside class="dates">2019-01-29</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>