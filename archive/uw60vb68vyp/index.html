<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="promise/deferred 模式原理分析和实现"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>promise/deferred 模式原理分析和实现 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/uw60vb68vyp/",
				"appid": "1613049289050283", 
				"title": "promise/deferred 模式原理分析和实现 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-08T02:30:11"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/g4pfny6qfml/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/gthlt69kful/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f&text=promise%2fdeferred%20%e6%a8%a1%e5%bc%8f%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9e%e7%8e%b0"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f&text=promise%2fdeferred%20%e6%a8%a1%e5%bc%8f%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9e%e7%8e%b0"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f&title=promise%2fdeferred%20%e6%a8%a1%e5%bc%8f%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9e%e7%8e%b0"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f&is_video=false&description=promise%2fdeferred%20%e6%a8%a1%e5%bc%8f%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9e%e7%8e%b0"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=promise%2fdeferred%20%e6%a8%a1%e5%bc%8f%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9e%e7%8e%b0&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f&title=promise%2fdeferred%20%e6%a8%a1%e5%bc%8f%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9e%e7%8e%b0"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f&title=promise%2fdeferred%20%e6%a8%a1%e5%bc%8f%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9e%e7%8e%b0"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f&title=promise%2fdeferred%20%e6%a8%a1%e5%bc%8f%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9e%e7%8e%b0"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fuw60vb68vyp%2f&title=promise%2fdeferred%20%e6%a8%a1%e5%bc%8f%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90%e5%92%8c%e5%ae%9e%e7%8e%b0"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">promise/deferred 模式原理分析和实现</h1><div class="meta"><div class="postdate"><time datetime="2019-01-08" itemprop="datePublished">2019-01-08</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e一、什么是promise\/deferred 模式\x3c\/h2\x3e\n\x3cp\x3epromise\/deferred 模式是，根据promise\/A 或者它的增强修改版promise\/A\x2b 规范 实现的promise异步操作的一种实现方式。\x3c\/p\x3e\n\x3cp\x3e异步的广度使用使得回调，嵌套出现，但是一但出现深度的嵌套，就会让coding的体验变得相当不愉快，而且代码后期的维护也是相当吃力的。promise\/deferred模式的出现，会在一定程度上缓解这个问题。接下来我会根据promise\/a 规范来介绍promise\/deferred模式。\x3cbr\x3e（题外话：什么是规范,规范其实就相当于制定的规则，但却没有在代码层面上有默认的具体实现）\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e二、promise\/a\x3c\/h2\x3e\n\x3cp\x3epromise\/a 提议对单个异步操作作出了这样的抽象定义：\x3cbr\x3e1.promise操作只会在以下3种状态中的一种：等待态（Pending）、执行态（Fulfilled）和拒绝态（Rejected）。\x3cbr\x3e2.promise的状态只会出现从等待状态向执行态或者拒绝态转化，不可以逆转。执行态和拒绝态之间不能相互转换\x3cbr\x3e3.promise状态一旦被转换，就不能被更改。\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVQPjL?w=352\x26amp;h=335\x22 src=\x22https:\/\/static.alili.tech\/img\/bVQPjL?w=352\x26amp;h=335\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e4.在api上，规范定义比较简单，只要求promise 必修提供有一个then方法，以访问当前值、最终值和拒绝原因\x3cbr\x3ethen方法接受两个参数\x3cbr\x3epromise.then(onFulfilled,onRejected)\x3cbr\x3e5.then方法的onFulfilled,onRejected 方法都是可选参数，且不是function，都被忽略\x3cbr\x3e6.then()方法返回promise对象，以实现链式写法。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e三、promise\/deferred模式\x3c\/h2\x3e\n\x3cp\x3epromise\/deferred 模式 其实包含两部分：Promise 和 Deferred。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eDeferred主要是用于内部，来维护异步模型的状态。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3ePromise只要用于外部，通过then()方法，暴露给外部调用，以添加业务逻辑和业务的组装。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3epromise 和 deferred的关系图\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVQPkk?w=1083\x26amp;h=423\x22 src=\x22https:\/\/static.alili.tech\/img\/bVQPkk?w=1083\x26amp;h=423\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e从图中可以看到：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22 1.deferred对象通过resolve方法，改变自身状态为执行态，并触发then()方法的onfulfilled回调函数\n 2.deferred对象通过reject方法，改变自身状态为拒绝态，并触发then()方法的onrejected回调函数\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs fortran\x22\x3e\x3ccode\x3e \x3cspan class=\x22hljs-number\x22\x3e1.\x3c\/span\x3e\x3cspan class=\x22hljs-keyword\x22\x3edeferred\x3c\/span\x3e对象通过resolve方法，改变自身状态为执行态，并触发\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e()方法的onfulfilled回调函数\n \x3cspan class=\x22hljs-number\x22\x3e2.\x3c\/span\x3e\x3cspan class=\x22hljs-keyword\x22\x3edeferred\x3c\/span\x3e对象通过reject方法，改变自身状态为拒绝态，并触发\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e()方法的onrejected回调函数\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e下面 我们就用代码来实现一下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/**\n * Promise 类\n * @constructor\n *\/\nfunction Promise() {\n    this.handler = {};\n}\n\n\/**\n * promise 对象的then方法\n * @param onFulfilled  当 promise 执行结束后其必须被调用，其第一个参数为 promise 的终值，其调用次数不可超过一次\n * @param onRejected   当 promise 被拒绝执行后其必须被调用，其第一个参数为 promise 的据因，其调用次数不可超过一次\n * @returns {Promise}  规范定义必修返回 primise对象\n *\/\nPromise.prototype.then = function (onFulfilled, onRejected) {\n    var handler = {}\n    if (typeof onFulfilled === \x27function\x27) {\n        handler.resolve = onFulfilled\n    }\n    if (typeof onRejected === \x27function\x27) {\n        handler.reject = onRejected\n    }\n    this.handler = handler\n    return this\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * Promise 类\n * @constructor\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handler = {};\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * promise 对象的then方法\n * @param onFulfilled  当 promise 执行结束后其必须被调用，其第一个参数为 promise 的终值，其调用次数不可超过一次\n * @param onRejected   当 promise 被拒绝执行后其必须被调用，其第一个参数为 promise 的据因，其调用次数不可超过一次\n * @returns {Promise}  规范定义必修返回 primise对象\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.prototype.then = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eonFulfilled, onRejected\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e handler = {}\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e onFulfilled === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        handler.resolve = onFulfilled\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e onRejected === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        handler.reject = onRejected\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handler = handler\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里可以看到then方法所做的事情就是讲回调函数存放起来，为了完成整个流程，还需要触发执行这些回调函数的地方，而实现这些功能的对象就叫做deferred(延迟对象)。示范代码如下\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function Deferred() {\n\n    \/* 状态：默认 等待态 pending *\/\n    this.state = \x27pending\x27;\n\n    this.promise = new Promise()\n}\n\nDeferred.prototype.resolve = function (obj) {\n    this.state = \x27fulfilled\x27\n    var handler = this.promise.handler\n    if (handler \x26amp;\x26amp; handler.resolve) {\n        handler.resolve(obj)\n    }\n}\n\nDeferred.prototype.reject = function (obj) {\n    this.state = \x27rejected\x27\n    var handler = this.promise.handler\n    if (handler \x26amp;\x26amp; handler.reject) {\n        handler.reject(obj)\n    }\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eDeferred\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/* 状态：默认 等待态 pending *\/\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state = \x3cspan class=\x22hljs-string\x22\x3e\x27pending\x27\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.promise = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e()\n}\n\nDeferred.prototype.resolve = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eobj\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state = \x3cspan class=\x22hljs-string\x22\x3e\x27fulfilled\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e handler = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.promise.handler\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (handler \x26amp;\x26amp; handler.resolve) {\n        handler.resolve(obj)\n    }\n}\n\nDeferred.prototype.reject = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eobj\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state = \x3cspan class=\x22hljs-string\x22\x3e\x27rejected\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e handler = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.promise.handler\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (handler \x26amp;\x26amp; handler.reject) {\n        handler.reject(obj)\n    }\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e以上已经定义好了Promies 和Deferred ,那我们怎么对一个异步操作函数进行封装呢？\x3cbr\x3e假如我们有这样的异步函数\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function asyncDoSomeing(flag, message) {\n    setTimeout(function () {\n        if (flag) {\n            return message\n        }\n    }, 3000)\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3easyncDoSomeing\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(flag, message)\x3c\/span\x3e \x3c\/span\x3e{\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (flag) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e message\n        }\n    }, \x3cspan class=\x22hljs-number\x22\x3e3000\x3c\/span\x3e)\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e对其封装的代码就是\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function asyncDoSomeing(flag, message) {\n    var deferred = new Deferred()\n    setTimeout(function () {\n        if (flag) {\n            deferred.resolve(message)\n        } else {\n            deferred.reject({code: 400, message: \x27拒绝\x27})\n        }\n    }, 3000)\n    return deferred.promise\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3easyncDoSomeing\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(flag, message)\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e deferred = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Deferred()\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (flag) {\n            deferred.resolve(message)\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            deferred.reject({code: \x3cspan class=\x22hljs-number\x22\x3e400\x3c\/span\x3e, message: \x3cspan class=\x22hljs-string\x22\x3e\x27拒绝\x27\x3c\/span\x3e})\n        }\n    }, \x3cspan class=\x22hljs-number\x22\x3e3000\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e deferred.promise\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e最后我们就可以这么使用了\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22asyncDoSomeing(true, \x27测试执行成功\x27).then(function (message) {\n    console.log(message)\n}, function (err) {\n    console.log(err)\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3easyncDoSomeing(\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27测试执行成功\x27\x3c\/span\x3e).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3emessage\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(message)\n}, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err)\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e到这里只是单个promise对象的简单异步的操作控制，但是有熟悉node.js 和angular.js 的同学就会发现，这个写法跟node.js 里面的一个异步控制流程 q 模块（\x3ca href=\x22https:\/\/github.com\/kriskowal\/q\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/kriskowal\/q\x3c\/a\x3e ）写法是一样的。是的哦 它就是promise\/deferred 模式。随便提一下 Angularjs的$q对象是q的精简版。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e四、链式调用\x3c\/h2\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22 做到以上的简单实现，理想的coding方式，应该前一个调用结果作为下一个调用的输入，这就是链式调用。\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs\x22\x3e\x3ccode\x3e 做到以上的简单实现，理想的coding方式，应该前一个调用结果作为下一个调用的输入，这就是链式调用。\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e为了避免回调地狱，可以借鉴jquery的链式写法。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22$(\x27#tab\x27).eq($(this).index()).show().siblings().hide();\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs perl\x22\x3e\x3ccode\x3e$(\x3cspan class=\x22hljs-string\x22\x3e\x27#tab\x27\x3c\/span\x3e).e\x3cspan class=\x22hljs-string\x22\x3eq($(this)\x3c\/span\x3e.index()).show().siblings().hide();\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e链式写法的核心在于，每个方法都返回 自身 this。\x3c\/p\x3e\n\x3cp\x3e我们现在需要实现promise的链式调用，前一个调用结果作为下一个调用的输入\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22 step1.then(step2).then(step3)\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs smali\x22\x3e\x3ccode\x3e step1.then(step2).then(step3)\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e现在我们实现的then方法确实是返回this的，也就是promise本身，是可以实现链式的。\x3cbr\x3e但是前一个调用的结果却做不到是下一个调用的输入\x3cbr\x3e下面来改造一下上面的代码，让他实现这个要求。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function Promise() {\n    this.handlerQueue = [];\n    this.isPromise = true\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ePromise\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handlerQueue = [];\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.isPromise = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e1.将原本的handler对象改为 一个数组，存放所有then方法的回调。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Promise.prototype.then = function (onFulfilled, onRejected) {\n    var handler = {}\n    if (typeof onFulfilled === \x27function\x27) {\n        handler.resolve = onFulfilled\n    }\n    if (typeof onRejected === \x27function\x27) {\n        handler.reject = onRejected\n    }\n    this.handlerQueue.push(handler)\n\n    return this\n}\n\nfunction Deferred() {\n    this.state = \x27pending\x27\n    this.promise = new Promise()\n}\n\nDeferred.prototype.resolve = function (obj) {\n    this.state = \x27fulfilled\x27\n    var promise = this.promise\n    var handler = {}\n    while (handler = promise.handlerQueue.shift()) {\n        if (handler \x26amp;\x26amp; handler.resolve) {\n            var res = handler.resolve(obj)\n            if (res \x26amp;\x26amp; res.isPromise) {\n                res.handlerQueue = promise.handlerQueue\n                this.promise = res\n                return;\n            } else {\n                obj = res\n            }\n        }\n    }\n}\n\nDeferred.prototype.reject = function (obj) {\n    this.state = \x27rejected\x27\n    var promise = this.promise\n    var handler = {}\n    while (handler = promise.handlerQueue.shift()) {\n        if (handler \x26amp;\x26amp; handler.reject) {\n            var res = handler.reject(obj)\n            if (res \x26amp;\x26amp; res.isPromise) {\n                res.handlerQueue = promise.handlerQueue\n                this.promise = res\n                return;\n            } else {\n                obj = res\n            }\n        }\n    }\n}\n\n\/\/------ test-------\/\/\nfunction asyncDosomeing(flag, name) {\n    const deferred = new Deferred()\n    setTimeout(function () {\n        if (flag) {\n            deferred.resolve({code: 200, message: \x27成功\x27, name: name})\n        } else {\n            deferred.reject({code: 400, message: \x27失败\x27, name: name})\n        }\n    }, 2000)\n    return deferred.promise\n}\nasyncDosomeing(true, \x27asyncDosomeing1\x27).then(result =\x3e {\n    console.info(result)\n    return asyncDosomeing(false, \x27asyncDosomeing2\x27)\n}).then(result =\x3e {\n    console.info(result)\n    return \x27dadds\x27\n}).then(result =\x3e {\n    console.info(result)\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.prototype.then = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eonFulfilled, onRejected\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e handler = {}\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e onFulfilled === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        handler.resolve = onFulfilled\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e onRejected === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        handler.reject = onRejected\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handlerQueue.push(handler)\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eDeferred\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state = \x3cspan class=\x22hljs-string\x22\x3e\x27pending\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.promise = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e()\n}\n\nDeferred.prototype.resolve = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eobj\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state = \x3cspan class=\x22hljs-string\x22\x3e\x27fulfilled\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e promise = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.promise\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e handler = {}\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (handler = promise.handlerQueue.shift()) {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (handler \x26amp;\x26amp; handler.resolve) {\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e res = handler.resolve(obj)\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res \x26amp;\x26amp; res.isPromise) {\n                res.handlerQueue = promise.handlerQueue\n                \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.promise = res\n                \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                obj = res\n            }\n        }\n    }\n}\n\nDeferred.prototype.reject = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eobj\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state = \x3cspan class=\x22hljs-string\x22\x3e\x27rejected\x27\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e promise = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.promise\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e handler = {}\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (handler = promise.handlerQueue.shift()) {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (handler \x26amp;\x26amp; handler.reject) {\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e res = handler.reject(obj)\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (res \x26amp;\x26amp; res.isPromise) {\n                res.handlerQueue = promise.handlerQueue\n                \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.promise = res\n                \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                obj = res\n            }\n        }\n    }\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/------ test-------\/\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3easyncDosomeing\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eflag, name\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e deferred = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Deferred()\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (flag) {\n            deferred.resolve({\x3cspan class=\x22hljs-attr\x22\x3ecode\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3emessage\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27成功\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: name})\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            deferred.reject({\x3cspan class=\x22hljs-attr\x22\x3ecode\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e400\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3emessage\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27失败\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: name})\n        }\n    }, \x3cspan class=\x22hljs-number\x22\x3e2000\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e deferred.promise\n}\nasyncDosomeing(\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27asyncDosomeing1\x27\x3c\/span\x3e).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.info(result)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e asyncDosomeing(\x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27asyncDosomeing2\x27\x3c\/span\x3e)\n}).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.info(result)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27dadds\x27\x3c\/span\x3e\n}).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.info(result)\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e五、统一的异常处理（拒绝处理）\x3c\/h2\x3e\n\x3cp\x3e那现在，我们有个需求，想实现所有的拒绝统一在一个地方处理。而不是每个then方法都传一个rejected 回调，只希望then()方法可以，安安心心的处理成功的回调。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22 step1().then(step2).then(step3).catch(function(err){\n\/\/ do something when err\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scilab\x22\x3e\x3ccode\x3e step1().\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(step2).\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(step3).\x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(err)\x3c\/span\x3e{\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ do something when err\x3c\/span\x3e\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e加一个catch err 的回调，当出现异常就直接到这个流程上处理。\x3cbr\x3e那我们就在promise 的原型上架一个catch方法，如下\x3c\/p\x3e\n\x3cp\x3ePromise.prototype.catch = function (onRejected) {\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var handler = {}\nif (typeof onRejected === \x27function\x27) {\n    handler.reject = onRejected\n}\nthis.handlerQueue.push(handler)\nreturn this\n}\n\n\/\/------ test-------\/\/\nfunction asyncDosomeing(flag, name) {\n    const deferred = new Deferred()\n    setTimeout(function () {\n        if (flag) {\n            deferred.resolve({code: 200, message: \x27成功\x27, name: name})\n        } else {\n            deferred.reject({code: 400, message: \x27失败\x27, name: name})\n        }\n    }, 2000)\n    return deferred.promise\n}\nasyncDosomeing(true, \x27asyncDosomeing1\x27).then(result =\x3e {\n    console.info(result)\n    return asyncDosomeing(false, \x27asyncDosomeing2\x27)\n}).then(result =\x3e {\n    console.info(result)\n    return \x27dadds\x27\n}).then(result =\x3e {\n    console.info(result)\n}).catch(err =\x3e {\n    console.info(\x27catch\x27)\n    console.info(err)\n    return asyncDosomeing(true, \x27asyncDosomeing3----catch\x27)\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e handler = {}\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e onRejected === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n    handler.reject = onRejected\n}\n\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handlerQueue.push(handler)\n\x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/------ test-------\/\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3easyncDosomeing\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eflag, name\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e deferred = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Deferred()\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (flag) {\n            deferred.resolve({\x3cspan class=\x22hljs-attr\x22\x3ecode\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3emessage\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27成功\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: name})\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            deferred.reject({\x3cspan class=\x22hljs-attr\x22\x3ecode\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e400\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3emessage\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27失败\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: name})\n        }\n    }, \x3cspan class=\x22hljs-number\x22\x3e2000\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e deferred.promise\n}\nasyncDosomeing(\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27asyncDosomeing1\x27\x3c\/span\x3e).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.info(result)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e asyncDosomeing(\x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27asyncDosomeing2\x27\x3c\/span\x3e)\n}).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.info(result)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27dadds\x27\x3c\/span\x3e\n}).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.info(result)\n}).catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.info(\x3cspan class=\x22hljs-string\x22\x3e\x27catch\x27\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.info(err)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e asyncDosomeing(\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27asyncDosomeing3----catch\x27\x3c\/span\x3e)\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样就可以实现，只要异步操作流程中有一步被拒绝，下面流程就自然中断，直接到catch回调中处理异常。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e六、API Promise化\x3c\/h2\x3e\n\x3cp\x3e在编码的时候，想要用promise进行异步操作流程控制，就要将当前的异步回调函数封装成promise。在自己开发的时候，往往会去引用第三方的模块，然后发现这些模块的异步回调API 不支持promise写法。难道我们自己全部封装实现一遍？！这明显是不合理的。那我们就可以实现一个 方法可以批量将方法Promise化，相关代码如下：\x3c\/p\x3e\n\x3cp\x3e1.在deferred原型上实现一个异步回调函数，回调执行后触发deferred resolve 和 reject的方法\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Deferred.prototype.callBack = function () {\n    var that = this\n    return function (err, result) {\n        if (err) {\n            that.reject(err)\n        } else {\n            that.resolve(result)\n        }\n    }\n}\n\n2.定义一个Api Promise化 方法\n\n\/**\n * 将异步操作转换成promise\n *\/\nvar promisify = function (method) {\n    if (typeof method !== \x27function\x27) {\n        throw new TypeError(\x27is not a function\x27)\n    }\n    return function () {\n        const defrred = new Deferred()\n        var args = Array.prototype.slice.call(arguments, 0) \/\/ 克隆参数\n        args.push(defrred.callBack())\n        method.apply(this, args)\n        return defrred.promise\n    }\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3eDeferred.prototype.callBack = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e that = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerr, result\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err) {\n            that.reject(err)\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            that.resolve(result)\n        }\n    }\n}\n\n\x3cspan class=\x22hljs-number\x22\x3e2.\x3c\/span\x3e定义一个Api \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e化 方法\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * 将异步操作转换成promise\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e promisify = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3emethod\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e method !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eTypeError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27is not a function\x27\x3c\/span\x3e)\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e defrred = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Deferred()\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e args = \x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.prototype.slice.call(\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 克隆参数\x3c\/span\x3e\n        args.push(defrred.callBack())\n        method.apply(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, args)\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e defrred.promise\n    }\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e最后我们就可以简化代码\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var readFile = promisify(fs.readFile);\nreadFile(\x27file.text\x27).then(function(file){\n    return readFile(file.trim())\n}).then(function(file2){\n    console.log(file2)\n})\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs fortran\x22\x3e\x3ccode\x3evar readFile = promisify(fs.readFile);\nreadFile(\x3cspan class=\x22hljs-string\x22\x3e\x27file.text\x27\x3c\/span\x3e).\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(file)\x3c\/span\x3e\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e readFile(\x3cspan class=\x22hljs-keyword\x22\x3efile\x3c\/span\x3e.\x3cspan class=\x22hljs-built_in\x22\x3etrim\x3c\/span\x3e())\n}).\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(file2)\x3c\/span\x3e\x3c\/span\x3e{\n    console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(file2)\n})\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里只是对promise\/deferred 原理的简单实现，还有很多情况没有考虑。希望大家在做promise异步流程操作的时候，还是选择现在成熟的模块。比如 q模块、bulebird、when、或者 es6 的promise 去做。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>promise/deferred 模式原理分析和实现</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010167155">https://segmentfault.com/a/1190000010167155</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/uw60vb68vyp/" target="_blank">https://alili.tech/archive/uw60vb68vyp/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5328xogjarn/">IndexedDB--HTML5本地存储<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/xpccu0hsqbr/">JS学习系列 01 - 编译原理和作用域<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/shv09bbtbfd/">Vue2 SSR 的优化之旅<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/5vj1ojfo6h6/">[2016年末巨献] — HTML5可交互地铁线路图（第二季：帝都进阶版）<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/m02hlm4bzh/">vue2.0开发聊天程序（三）组件的通信<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/mz5o7n90plg/">《很高兴我没有猝死》- 前端新人的 2016 年总结和感悟<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/3vhoe2mo09k/">一道颇有难度的JavaScript题<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/uj12mb7thp/">使用CANVAS实现交互性圆形马赛克效果<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/ja636h8hcxa/">写于 2016 年末<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/5uomnoq1kmi/">前端学习资源整理<aside class="dates">2019-01-28</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>