<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="koa中间件机制详解"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>koa中间件机制详解 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/zne1p0oahf/",
				"appid": "1613049289050283", 
				"title": "koa中间件机制详解 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-16T02:30:08"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/4nuir2gxr65/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/w7kq38rf7p7/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f&text=koa%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9c%ba%e5%88%b6%e8%af%a6%e8%a7%a3"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f&text=koa%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9c%ba%e5%88%b6%e8%af%a6%e8%a7%a3"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f&title=koa%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9c%ba%e5%88%b6%e8%af%a6%e8%a7%a3"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f&is_video=false&description=koa%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9c%ba%e5%88%b6%e8%af%a6%e8%a7%a3"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=koa%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9c%ba%e5%88%b6%e8%af%a6%e8%a7%a3&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f&title=koa%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9c%ba%e5%88%b6%e8%af%a6%e8%a7%a3"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f&title=koa%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9c%ba%e5%88%b6%e8%af%a6%e8%a7%a3"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f&title=koa%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9c%ba%e5%88%b6%e8%af%a6%e8%a7%a3"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fzne1p0oahf%2f&title=koa%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9c%ba%e5%88%b6%e8%af%a6%e8%a7%a3"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">koa中间件机制详解</h1><div class="meta"><div class="postdate"><time datetime="2019-01-16" itemprop="datePublished">2019-01-16</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3ekoa\x3c\/h2\x3e\n\x3cblockquote\x3e\x3cp\x3e\x3ccode\x3ekoa\x3c\/code\x3e是由\x3ccode\x3eexpress\x3c\/code\x3e原班人马打造的一个更小、更富有表现力、更健壮的\x3ccode\x3eweb\x3c\/code\x3e框架。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e在我眼中，\x3ccode\x3ekoa\x3c\/code\x3e的确是比\x3ccode\x3eexpress\x3c\/code\x3e轻量的多，\x3ccode\x3ekoa\x3c\/code\x3e给我的感觉更像是一个中间件框架，\x3ccode\x3ekoa\x3c\/code\x3e只是一个基础的架子，需要用到的相应的功能时，用相应的中间件来实现就好，诸如路由系统等。一个更好的点在于，\x3ccode\x3eexpress\x3c\/code\x3e是基于回调来处理，至于回调到底有多么的不好，大家可以自行搜索来看。\x3ccode\x3ekoa1\x3c\/code\x3e基于的\x3ccode\x3eco\x3c\/code\x3e库，所以\x3ccode\x3ekoa1\x3c\/code\x3e利用\x3ccode\x3eGenerator\x3c\/code\x3e来代替回调，而\x3ccode\x3ekoa2\x3c\/code\x3e由于\x3ccode\x3enode\x3c\/code\x3e对\x3ccode\x3easync\/await\x3c\/code\x3e的支持，所以\x3ccode\x3ekoa2\x3c\/code\x3e利用的是\x3ccode\x3easync\/await\x3c\/code\x3e。关于\x3ccode\x3easync\x3c\/code\x3e以及\x3ccode\x3eco\x3c\/code\x3e库等，大家可以参考我之前写过的一篇文章（\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000008687414\x22\x3e理解async\x3c\/a\x3e）。\x3ccode\x3ekoa\x3c\/code\x3e可以说是一个各种中间件的架子，下面就来看一下\x3ccode\x3ekoa\x3c\/code\x3e对于中间件部分的实现：\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3ekoa1的中间件\x3c\/h2\x3e\n\x3cp\x3e\x3ccode\x3ekoa1\x3c\/code\x3e主要利用的是\x3ccode\x3eGenerator\x3c\/code\x3e来实现，一般来说，\x3ccode\x3ekoa1\x3c\/code\x3e的一个中间件大概是长这个样子的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22app.use(function *(next){\n    console.log(1);\n    yield next;\n    console.log(5);\n});\napp.use(function *(next){\n    console.log(2);\n    yield next;\n    console.log(4);\n});\napp.use(function *(){\n    console.log(3);\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs openscad\x22\x3e\x3ccode\x3eapp.\x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *\x3cspan class=\x22hljs-params\x22\x3e(next)\x3c\/span\x3e{\x3c\/span\x3e\n    console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e);\n    yield next;\n    console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e);\n});\napp.\x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *\x3cspan class=\x22hljs-params\x22\x3e(next)\x3c\/span\x3e{\x3c\/span\x3e\n    console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e);\n    yield next;\n    console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e);\n});\napp.\x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e{\x3c\/span\x3e\n    console.\x3cspan class=\x22hljs-built_in\x22\x3elog\x3c\/span\x3e(\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e);\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样的输出会是\x3ccode\x3e1, 2, 3, 4, 5\x3c\/code\x3e，\x3ccode\x3ekoa\x3c\/code\x3e的中间件的实现主要依靠的是\x3ccode\x3ekoa-compose\x3c\/code\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function compose(middleware){\n  return function *(next){\n    if (!next) next = noop();\n\n    var i = middleware.length;\n    \/\/ 组合中间件\n    while (i--) {\n      next = middleware[i].call(this, next);\n    }\n\n    return yield *next;\n  }\n}\nfunction *noop(){}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecompose\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3emiddleware\x3c\/span\x3e)\x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *(\x3cspan class=\x22hljs-params\x22\x3enext\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!next) next = noop();\n\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = middleware.length;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 组合中间件\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (i--) {\n      next = middleware[i].call(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, next);\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e *next;\n  }\n}\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *\x3cspan class=\x22hljs-title\x22\x3enoop\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e源码非常的简单，实现的功能就是将所有的中间件串联起来，首先给倒数第一个中间件传入一个\x3ccode\x3enoop\x3c\/code\x3e作为其\x3ccode\x3enext\x3c\/code\x3e，再将这个整理后的倒数第一个中间作为\x3ccode\x3enext\x3c\/code\x3e传入倒数第二个中间件，最终得到的\x3ccode\x3enext\x3c\/code\x3e就是整理后的第一个中间件。说起来比较复杂，画图来看：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVMAtq?w=498\x26amp;h=349\x22 src=\x22https:\/\/static.alili.tech\/img\/bVMAtq?w=498\x26amp;h=349\x22 alt=\x22clipboard.png\x22 title=\x22clipboard.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e实现的效果如同上图，与\x3ccode\x3eredux\x3c\/code\x3e需要实现的目标类似，只要遇到了\x3ccode\x3eyield next\x3c\/code\x3e就去执行下一个中间件，利用\x3ccode\x3eco\x3c\/code\x3e库很容易将这个流程串联起来，下面来简单模拟下，中间件完整的实现：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const middlewares = [];\n\nconst getTestMiddWare = (loggerA, loggerB) =\x3e {\n    return function *(next) {\n        console.log(loggerA);\n        yield next;\n        console.log(loggerB);\n    }\n};\nconst mid1 = getTestMiddWare(1, 4),\n    mid2 = getTestMiddWare(2, 3);\n\nconst getData = new Promise((resolve, reject) =\x3e {\n    setTimeout(() =\x3e resolve(\x27数据已经取出\x27), 1000);\n});\n\nfunction *response(next) {\n    \/\/ 模拟异步读取数据库数据\n    const data = yield getData;\n    console.log(data);\n}\n\nmiddlewares.push(mid1, mid2, response);\n\/\/ 简单模拟co库\nfunction co(gen) {\n    const ctx = this,\n        args = Array.prototype.slice.call(arguments, 1);\n    return new Promise((reslove, reject) =\x3e {\n        if (typeof gen === \x27function\x27) gen = gen.apply(ctx, args);\n        if (!gen || typeof gen.next !== \x27function\x27) return resolve(gen);\n\n        const baseHandle = handle =\x3e res =\x3e {\n            let ret;\n            try {\n                ret = gen[handle](res);\n            } catch(e) {\n                reject(e);\n            }\n            next(ret);\n        };\n        const onFulfilled = baseHandle(\x27next\x27),\n            onRejected = baseHandle(\x27throw\x27);\n            \n        onFulfilled();\n        function next(ret) {\n            if (ret.done) return reslove(ret.value);\n            \/\/ 将yield的返回值转换为Proimse\n            let value = null;\n            if (typeof ret.value.then !== \x27function\x27) {\n                value = co(ret.value);\n            } else {\n                value = ret.value;\n            }\n            if (value) return value.then(onFulfilled, onRejected);\n            return onRejected(new TypeError(\x27yield type error\x27));\n        }\n    });\n}\n\/\/ 调用方式\nconst gen = compose(middlewares);\nco(gen);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e middlewares = [];\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e getTestMiddWare = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eloggerA, loggerB\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *(\x3cspan class=\x22hljs-params\x22\x3enext\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(loggerA);\n        \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e next;\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(loggerB);\n    }\n};\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e mid1 = getTestMiddWare(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e),\n    mid2 = getTestMiddWare(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e getData = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27数据已经取出\x27\x3c\/span\x3e), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n});\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *\x3cspan class=\x22hljs-title\x22\x3eresponse\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3enext\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 模拟异步读取数据库数据\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e data = \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e getData;\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(data);\n}\n\nmiddlewares.push(mid1, mid2, response);\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 简单模拟co库\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eco\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3egen\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e ctx = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e,\n        args = \x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.prototype.slice.call(\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ereslove, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e gen === \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) gen = gen.apply(ctx, args);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!gen || \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e gen.next !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e resolve(gen);\n\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e baseHandle = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ehandle\x3c\/span\x3e =\x26gt;\x3c\/span\x3e res =\x26gt; {\n            \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e ret;\n            \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n                ret = gen[handle](res);\n            } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(e) {\n                reject(e);\n            }\n            next(ret);\n        };\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e onFulfilled = baseHandle(\x3cspan class=\x22hljs-string\x22\x3e\x27next\x27\x3c\/span\x3e),\n            onRejected = baseHandle(\x3cspan class=\x22hljs-string\x22\x3e\x27throw\x27\x3c\/span\x3e);\n            \n        onFulfilled();\n        \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3enext\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eret\x3c\/span\x3e) \x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (ret.done) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e reslove(ret.value);\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 将yield的返回值转换为Proimse\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e value = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e ret.value.then !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n                value = co(ret.value);\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                value = ret.value;\n            }\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (value) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e value.then(onFulfilled, onRejected);\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e onRejected(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eTypeError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27yield type error\x27\x3c\/span\x3e));\n        }\n    });\n}\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 调用方式\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e gen = compose(middlewares);\nco(gen);\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3ekoa2的中间件\x3c\/h2\x3e\n\x3cp\x3e随着\x3ccode\x3enode\x3c\/code\x3e对于\x3ccode\x3easync\/await\x3c\/code\x3e的支持，貌似不需要再借助于\x3ccode\x3eco\x3c\/code\x3e这种工具库了，直接利用原生的就好，于是\x3ccode\x3ekoa\x3c\/code\x3e也做出了改变，来看目前的\x3ccode\x3ekoa-compose\x3c\/code\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function compose (middleware) {\n  \/\/ 参数检验\n  return function (context, next) {\n    \/\/ last called middleware #\n    let index = -1\n    return dispatch(0)\n    function dispatch (i) {\n      if (i \x3c= index) return Promise.reject(new Error(\x27next() called multiple times\x27))\n      index = i\n      let fn = middleware[i]\n      \/\/ 最后一个中间件的调用\n      if (i === middleware.length) fn = next\n      if (!fn) return Promise.resolve()\n      \/\/ 用Promise包裹中间件，方便await调用\n      try {\n        return Promise.resolve(fn(context, function next () {\n          return dispatch(i \x2b 1)\n        }))\n      } catch (err) {\n        return Promise.reject(err)\n      }\n    }\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecompose\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3emiddleware\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 参数检验\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3econtext, next\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ last called middleware #\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e index = \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e dispatch(\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e)\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3edispatch\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3ei\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (i \x26lt;= index) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27next() called multiple times\x27\x3c\/span\x3e))\n      index = i\n      \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e fn = middleware[i]\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 最后一个中间件的调用\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (i === middleware.length) fn = next\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!fn) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve()\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 用Promise包裹中间件，方便await调用\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve(fn(context, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3enext\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n          \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e dispatch(i \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n        }))\n      } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.reject(err)\n      }\n    }\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3ekoa-compose\x3c\/code\x3e利用了\x3ccode\x3ePromise\x3c\/code\x3e，\x3ccode\x3ekoa2\x3c\/code\x3e的中间件的参数也有一个变为了两个，而且执行下一个的中间件利用的是\x3ccode\x3eawait next()\x3c\/code\x3e，要达到与上面的示例代码的相同效果，需要更改中间件的写法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const middlewares = [];\nconst getTestMiddWare = (loggerA, loggerB) =\x3e async (ctx, next) =\x3e {\n    console.log(loggerA);\n    await next();\n    console.log(loggerB);\n};\n\nconst mid1 = getTestMiddWare(1, 4),\n    mid2 = getTestMiddWare(2, 3);\nconst response = async () =\x3e {\n    \/\/ 模拟异步读取数据库数据\n    const data = await getData();\n    console.log(data);\n};\nconst getData = () =\x3e new Promise((resolve, reject) =\x3e {\n    setTimeout(() =\x3e resolve(\x27数据已经取出\x27), 1000);\n});\nmiddlewares.push(mid1, mid2);\n\n\/\/ 调用方式\ncompose(middlewares)(null, response);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e middlewares = [];\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e getTestMiddWare = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eloggerA, loggerB\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e (ctx, next) =\x26gt; {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(loggerA);\n    \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e next();\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(loggerB);\n};\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e mid1 = getTestMiddWare(\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e4\x3c\/span\x3e),\n    mid2 = getTestMiddWare(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e response = \x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e () =\x26gt; {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 模拟异步读取数据库数据\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e data = \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e getData();\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(data);\n};\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e getData = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27数据已经取出\x27\x3c\/span\x3e), \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n});\nmiddlewares.push(mid1, mid2);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 调用方式\x3c\/span\x3e\ncompose(middlewares)(\x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, response);\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e如何做到兼容\x3c\/h2\x3e\n\x3cp\x3e可以看到的是，\x3ccode\x3ekoa1\x3c\/code\x3e与\x3ccode\x3ekoa2\x3c\/code\x3e对于中间件的实现还是有着很多的不同的，将\x3ccode\x3ekoa1\x3c\/code\x3e的中间件直接拿到\x3ccode\x3ekoa2\x3c\/code\x3e下面来使用肯定是会出现错误的，如何兼容这两个版本也成了一个问题，\x3ccode\x3ekoa\x3c\/code\x3e团队写了一个包来是\x3ccode\x3ekoa1\x3c\/code\x3e的中间件可以用于\x3ccode\x3ekoa2\x3c\/code\x3e中，叫做\x3ccode\x3ekoa-convert\x3c\/code\x3e，先来看看这个包怎么使用：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function *mid3(next) {\n    console.log(2, \x27koa1的中间件\x27);\n    yield next;\n    console.log(3, \x27koa1的中间件\x27);\n}\nconvert.compose(mid3)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e *\x3cspan class=\x22hljs-title\x22\x3emid3\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3enext\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27koa1的中间件\x27\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e next;\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27koa1的中间件\x27\x3c\/span\x3e);\n}\nconvert.compose(mid3)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e来看下这个包实现的思路：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 将参数转为数组，对每一个koa1的中间件执行convert操作\nconvert.compose = function (arr) {\n  if (!Array.isArray(arr)) {\n    arr = Array.from(arguments)\n  }\n  return compose(arr.map(convert))\n}\n\/\/ 关键在于convert的实现\nconst convert = mw =\x3e (ctx, next) =\x3e {\n    \/\/ 借助co库，返回一个Promise，同时执行yield\n    return co.call(ctx, mw.call(ctx, createGenerator(next)));\n};\n\nfunction * createGenerator (next) {\n  \/*\n     next为koa-compomse中：\n     function next () {\n         return dispatch(i \x2b 1)\n     }\n  *\/\n  return yield next()\n  \/\/ 执行完koa1的中间件，又回到了利用await执行koa2中间件的正轨\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 将参数转为数组，对每一个koa1的中间件执行convert操作\x3c\/span\x3e\nconvert.compose = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3earr\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.isArray(arr)) {\n    arr = \x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.from(\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e)\n  }\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e compose(arr.map(convert))\n}\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 关键在于convert的实现\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e convert = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3emw\x3c\/span\x3e =\x26gt;\x3c\/span\x3e (ctx, next) =\x26gt; {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 借助co库，返回一个Promise，同时执行yield\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e co.call(ctx, mw.call(ctx, createGenerator(next)));\n};\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e * \x3cspan class=\x22hljs-title\x22\x3ecreateGenerator\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3enext\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-comment\x22\x3e\/*\n     next为koa-compomse中：\n     function next () {\n         return dispatch(i \x2b 1)\n     }\n  *\/\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e next()\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 执行完koa1的中间件，又回到了利用await执行koa2中间件的正轨\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e个人感觉\x3ccode\x3ekoa-convert\x3c\/code\x3e的思路就是对\x3ccode\x3eGenerator\x3c\/code\x3e封装一层\x3ccode\x3ePromise\x3c\/code\x3e，使上一个中间件可以利用\x3ccode\x3eawait next()\x3c\/code\x3e的方式调用，对于\x3ccode\x3eGenerator\x3c\/code\x3e的执行，利用\x3ccode\x3eco\x3c\/code\x3e库，从而达到了兼容的目的。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>koa中间件机制详解</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000009158828">https://segmentfault.com/a/1190000009158828</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/zne1p0oahf/" target="_blank">https://alili.tech/archive/zne1p0oahf/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5fmk2pl6rab/">2016年前端开发者深度调研，看看别人使用什么技术体系<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/stp6408xnu/">Bootstrap使用模态框modal实现表单提交弹出框<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/fu7a86e9uyh/">CSS水平垂直居中总结<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/r0w29esklr/">JS 里怎么给数组填充默认值<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/i00hiszlr1/">JavaScript - EventEmitter 背后的秘密<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/u2la0cn9do/">JavaScript 精度丢失问题<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/3txhfn3ejcb/">Nodejs进阶：如何玩转子进程（child_process）<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/yr7v8e9fao/">Promise介绍--规范篇<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/9lyxyz4wc6g/">QQ音乐API整理<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/84zzlljmes4/">SegmentFault 技术周刊 Vol.14 - 进阶 Vue 2.0<aside class="dates">2019-01-30</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>