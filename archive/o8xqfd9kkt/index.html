<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="WebAssembly 初体验：从零开始重构计算模块"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>WebAssembly 初体验：从零开始重构计算模块 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/o8xqfd9kkt/",
				"appid": "1613049289050283", 
				"title": "WebAssembly 初体验：从零开始重构计算模块 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-12T02:30:24"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/k10d0an1g0d/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/5e4faq5e4ag/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f&text=WebAssembly%20%e5%88%9d%e4%bd%93%e9%aa%8c%ef%bc%9a%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e9%87%8d%e6%9e%84%e8%ae%a1%e7%ae%97%e6%a8%a1%e5%9d%97"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f&text=WebAssembly%20%e5%88%9d%e4%bd%93%e9%aa%8c%ef%bc%9a%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e9%87%8d%e6%9e%84%e8%ae%a1%e7%ae%97%e6%a8%a1%e5%9d%97"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f&title=WebAssembly%20%e5%88%9d%e4%bd%93%e9%aa%8c%ef%bc%9a%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e9%87%8d%e6%9e%84%e8%ae%a1%e7%ae%97%e6%a8%a1%e5%9d%97"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f&is_video=false&description=WebAssembly%20%e5%88%9d%e4%bd%93%e9%aa%8c%ef%bc%9a%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e9%87%8d%e6%9e%84%e8%ae%a1%e7%ae%97%e6%a8%a1%e5%9d%97"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=WebAssembly%20%e5%88%9d%e4%bd%93%e9%aa%8c%ef%bc%9a%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e9%87%8d%e6%9e%84%e8%ae%a1%e7%ae%97%e6%a8%a1%e5%9d%97&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f&title=WebAssembly%20%e5%88%9d%e4%bd%93%e9%aa%8c%ef%bc%9a%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e9%87%8d%e6%9e%84%e8%ae%a1%e7%ae%97%e6%a8%a1%e5%9d%97"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f&title=WebAssembly%20%e5%88%9d%e4%bd%93%e9%aa%8c%ef%bc%9a%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e9%87%8d%e6%9e%84%e8%ae%a1%e7%ae%97%e6%a8%a1%e5%9d%97"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f&title=WebAssembly%20%e5%88%9d%e4%bd%93%e9%aa%8c%ef%bc%9a%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e9%87%8d%e6%9e%84%e8%ae%a1%e7%ae%97%e6%a8%a1%e5%9d%97"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fo8xqfd9kkt%2f&title=WebAssembly%20%e5%88%9d%e4%bd%93%e9%aa%8c%ef%bc%9a%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e9%87%8d%e6%9e%84%e8%ae%a1%e7%ae%97%e6%a8%a1%e5%9d%97"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">WebAssembly 初体验：从零开始重构计算模块</h1><div class="meta"><div class="postdate"><time datetime="2019-01-12" itemprop="datePublished">2019-01-12</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cblockquote\x3e\x3cp\x3e\x3ca href=\x22https:\/\/zhuanlan.zhihu.com\/p\/27410280\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eWebAssembly 初体验：从零开始重构计算模块\x3c\/a\x3e从属于笔者的\x3ca href=\x22https:\/\/github.com\/wxyyxc1992\/Web-Development-And-Engineering-Practices\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e  Web 前端入门与工程实践\x3c\/a\x3e，更多相关资料文章参考\x3ca href=\x22https:\/\/github.com\/wxyyxc1992\/Coder-Knowledge-Management\/tree\/master\/Awesome-Reference\/Web\/Syntax\/WebAssembly\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eWebAssembly 学习与实践资料索引\x3c\/a\x3e和\x3ca href=\x22https:\/\/parg.co\/bM1\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e React 学习与实践资料索引\x3c\/a\x3e。本文中使用的游戏代码修改自  \x3ca href=\x22http:\/\/blog.openbloc.fr\/webassembly-first-steps\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eWebAssembly 101: a developer\x27s first steps\x3c\/a\x3e。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3eWebAssembly 的概念、意义以及未来带来的性能提升相信已是耳熟能详，笔者在\x3ca href=\x22https:\/\/parg.co\/bh1\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e前端每周清单系列\x3c\/a\x3e中也是经常会推荐 WebAssembly 相关文章。不过笔者也只是了解其概念而未真正付诸实践，本文即是笔者在将我司某个简单项目中的计算模块重构为 WebAssembly 过程中的总结。在简单的实践中笔者个人感觉，WebAssembly 的抽象程度会比 JavaScript 高不少，未来对于大型项目的迁移，对于纯前端工程师而言可能存在的坑也是不少，仿佛又回到了被指针统治的年代。本文笔者使用的案例已经集成到了 React 脚手架 \x3ca href=\x22https:\/\/github.com\/wxyyxc1992\/create-react-boilerplate\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ecreate-react-boilerplate\x3c\/a\x3e 中 ，可以方便大家快速本地实践。\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader0\x22\x3e编译环境搭建\x3c\/h1\x3e\n\x3cp\x3e我们使用 Emscripten 将 C 代码编译为 wasm 格式，官方推荐的方式是首先下载 \x3ca href=\x22https:\/\/s3.amazonaws.com\/mozilla-games\/emscripten\/releases\/emsdk-portable.tar.gz\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ePortable Emscripten SDK for Linux and OS X (emsdk-portable.tar.gz)\x3c\/a\x3e 然后利用 emsdk 进行安装：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22$ .\/emsdk update\n$ .\/emsdk install latest\n# 如果出现异常使用 .\/emsdk install sdk-1.37.12-64bit\n# https:\/\/github.com\/kripken\/emscripten\/issues\/5272\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs elixir\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-variable\x22\x3e$ \x3c\/span\x3e.\/emsdk update\n\x3cspan class=\x22hljs-variable\x22\x3e$ \x3c\/span\x3e.\/emsdk install latest\n\x3cspan class=\x22hljs-comment\x22\x3e# 如果出现异常使用 .\/emsdk install sdk-1.37.12-64bit\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e# https:\/\/github.com\/kripken\/emscripten\/issues\/5272\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e安装完毕后激活响应环境即可以进行编译：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22$ .\/emsdk activate latest\n$ source .\/emsdk_env.sh  # you can add this line to your .bashrc\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs elixir\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-variable\x22\x3e$ \x3c\/span\x3e.\/emsdk activate latest\n\x3cspan class=\x22hljs-variable\x22\x3e$ \x3c\/span\x3esource .\/emsdk_env.sh  \x3cspan class=\x22hljs-comment\x22\x3e# you can add this line to your .bashrc\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e笔者在本地执行上述搭建步骤时一直失败，因此改用了 Docker 预先配置好的镜像进行处理：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22# 拉取 Docker 镜像\ndocker pull 42ua\/emsdk\n\n# 执行编译操作\ndocker run --rm -v $(pwd):\/home\/src 42ua\/emsdk emcc hello_world.c\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs elixir\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e# 拉取 Docker 镜像\x3c\/span\x3e\ndocker pull \x3cspan class=\x22hljs-number\x22\x3e42\x3c\/span\x3eua\/emsdk\n\n\x3cspan class=\x22hljs-comment\x22\x3e# 执行编译操作\x3c\/span\x3e\ndocker run --rm -v \x3cspan class=\x22hljs-variable\x22\x3e$(\x3c\/span\x3epwd)\x3cspan class=\x22hljs-symbol\x22\x3e:\/home\/src\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e42\x3c\/span\x3eua\/emsdk emcc hello_world.c\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e对应的 Dockfile 如下所示，我们可以自行修改以适应未来的编译环境：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22FROM ubuntu\n\nRUN \\\n    apt-get update \x26amp;\x26amp; apt-get install -y build-essential \\\n    cmake python2.7 python nodejs-legacy default-jre git-core curl \x26amp;\x26amp; \\\n    apt-get clean \x26amp;\x26amp; \\\n\\\n    cd ~\/ \x26amp;\x26amp; \\\n    curl -sL https:\/\/s3.amazonaws.com\/mozilla-games\/emscripten\/releases\/emsdk-portable.tar.gz | tar xz \x26amp;\x26amp; \\\n    cd emsdk-portable\/ \x26amp;\x26amp; \\\n    .\/emsdk update \x26amp;\x26amp; \\\n    .\/emsdk install -j1 latest \x26amp;\x26amp; \\\n    .\/emsdk activate latest \x26amp;\x26amp; \\\n\\\n    rm -rf ~\/emsdk-portable\/clang\/tag-*\/src \x26amp;\x26amp; \\\n    find . -name \x26quot;*.o\x26quot; -exec rm {} \\; \x26amp;\x26amp; \\\n    find . -name \x26quot;*.a\x26quot; -exec rm {} \\; \x26amp;\x26amp; \\\n    find . -name \x26quot;*.tmp\x26quot; -exec rm {} \\; \x26amp;\x26amp; \\\n    find . -type d -name \x26quot;.git\x26quot; -prune -exec rm -rf {} \\; \x26amp;\x26amp; \\\n\\\n    apt-get -y --purge remove curl git-core cmake \x26amp;\x26amp; \\\n    apt-get -y autoremove \x26amp;\x26amp; apt-get clean\n\n# http:\/\/docs.docker.com\/engine\/reference\/run\/#workdir\nWORKDIR \/home\/src\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs tex\x22\x3e\x3ccode\x3eFROM ubuntu\n\nRUN \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    apt-get update \x26amp;\x26amp; apt-get install -y build-essential \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    cmake python2.7 python nodejs-legacy default-jre git-core curl \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    apt-get clean \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    cd ~\/ \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    curl -sL https:\/\/s3.amazonaws.com\/mozilla-games\/emscripten\/releases\/emsdk-portable.tar.gz | tar xz \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    cd emsdk-portable\/ \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    .\/emsdk update \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    .\/emsdk install -j1 latest \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    .\/emsdk activate latest \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    rm -rf ~\/emsdk-portable\/clang\/tag-*\/src \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    find . -name \x22*.o\x22 -exec rm {} \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e;\x3c\/span\x3e\x3c\/span\x3e \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    find . -name \x22*.a\x22 -exec rm {} \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e;\x3c\/span\x3e\x3c\/span\x3e \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    find . -name \x22*.tmp\x22 -exec rm {} \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e;\x3c\/span\x3e\x3c\/span\x3e \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    find . -type d -name \x22.git\x22 -prune -exec rm -rf {} \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e;\x3c\/span\x3e\x3c\/span\x3e \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    apt-get -y --purge remove curl git-core cmake \x26amp;\x26amp; \x3cspan class=\x22hljs-tag\x22\x3e\\\x3cspan class=\x22hljs-name\x22\x3e\n\x3c\/span\x3e\x3c\/span\x3e    apt-get -y autoremove \x26amp;\x26amp; apt-get clean\n\n# http:\/\/docs.docker.com\/engine\/reference\/run\/#workdir\nWORKDIR \/home\/src\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e到这里基本环境已经配置完毕，我们可以对简单的 counter.c 进行编译，源文件如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22int counter = 100;\n\nint count() {  \n    counter \x2b= 1;\n    return counter;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs cpp\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e counter = \x3cspan class=\x22hljs-number\x22\x3e100\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecount\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{  \n    counter \x2b= \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e counter;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e编译命令如下所示，如果本地安装好了 emcc 则可以直接使用，否则使用 Docker 环境进行编译：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22$ docker run --rm -v $(pwd):\/home\/src 42ua\/emsdk emcc counter.c -s WASM=1 -s SIDE_MODULE=1 -o counter.wasm\n$ emcc counter.c -s WASM=1 -s SIDE_MODULE=1 -o counter.wasm\n\n# 如果出现以下错误，则是由如下参数\n# WebAssembly Link Error: import object field \x27DYNAMICTOP_PTR\x27 is not a Number\nemcc counter.c -O1 -s WASM=1 -s SIDE_MODULE=1 -o counter.wasm \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs bash\x22\x3e\x3ccode\x3e$ docker run --rm -v $(\x3cspan class=\x22hljs-built_in\x22\x3epwd\x3c\/span\x3e):\/home\/src 42ua\/emsdk emcc counter.c \x3cspan class=\x22hljs-_\x22\x3e-s\x3c\/span\x3e WASM=1 \x3cspan class=\x22hljs-_\x22\x3e-s\x3c\/span\x3e SIDE_MODULE=1 -o counter.wasm\n$ emcc counter.c \x3cspan class=\x22hljs-_\x22\x3e-s\x3c\/span\x3e WASM=1 \x3cspan class=\x22hljs-_\x22\x3e-s\x3c\/span\x3e SIDE_MODULE=1 -o counter.wasm\n\n\x3cspan class=\x22hljs-comment\x22\x3e# 如果出现以下错误，则是由如下参数\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e# WebAssembly Link Error: import object field \x27DYNAMICTOP_PTR\x27 is not a Number\x3c\/span\x3e\nemcc counter.c -O1 \x3cspan class=\x22hljs-_\x22\x3e-s\x3c\/span\x3e WASM=1 \x3cspan class=\x22hljs-_\x22\x3e-s\x3c\/span\x3e SIDE_MODULE=1 -o counter.wasm \x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样我们就得到了 WebAssembly 代码：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000009792804?w=317\x26amp;h=128\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000009792804?w=317\x26amp;h=128\x22 alt=\x22Some WebAssembly code\x22 title=\x22Some WebAssembly code\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader1\x22\x3e与 JavaScript 集成使用\x3c\/h1\x3e\n\x3cp\x3e独立的 .wasm 文件并不能直接使用，我们需要在客户端中使用 JavaScript 代码将其加载进来。最朴素的加载 WebAssembly 的方式就是使用 fetch 抓取然后编译，整个过程可以封装为如下函数：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    \/\/ 判断是否支持 WebAssembly\n    if (!(\x27WebAssembly\x27 in window)) {\n      alert(\x27当前浏览器不支持 WebAssembly！\x27);\n    }\n    \/\/ Loads a WebAssembly dynamic library, returns a promise.\n    \/\/ imports is an optional imports object\n    function loadWebAssembly(filename, imports) {\n      \/\/ Fetch the file and compile it\n      return fetch(filename)\n        .then(response =\x3e response.arrayBuffer())\n        .then(buffer =\x3e WebAssembly.compile(buffer))\n        .then(module =\x3e {\n          \/\/ Create the imports for the module, including the\n          \/\/ standard dynamic library imports\n          imports = imports || {};\n          imports.env = imports.env || {};\n          imports.env.memoryBase = imports.env.memoryBase || 0;\n          imports.env.tableBase = imports.env.tableBase || 0;\n          if (!imports.env.memory) {\n            imports.env.memory = new WebAssembly.Memory({ initial: 256 });\n          }\n          if (!imports.env.table) {\n            imports.env.table = new WebAssembly.Table({ initial: 0, element: \x27anyfunc\x27 });\n          }\n          \/\/ Create the instance.\n          return new WebAssembly.Instance(module, imports);\n        });\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 判断是否支持 WebAssembly\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!(\x3cspan class=\x22hljs-string\x22\x3e\x27WebAssembly\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e)) {\n      alert(\x3cspan class=\x22hljs-string\x22\x3e\x27当前浏览器不支持 WebAssembly！\x27\x3c\/span\x3e);\n    }\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ Loads a WebAssembly dynamic library, returns a promise.\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ imports is an optional imports object\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eloadWebAssembly\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3efilename, imports\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ Fetch the file and compile it\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e fetch(filename)\n        .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresponse\x3c\/span\x3e =\x26gt;\x3c\/span\x3e response.arrayBuffer())\n        .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3ebuffer\x3c\/span\x3e =\x26gt;\x3c\/span\x3e WebAssembly.compile(buffer))\n        .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3emodule\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n          \x3cspan class=\x22hljs-comment\x22\x3e\/\/ Create the imports for the module, including the\x3c\/span\x3e\n          \x3cspan class=\x22hljs-comment\x22\x3e\/\/ standard dynamic library imports\x3c\/span\x3e\n          imports = imports || {};\n          imports.env = imports.env || {};\n          imports.env.memoryBase = imports.env.memoryBase || \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n          imports.env.tableBase = imports.env.tableBase || \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n          \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!imports.env.memory) {\n            imports.env.memory = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e WebAssembly.Memory({ \x3cspan class=\x22hljs-attr\x22\x3einitial\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e256\x3c\/span\x3e });\n          }\n          \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!imports.env.table) {\n            imports.env.table = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e WebAssembly.Table({ \x3cspan class=\x22hljs-attr\x22\x3einitial\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3eelement\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27anyfunc\x27\x3c\/span\x3e });\n          }\n          \x3cspan class=\x22hljs-comment\x22\x3e\/\/ Create the instance.\x3c\/span\x3e\n          \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e WebAssembly.Instance(\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e, imports);\n        });\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们可以使用上述工具函数加载 wasm 文件：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    loadWebAssembly(\x27counter.wasm\x27)\n      .then(instance =\x3e {\n        var exports = instance.exports; \/\/ the exports of that instance\n        var count = exports. _count; \/\/ the \x26quot;_count\x26quot; function (note \x26quot;_\x26quot; prefix)\n        \/\/ 下面即可以调用 count 函数\n      }\n    );\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e    loadWebAssembly(\x3cspan class=\x22hljs-string\x22\x3e\x27counter.wasm\x27\x3c\/span\x3e)\n      .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3einstance\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e exports = instance.exports; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ the exports of that instance\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e count = exports. _count; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ the \x22_count\x22 function (note \x22_\x22 prefix)\x3c\/span\x3e\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 下面即可以调用 count 函数\x3c\/span\x3e\n      }\n    );\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e而在笔者的\x3ca href=\x22https:\/\/github.com\/wxyyxc1992\/create-react-boilerplate\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e脚手架\x3c\/a\x3e中，使用了 wasm-loader 进行加载，这样可以将 wasm 直接打包在 Bundle 中，然后通过 \x3ccode\x3eimport\x3c\/code\x3e 导入：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import React, { PureComponent } from \x26quot;react\x26quot;;\n\nimport CounterWASM from \x26quot;.\/counter.wasm\x26quot;;\nimport Button from \x26quot;antd\/es\/button\/button\x26quot;;\n\nimport \x26quot;.\/Counter.scss\x26quot;;\n\n\/**\n * Description 简单计数器示例\n *\/\nexport default class Counter extends PureComponent {\n  state = {\n    count: 0\n  };\n\n  componentDidMount() {\n    this.counter = new CounterWASM({\n      env: {\n        memoryBase: 0,\n        tableBase: 0,\n        memory: new window.WebAssembly.Memory({ initial: 256 }),\n        table: new window.WebAssembly.Table({ initial: 0, element: \x26quot;anyfunc\x26quot; })\n      }\n    });\n    this.setState({\n      count: this.counter.exports._count()\n    });\n  }\n\n  \/**\n   * Description 默认渲染函数\n   *\/\n  render() {\n    const isWASMSupport = \x26quot;WebAssembly\x26quot; in window;\n\n    if (!isWASMSupport) {\n      return (\n        \x3cdiv\x3e\n          浏览器不支持 WASM\n        \x3c\/div\x3e\n      );\n    }\n\n    return (\n      \x3cdiv className=\x26quot;Counter__container\x26quot;\x3e\n        \x3cspan\x3e\n          简单计数器示例：\n        \x3c\/span\x3e\n        \x3cspan\x3e{this.state.count}\x3c\/span\x3e\n        \x3cButton\n          type=\x26quot;primary\x26quot;\n          onClick={() =\x3e {\n            this.setState({\n              count: this.counter.exports._count()\n            });\n          \x22}}\x22\n        \x3e\n          点击自增\n        \x3c\/Button\x3e\n      \x3c\/div\x3e\n    );\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e React, { PureComponent } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x22react\x22\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e CounterWASM \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x22.\/counter.wasm\x22\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Button \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x22antd\/es\/button\/button\x22\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x22.\/Counter.scss\x22\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * Description 简单计数器示例\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eCounter\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ePureComponent\x3c\/span\x3e \x3c\/span\x3e{\n  state = {\n    \x3cspan class=\x22hljs-attr\x22\x3ecount\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n  };\n\n  componentDidMount() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.counter = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e CounterWASM({\n      \x3cspan class=\x22hljs-attr\x22\x3eenv\x3c\/span\x3e: {\n        \x3cspan class=\x22hljs-attr\x22\x3ememoryBase\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3etableBase\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3ememory\x3c\/span\x3e: \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.WebAssembly.Memory({ \x3cspan class=\x22hljs-attr\x22\x3einitial\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e256\x3c\/span\x3e }),\n        \x3cspan class=\x22hljs-attr\x22\x3etable\x3c\/span\x3e: \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.WebAssembly.Table({ \x3cspan class=\x22hljs-attr\x22\x3einitial\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3eelement\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22anyfunc\x22\x3c\/span\x3e })\n      }\n    });\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setState({\n      \x3cspan class=\x22hljs-attr\x22\x3ecount\x3c\/span\x3e: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.counter.exports._count()\n    });\n  }\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/**\n   * Description 默认渲染函数\n   *\/\x3c\/span\x3e\n  render() {\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e isWASMSupport = \x3cspan class=\x22hljs-string\x22\x3e\x22WebAssembly\x22\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!isWASMSupport) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n        \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n          浏览器不支持 WASM\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/span\x3e\n      );\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n      \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclassName\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22Counter__container\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n          简单计数器示例：\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e{this.state.count}\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eButton\x3c\/span\x3e\n          \x3cspan class=\x22hljs-attr\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22primary\x22\x3c\/span\x3e\n          \x3cspan class=\x22hljs-attr\x22\x3eonClick\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n            this.setState({\n              count: this.counter.exports._count()\n            });\n          \x22}}\x22\n        \x26gt;\n          点击自增\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eButton\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/span\x3e\n    );\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在使用 \x3ccode\x3ewasm-loader\x3c\/code\x3e 时，其会调用 \x3ccode\x3enew WebAssembly.Instance(module, importObject);\x3c\/code\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3emodule\x3c\/code\x3e 即 \x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/JavaScript\/Reference\/Global_Objects\/WebAssembly\/Module\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eWebAssembly.Module\x3c\/a\x3e 实例。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eimportObject\x3c\/code\x3e 即默认的由 \x3ccode\x3ewasm-loader\x3c\/code\x3e 提供的对象。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch1 id=\x22articleHeader2\x22\x3e简单游戏引擎重构\x3c\/h1\x3e\n\x3cp\x3e上文我们讨论了利用 WebAssembly 重构简单的计数器模块，这里我们以简单的游戏为例，交互式的感受 WebAssembly 带来的性能提升，可以直接查看\x3ca href=\x22http:\/\/wxyyxc1992.github.io\/crb\/#\/wasm\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e游戏的在线演示\x3c\/a\x3e。这里的游戏引擎即是执行部分计算与重新赋值操作，譬如这里的计算下一个位置状态的函数在 C 中实现为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22EMSCRIPTEN_KEEPALIVE\nvoid computeNextState()\n{\n  loopCurrentState();\n\n  int neighbors = 0;\n  int i_m1, i_p1, i_;\n  int j_m1, j_p1;\n  int height_limit = height - 1;\n  int width_limit = width - 1;\n  for (int i = 1; i \x3c height_limit; i\x2b\x2b)\n  {\n    i_m1 = (i - 1) * width;\n    i_p1 = (i \x2b 1) * width;\n    i_ = i * width;\n    for (int j = 1; j \x3c width_limit; j\x2b\x2b)\n    {\n      j_m1 = j - 1;\n      j_p1 = j \x2b 1;\n      neighbors = current[i_m1 \x2b j_m1];\n      neighbors \x2b= current[i_m1 \x2b j];\n      neighbors \x2b= current[i_m1 \x2b j_p1];\n      neighbors \x2b= current[i_ \x2b j_m1];\n      neighbors \x2b= current[i_ \x2b j_p1];\n      neighbors \x2b= current[i_p1 \x2b j_m1];\n      neighbors \x2b= current[i_p1 \x2b j];\n      neighbors \x2b= current[i_p1 \x2b j_p1];\n      if (neighbors == 3)\n      {\n        next[i_ \x2b j] = 1;\n      }\n      else if (neighbors == 2)\n      {\n        next[i_ \x2b j] = current[i_ \x2b j];\n      }\n      else\n      {\n        next[i_ \x2b j] = 0;\n      }\n    }\n  }\n  memcpy(current, next, width * height);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs mipsasm\x22\x3e\x3ccode\x3eEMSCRIPTEN_KEEPALIVE\nvoid computeNextState()\n{\n  loopCurrentState()\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n\n  int neighbors = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n  int i_m1, i_p1, i_\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n  int \x3cspan class=\x22hljs-keyword\x22\x3ej_m1, \x3c\/span\x3e\x3cspan class=\x22hljs-keyword\x22\x3ej_p1;\n\x3c\/span\x3e  int height_limit = height - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n  int width_limit = width - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n  for (int i = \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e; i \x26lt; height_limit; i\x2b\x2b)\x3c\/span\x3e\n  {\n    i_m1 = (i - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) * width\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n    i_p1 = (i \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) * width\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n    i_ = i * width\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n    for (int \x3cspan class=\x22hljs-keyword\x22\x3ej \x3c\/span\x3e= \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e; j \x26lt; width_limit; j\x2b\x2b)\x3c\/span\x3e\n    {\n      \x3cspan class=\x22hljs-keyword\x22\x3ej_m1 \x3c\/span\x3e= \x3cspan class=\x22hljs-keyword\x22\x3ej \x3c\/span\x3e- \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3ej_p1 \x3c\/span\x3e= \x3cspan class=\x22hljs-keyword\x22\x3ej \x3c\/span\x3e\x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n      neighbors = current[i_m1 \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej_m1];\n\x3c\/span\x3e      neighbors \x2b= current[i_m1 \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej];\n\x3c\/span\x3e      neighbors \x2b= current[i_m1 \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej_p1];\n\x3c\/span\x3e      neighbors \x2b= current[i_ \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej_m1];\n\x3c\/span\x3e      neighbors \x2b= current[i_ \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej_p1];\n\x3c\/span\x3e      neighbors \x2b= current[i_p1 \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej_m1];\n\x3c\/span\x3e      neighbors \x2b= current[i_p1 \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej];\n\x3c\/span\x3e      neighbors \x2b= current[i_p1 \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej_p1];\n\x3c\/span\x3e      if (neighbors == \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e)\n      {\n        next[i_ \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej] \x3c\/span\x3e= \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n      }\n      else if (neighbors == \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e)\n      {\n        next[i_ \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej] \x3c\/span\x3e= current[i_ \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej];\n\x3c\/span\x3e      }\n      else\n      {\n        next[i_ \x2b \x3cspan class=\x22hljs-keyword\x22\x3ej] \x3c\/span\x3e= \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n      }\n    }\n  }\n  memcpy(current, next, width * height)\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e而对应的 JS 版本引擎的实现为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22computeNextState() {\n  let neighbors, iM1, iP1, i_, jM1, jP1;\n\n  this.loopCurrentState();\n\n  for (let i = 1; i \x3c this._height - 1; i\x2b\x2b) {\n    iM1 = (i - 1) * this._width;\n    iP1 = (i \x2b 1) * this._width;\n    i_ = i * this._width;\n    for (let j = 1; j \x3c this._width - 1; j\x2b\x2b) {\n      jM1 = j - 1;\n      jP1 = j \x2b 1;\n      neighbors = this._current[iM1 \x2b jM1];\n      neighbors \x2b= this._current[iM1 \x2b j];\n      neighbors \x2b= this._current[iM1 \x2b jP1];\n      neighbors \x2b= this._current[i_ \x2b jM1];\n      neighbors \x2b= this._current[i_ \x2b jP1];\n      neighbors \x2b= this._current[iP1 \x2b jM1];\n      neighbors \x2b= this._current[iP1 \x2b j];\n      neighbors \x2b= this._current[iP1 \x2b jP1];\n      if (neighbors === 3) {\n        this._next[i_ \x2b j] = 1;\n      } else if (neighbors === 2) {\n        this._next[i_ \x2b j] = this._current[i_ \x2b j];\n      } else {\n        this._next[i_ \x2b j] = 0;\n      }\n    }\n  }\n  this._current.set(this._next);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3ecomputeNextState() {\n  let neighbors, iM1, iP1, i_, jM1, jP1;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.loopCurrentState();\n\n  \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (let i = \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e; i \x26lt; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._height - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e; i\x2b\x2b) {\n    iM1 = (i - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) * \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._width;\n    iP1 = (i \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) * \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._width;\n    i_ = i * \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._width;\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (let j = \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e; j \x26lt; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._width - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e; j\x2b\x2b) {\n      jM1 = j - \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n      jP1 = j \x2b \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n      neighbors = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current[iM1 \x2b jM1];\n      neighbors \x2b= \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current[iM1 \x2b j];\n      neighbors \x2b= \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current[iM1 \x2b jP1];\n      neighbors \x2b= \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current[i_ \x2b jM1];\n      neighbors \x2b= \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current[i_ \x2b jP1];\n      neighbors \x2b= \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current[iP1 \x2b jM1];\n      neighbors \x2b= \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current[iP1 \x2b j];\n      neighbors \x2b= \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current[iP1 \x2b jP1];\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (neighbors === \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._next[i_ \x2b j] = \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n      } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (neighbors === \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._next[i_ \x2b j] = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current[i_ \x2b j];\n      } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._next[i_ \x2b j] = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n      }\n    }\n  }\n  \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._current.\x3cspan class=\x22hljs-keyword\x22\x3eset\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e._next);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e本部分的编译依旧是直接将 [engine.c]() 编译为 engine.wasm，不过在导入的时候我们需要动态地向 wasm 中注入外部函数：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    this.module = new EngineWASM({\n      env: {\n        memoryBase: 0,\n        tableBase: 0,\n        memory: new window.WebAssembly.Memory({ initial: 1024 }),\n        table: new window.WebAssembly.Table({ initial: 0, element: \x26quot;anyfunc\x26quot; }),\n        _malloc: size =\x3e {\n          let buffer = new ArrayBuffer(size);\n          return new Uint8Array(buffer);\n        },\n        _memcpy: (source, target, size) =\x3e {\n          let sourceEnd = source.byteLength;\n\n          let i, j;\n\n          for (\n            (i = 0), (j = 0), (k = new Uint8Array(target)), (l = new Uint8Array(\n              source\n            ));\n            i \x3c sourceEnd;\n            \x2b\x2bi, \x2b\x2bj\n          )\n            k[j] = l[i];\n        }\n      }\n    });\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.module = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e EngineWASM({\n      \x3cspan class=\x22hljs-attr\x22\x3eenv\x3c\/span\x3e: {\n        \x3cspan class=\x22hljs-attr\x22\x3ememoryBase\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3etableBase\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3ememory\x3c\/span\x3e: \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.WebAssembly.Memory({ \x3cspan class=\x22hljs-attr\x22\x3einitial\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e1024\x3c\/span\x3e }),\n        \x3cspan class=\x22hljs-attr\x22\x3etable\x3c\/span\x3e: \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.WebAssembly.Table({ \x3cspan class=\x22hljs-attr\x22\x3einitial\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3eelement\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22anyfunc\x22\x3c\/span\x3e }),\n        \x3cspan class=\x22hljs-attr\x22\x3e_malloc\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3esize\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n          \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e buffer = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eArrayBuffer\x3c\/span\x3e(size);\n          \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eUint8Array\x3c\/span\x3e(buffer);\n        },\n        \x3cspan class=\x22hljs-attr\x22\x3e_memcpy\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3esource, target, size\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n          \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e sourceEnd = source.byteLength;\n\n          \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e i, j;\n\n          \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\n            (i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e), (j = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e), (k = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eUint8Array\x3c\/span\x3e(target)), (l = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eUint8Array\x3c\/span\x3e(\n              source\n            ));\n            i \x26lt; sourceEnd;\n            \x2b\x2bi, \x2b\x2bj\n          )\n            k[j] = l[i];\n        }\n      }\n    });\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e到这里文本告一段落，笔者最后需要声明的是因为这只是随手做的实验，最后的代码包括对于内存的操作可能存在潜在问题，请读者批评指正。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>WebAssembly 初体验：从零开始重构计算模块</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000009792801">https://segmentfault.com/a/1190000009792801</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/o8xqfd9kkt/" target="_blank">https://alili.tech/archive/o8xqfd9kkt/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5fmk2pl6rab/">2016年前端开发者深度调研，看看别人使用什么技术体系<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/stp6408xnu/">Bootstrap使用模态框modal实现表单提交弹出框<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/fu7a86e9uyh/">CSS水平垂直居中总结<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/r0w29esklr/">JS 里怎么给数组填充默认值<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/i00hiszlr1/">JavaScript - EventEmitter 背后的秘密<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/u2la0cn9do/">JavaScript 精度丢失问题<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/3txhfn3ejcb/">Nodejs进阶：如何玩转子进程（child_process）<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/yr7v8e9fao/">Promise介绍--规范篇<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/9lyxyz4wc6g/">QQ音乐API整理<aside class="dates">2019-01-30</aside></a></li><li><a href="/archive/84zzlljmes4/">SegmentFault 技术周刊 Vol.14 - 进阶 Vue 2.0<aside class="dates">2019-01-30</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>