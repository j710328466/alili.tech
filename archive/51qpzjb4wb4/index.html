<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="开发一个 Linux 调试器（二）：断点"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>开发一个 Linux 调试器（二）：断点 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/51qpzjb4wb4/",
				"appid": "1613049289050283", 
				"title": "开发一个 Linux 调试器（二）：断点 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-22T02:30:08"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/uve8csz5yro/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/5kgm1r8chuv/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f&text=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%96%ad%e7%82%b9"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f&text=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%96%ad%e7%82%b9"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%96%ad%e7%82%b9"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f&is_video=false&description=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%96%ad%e7%82%b9"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%96%ad%e7%82%b9&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%96%ad%e7%82%b9"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%96%ad%e7%82%b9"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%96%ad%e7%82%b9"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f51qpzjb4wb4%2f&title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%20Linux%20%e8%b0%83%e8%af%95%e5%99%a8%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%96%ad%e7%82%b9"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">开发一个 Linux 调试器（二）：断点</h1><div class="meta"><div class="postdate"><time datetime="2019-01-22" itemprop="datePublished">2019-01-22</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n            \x3ch1\x3e\x3ca href=\x22#开发一个-linux-调试器二断点\x22\x3e\x3c\/a\x3e开发一个 Linux 调试器（二）：断点\x3c\/h1\x3e\n\x3cp\x3e在该系列的第一部分，我们写了一个小的进程启动器，作为我们调试器的基础。在这篇博客中，我们会学习在 x86 Linux 上断点是如何工作的，以及如何给我们工具添加设置断点的能力。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#系列文章索引\x22\x3e\x3c\/a\x3e系列文章索引\x3c\/h3\x3e\n\x3cp\x3e随着后面文章的发布，这些链接会逐渐生效。\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/linux.cn\/article-8626-1.html\x22\x3e准备环境\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/github.com\/TartanLlama\/minidbg\/tree\/tut_break\x22\x3e断点\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e寄存器和内存\x3c\/li\x3e\n\x3cli\x3eElves 和 dwarves\x3c\/li\x3e\n\x3cli\x3e源码和信号\x3c\/li\x3e\n\x3cli\x3e源码层逐步执行\x3c\/li\x3e\n\x3cli\x3e源码层断点\x3c\/li\x3e\n\x3cli\x3e调用栈\x3c\/li\x3e\n\x3cli\x3e读取变量 10.之后步骤\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch3\x3e\x3ca href=\x22#断点是如何形成的\x22\x3e\x3c\/a\x3e断点是如何形成的？\x3c\/h3\x3e\n\x3cp\x3e有两种类型的断点：硬件和软件。硬件断点通常涉及到设置与体系结构相关的寄存器来为你产生断点，而软件断点则涉及到修改正在执行的代码。在这篇文章中我们只会关注软件断点，因为它们比较简单，而且可以设置任意多断点。在 x86 机器上任一时刻你最多只能有 4 个硬件断点，但是它们能让你在读取或者写入给定地址时触发，而不是只有当代码执行到那里的时候。\x3c\/p\x3e\n\x3cp\x3e我前面说软件断点是通过修改正在执行的代码实现的，那么问题就来了：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e我们如何修改代码？\x3c\/li\x3e\n\x3cli\x3e为了设置断点我们要做什么修改？\x3c\/li\x3e\n\x3cli\x3e如何告知调试器？\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e第一个问题的答案显然是 \x3ccode\x3eptrace\x3c\/code\x3e。我们之前已经用它为我们的程序设置跟踪并继续程序的执行，但我们也可以用它来读或者写内存。\x3c\/p\x3e\n\x3cp\x3e当执行到断点时，我们的更改要让处理器暂停并给程序发送信号。在 x86 机器上这是通过 \x3ccode\x3eint 3\x3c\/code\x3e 重写该地址上的指令实现的。x86 机器有个中断向量表（interrupt vector table），操作系统能用它来为多种事件注册处理程序，例如页故障、保护故障和无效操作码。它就像是注册错误处理回调函数，但是是在硬件层面的。当处理器执行 \x3ccode\x3eint 3\x3c\/code\x3e 指令时，控制权就被传递给断点中断处理器，对于 Linux 来说，就是给进程发送 \x3ccode\x3eSIGTRAP\x3c\/code\x3e 信号。你可以在下图中看到这个进程，我们用 \x3ccode\x3e0xcc\x3c\/code\x3e 覆盖了 \x3ccode\x3emov\x3c\/code\x3e 指令的第一个字节，它是 \x3ccode\x3einit 3\x3c\/code\x3e 的指令代码。\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/camo.githubusercontent.com\/16fd4bb6d9b7f425fd25c7363397887f062f16c6\/687474703a2f2f626c6f672e74617274616e6c6c616d612e78797a2f6173736574732f627265616b706f696e742e706e67\x22\x3e\x3cimg src=\x22https:\/\/p0.ssl.qhimg.com\/t013dc58426e9891f6d.png\x22 alt=\x22断点\x22\x3e\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e谜题的最后一个部分是调试器如何被告知中断的。如果你回顾前面的文章，我们可以用 \x3ccode\x3ewaitpid\x3c\/code\x3e 来监听被发送给被调试的程序的信号。这里我们也可以这样做：设置断点、继续执行程序、调用 \x3ccode\x3ewaitpid\x3c\/code\x3e 并等待直到发生 \x3ccode\x3eSIGTRAP\x3c\/code\x3e。然后就可以通过打印已运行到的源码位置、或改变有图形用户界面的调试器中关注的代码行，将这个断点传达给用户。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#实现软件断点\x22\x3e\x3c\/a\x3e实现软件断点\x3c\/h3\x3e\n\x3cp\x3e我们会实现一个 \x3ccode\x3ebreakpoint\x3c\/code\x3e 类来表示某个位置的断点，我们可以根据需要启用或者停用该断点。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs java\x22\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ebreakpoint\x3c\/span\x3e \x3c\/span\x3e{\n\x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e:\n    breakpoint(pid_t pid, std::intptr_t addr)\n        : m_pid{pid}, m_addr{addr}, m_enabled{\x3cspan class=\x22hljs-keyword\x22\x3efalse\x3c\/span\x3e}, m_saved_data{}\n    {}\n\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eenable\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3edisable\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-function\x22\x3eauto \x3cspan class=\x22hljs-title\x22\x3eis_enabled\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e -\x26gt; bool \x3c\/span\x3e{ \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e m_enabled; }\n    \x3cspan class=\x22hljs-function\x22\x3eauto \x3cspan class=\x22hljs-title\x22\x3eget_address\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e -\x26gt; std::intptr_t \x3c\/span\x3e{ \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e m_addr; }\n\n\x3cspan class=\x22hljs-keyword\x22\x3eprivate\x3c\/span\x3e:\n    pid_t m_pid;\n    std::intptr_t m_addr;\n    bool m_enabled;\n    uint64_t m_saved_data; \x3cspan class=\x22hljs-comment\x22\x3e\/\/data which used to be at the breakpoint address\x3c\/span\x3e\n};\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这里的大部分代码都是跟踪状态；真正神奇的地方是 \x3ccode\x3eenable\x3c\/code\x3e 和 \x3ccode\x3edisable\x3c\/code\x3e 函数。\x3c\/p\x3e\n\x3cp\x3e正如我们上面学到的，我们要用 \x3ccode\x3eint 3\x3c\/code\x3e 指令 - 编码为 \x3ccode\x3e0xcc\x3c\/code\x3e - 替换当前指定地址的指令。我们还要保存该地址之前的值，以便后面恢复该代码；我们不想忘了执行用户（原来）的代码。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e breakpoint::enable() {\n    m_saved_data = ptrace(PTRACE_PEEKDATA, m_pid, m_addr, \x3cspan class=\x22hljs-literal\x22\x3enullptr\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3euint64_t\x3c\/span\x3e int3 = \x3cspan class=\x22hljs-number\x22\x3e0xcc\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3euint64_t\x3c\/span\x3e data_with_int3 = ((m_saved_data \x26amp; ~\x3cspan class=\x22hljs-number\x22\x3e0xff\x3c\/span\x3e) | int3); \x3cspan class=\x22hljs-comment\x22\x3e\/\/set bottom byte to 0xcc\x3c\/span\x3e\n    ptrace(PTRACE_POKEDATA, m_pid, m_addr, data_with_int3);\n\n    m_enabled = \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e\x3ccode\x3ePTRACE_PEEKDATA\x3c\/code\x3e 请求告知 \x3ccode\x3eptrace\x3c\/code\x3e 如何读取被跟踪进程的内存。我们给它一个进程 ID 和一个地址，然后它返回给我们该地址当前的 64 位内容。 \x3ccode\x3e(m_saved_data \x26amp; ~0xff)\x3c\/code\x3e 把这个数据的低位字节置零，然后我们用它和我们的 \x3ccode\x3eint 3\x3c\/code\x3e 指令按位或（\x3ccode\x3eOR\x3c\/code\x3e）来设置断点。最后我们通过 \x3ccode\x3ePTRACE_POKEDATA\x3c\/code\x3e 用我们的新数据覆盖那部分内存来设置断点。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3edisable\x3c\/code\x3e 的实现比较简单，我们只需要恢复用 \x3ccode\x3e0xcc\x3c\/code\x3e 所覆盖的原始数据。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e breakpoint::disable() {\n    ptrace(PTRACE_POKEDATA, m_pid, m_addr, m_saved_data);\n    m_enabled = \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3ch3\x3e\x3ca href=\x22#在调试器中增加断点\x22\x3e\x3c\/a\x3e在调试器中增加断点\x3c\/h3\x3e\n\x3cp\x3e为了支持通过用户界面设置断点，我们要在 debugger 类修改三个地方：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e给 \x3ccode\x3edebugger\x3c\/code\x3e 添加断点存储数据结构\x3c\/li\x3e\n\x3cli\x3e添加 \x3ccode\x3eset_breakpoint_at_address\x3c\/code\x3e 函数\x3c\/li\x3e\n\x3cli\x3e给我们的 \x3ccode\x3ehandle_command\x3c\/code\x3e 函数添加 \x3ccode\x3ebreak\x3c\/code\x3e 命令\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e我会将我的断点保存到 \x3ccode\x3estd::unordered_map\x26lt;std::intptr_t, breakpoint\x26gt;\x3c\/code\x3e 结构，以便能简单快速地判断一个给定的地址是否有断点，如果有的话，取回该 breakpoint 对象。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3edebugger\x3c\/span\x3e {\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eset_breakpoint_at_address\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-keyword\x22\x3eintptr_t\x3c\/span\x3e addr)\x3c\/span\x3e\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eprivate\x3c\/span\x3e:\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/...\x3c\/span\x3e\n    \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3eunordered_map\x3c\/span\x3e\x26lt;\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-keyword\x22\x3eintptr_t\x3c\/span\x3e,breakpoint\x26gt; m_breakpoints;\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e在 \x3ccode\x3eset_breakpoint_at_address\x3c\/code\x3e 函数中我们会新建一个 breakpoint 对象，启用它，把它添加到数据结构里，并给用户打印一条信息。如果你喜欢的话，你可以重构所有的输出信息，从而你可以将调试器作为库或者命令行工具使用，为了简便，我把它们都整合到了一起。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e debugger::set_breakpoint_at_address(\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-keyword\x22\x3eintptr_t\x3c\/span\x3e addr) {\n    \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3ecout\x3c\/span\x3e \x26lt;\x26lt; \x3cspan class=\x22hljs-string\x22\x3e\x22Set breakpoint at address 0x\x22\x3c\/span\x3e \x26lt;\x26lt; \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::hex \x26lt;\x26lt; addr \x26lt;\x26lt; \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3eendl\x3c\/span\x3e;\n    breakpoint bp {m_pid, addr};\n    bp.enable();\n    m_breakpoints[addr] = bp;\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e现在我们会在我们的命令处理程序中增加对我们新函数的调用。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e debugger::handle_command(\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e\x26amp; line) {\n    \x3cspan class=\x22hljs-keyword\x22\x3eauto\x3c\/span\x3e args = split(line,\x3cspan class=\x22hljs-string\x22\x3e\x27 \x27\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3eauto\x3c\/span\x3e command = args[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e];\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (is_prefix(command, \x3cspan class=\x22hljs-string\x22\x3e\x22cont\x22\x3c\/span\x3e)) {\n        continue_execution();\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(is_prefix(command, \x3cspan class=\x22hljs-string\x22\x3e\x22break\x22\x3c\/span\x3e)) {\n        \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3estring\x3c\/span\x3e addr {args[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e], \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e}; \x3cspan class=\x22hljs-comment\x22\x3e\/\/naively assume that the user has written 0xADDRESS\x3c\/span\x3e\n        set_breakpoint_at_address(\x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::stol(addr, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e16\x3c\/span\x3e));\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3estd\x3c\/span\x3e::\x3cspan class=\x22hljs-built_in\x22\x3ecerr\x3c\/span\x3e \x26lt;\x26lt; \x3cspan class=\x22hljs-string\x22\x3e\x22Unknown command\\n\x22\x3c\/span\x3e;\n    }\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e我删除了字符串中的前两个字符并对结果调用 \x3ccode\x3estd::stol\x3c\/code\x3e，你也可以让该解析更健壮一些。\x3ccode\x3estd::stol\x3c\/code\x3e 可以将字符串按照所给基数转化为整数。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#从断点继续执行\x22\x3e\x3c\/a\x3e从断点继续执行\x3c\/h3\x3e\n\x3cp\x3e如果你尝试这样做，你可能会发现，如果你从断点处继续执行，不会发生任何事情。这是因为断点仍然在内存中，因此一直被重复命中。简单的解决办法就是停用这个断点、运行到下一步、再次启用这个断点、然后继续执行。不过我们还需要更改程序计数器，指回到断点前面，这部分内容会留到下一篇关于操作寄存器的文章中介绍。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#测试它\x22\x3e\x3c\/a\x3e测试它\x3c\/h3\x3e\n\x3cp\x3e当然，如果你不知道要在哪个地址设置，那么在某些地址设置断点并非很有用。后面我们会学习如何在函数名或者代码行设置断点，但现在我们可以通过手动实现。\x3c\/p\x3e\n\x3cp\x3e测试你调试器的简单方法是写一个 hello world 程序，这个程序输出到 \x3ccode\x3estd::err\x3c\/code\x3e（为了避免缓存），并在调用输出操作符的地方设置断点。如果你继续执行被调试的程序，执行很可能会停止而不会输出任何东西。然后你可以重启调试器并在调用之后设置一个断点，现在你应该看到成功地输出了消息。\x3c\/p\x3e\n\x3cp\x3e查找地址的一个方法是使用 \x3ccode\x3eobjdump\x3c\/code\x3e。如果你打开一个终端并执行 \x3ccode\x3eobjdump -d \x26lt;your program\x26gt;\x3c\/code\x3e，然后你应该看到你的程序的反汇编代码。你就可以找到 \x3ccode\x3emain\x3c\/code\x3e 函数并定位到你想设置断点的 \x3ccode\x3ecall\x3c\/code\x3e 指令。例如，我编译了一个 hello world 程序，反汇编它，然后得到了如下的 \x3ccode\x3emain\x3c\/code\x3e 的反汇编代码：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs perl\x22\x3e\x3cspan class=\x22hljs-number\x22\x3e0000000000400\x3c\/span\x3e936 \x26lt;main\x26gt;:\n  \x3cspan class=\x22hljs-number\x22\x3e400936\x3c\/span\x3e:    \x3cspan class=\x22hljs-number\x22\x3e55\x3c\/span\x3e                       \x3cspan class=\x22hljs-keyword\x22\x3epush\x3c\/span\x3e   %rbp\n  \x3cspan class=\x22hljs-number\x22\x3e400937\x3c\/span\x3e:    \x3cspan class=\x22hljs-number\x22\x3e48\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e89\x3c\/span\x3e e5                 mov    %rsp,%rbp\n  \x3cspan class=\x22hljs-number\x22\x3e40093\x3c\/span\x3ea:    be \x3cspan class=\x22hljs-number\x22\x3e35\x3c\/span\x3e 0a \x3cspan class=\x22hljs-number\x22\x3e40\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e00\x3c\/span\x3e           mov    $0x400a35,%esi\n  \x3cspan class=\x22hljs-number\x22\x3e40093\x3c\/span\x3ef:    bf \x3cspan class=\x22hljs-number\x22\x3e60\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e60\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e00\x3c\/span\x3e           mov    $0x60106\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,%edi\n  \x3cspan class=\x22hljs-number\x22\x3e400944\x3c\/span\x3e:    e8 d7 fe ff ff           callq  \x3cspan class=\x22hljs-number\x22\x3e400820\x3c\/span\x3e \x26lt;_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@plt\x26gt;\n  \x3cspan class=\x22hljs-number\x22\x3e400949\x3c\/span\x3e:    b8 \x3cspan class=\x22hljs-number\x22\x3e00\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e00\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e00\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e00\x3c\/span\x3e           mov    $0\x3cspan class=\x22hljs-keyword\x22\x3ex\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e,%eax\n  \x3cspan class=\x22hljs-number\x22\x3e40094\x3c\/span\x3ee:    \x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3ed                       \x3cspan class=\x22hljs-keyword\x22\x3epop\x3c\/span\x3e    %rbp\n  \x3cspan class=\x22hljs-number\x22\x3e40094\x3c\/span\x3ef:    c3                       retq\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e正如你看到的，要没有输出，我们要在 \x3ccode\x3e0x400944\x3c\/code\x3e 设置断点，要看到输出，要在 \x3ccode\x3e0x400949\x3c\/code\x3e 设置断点。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#总结\x22\x3e\x3c\/a\x3e总结\x3c\/h3\x3e\n\x3cp\x3e现在你应该有了一个可以启动程序、允许在内存地址上设置断点的调试器。后面我们会添加读写内存和寄存器的功能。再次说明，如果你有任何问题请在评论框中告诉我。\x3c\/p\x3e\n\x3cp\x3e你可以在\x3ca href=\x22https:\/\/github.com\/TartanLlama\/minidbg\/tree\/tut_break\x22\x3e这里\x3c\/a\x3e 找到该项目的代码。\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3evia: \x3ca href=\x22http:\/\/blog.tartanllama.xyz\/c\x2b\x2b\/2017\/03\/24\/writing-a-linux-debugger-breakpoints\/\x22\x3ehttp:\/\/blog.tartanllama.xyz\/c\x2b\x2b\/2017\/03\/24\/writing-a-linux-debugger-breakpoints\/\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e作者：\x3ca href=\x22http:\/\/blog.tartanllama.xyz\/\x22\x3eSimon Brand\x3c\/a\x3e 译者：\x3ca href=\x22https:\/\/github.com\/ictlyh\x22\x3eictlyh\x3c\/a\x3e 校对：\x3ca href=\x22https:\/\/github.com\/jasminepeng\x22\x3ejasminepeng\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e本文由 \x3ca href=\x22https:\/\/github.com\/LCTT\/TranslateProject\x22\x3eLCTT\x3c\/a\x3e 原创编译，\x3ca href=\x22https:\/\/linux.cn\/\x22\x3eLinux中国\x3c\/a\x3e 荣誉推出\x3c\/p\x3e\n\n          \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>开发一个 Linux 调试器（二）：断点</p><h2 id="原文链接">原文链接</h2><p><a href="https://www.zcfy.cc/article/writing-a-linux-debugger-part-2-breakpoints">https://www.zcfy.cc/article/writing-a-linux-debugger-part-2-breakpoints</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/51qpzjb4wb4/" target="_blank">https://alili.tech/archive/51qpzjb4wb4/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5x6tenwjeux/">ES6中的异步编程：Generators函数&#43;Promise:最强大的异步处理方式<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/nvtmua2a1hd/">GreenSock (TweenMax) 极简入门指南<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/7kt5s47oysx/">HTML5 中 canvas 的使用总结<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/41pgo3a2iyp/">JavaScript 开发者所需要知道的 V8（一）：V8 In NodeJS<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/krb1zm7x38j/">JavaScript 时间与日期处理实战:你肯定被坑过<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/yh2lq30d0x/">JavaScript中的各种宽高属性<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/eydwczesyv/">Muse UI — 基于 Vue2.0 的 Material Design UI 库<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/y62oejm8cr/">Nodejs基础：路径处理模块path总结<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/06cwh88ankmd/">PhantomJS &amp; NodeJS 在京东网站前端监控平台的最佳实践<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/z4ymvs0jz2h/">Promise 的链式调用与中止<aside class="dates">2019-01-31</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>