<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="如何实现一个基于 DOM 的模板引擎"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>如何实现一个基于 DOM 的模板引擎 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/mxmhvbsens/",
				"appid": "1613049289050283", 
				"title": "如何实现一个基于 DOM 的模板引擎 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-05T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/kiy6zx9pwm/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/x1fuparr8ns/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f&text=%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%20DOM%20%e7%9a%84%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f&text=%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%20DOM%20%e7%9a%84%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f&title=%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%20DOM%20%e7%9a%84%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f&is_video=false&description=%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%20DOM%20%e7%9a%84%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%20DOM%20%e7%9a%84%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f&title=%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%20DOM%20%e7%9a%84%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f&title=%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%20DOM%20%e7%9a%84%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f&title=%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%20DOM%20%e7%9a%84%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fmxmhvbsens%2f&title=%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e5%9f%ba%e4%ba%8e%20DOM%20%e7%9a%84%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">如何实现一个基于 DOM 的模板引擎</h1><div class="meta"><div class="postdate"><time datetime="2019-01-05" itemprop="datePublished">2019-01-05</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVSspq?w=4000\x26amp;h=2670\x22 src=\x22https:\/\/static.alili.tech\/img\/bVSspq?w=4000\x26amp;h=2670\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e题图：\x3ca href=\x22https:\/\/unsplash.com\/photos\/ISI5DlnYvuY\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eVincent Guth\x3c\/a\x3e\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e注：本文所有代码均可在本人的个人项目\x3ca href=\x22https:\/\/github.com\/colonjs\/colon\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ecolon\x3c\/a\x3e中找到，本文也同步到了\x3ca href=\x22https:\/\/zhuanlan.zhihu.com\/p\/28376182\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e知乎专栏\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e可能你已经体会到了 \x3ccode\x3eVue\x3c\/code\x3e 所带来的便捷了，相信有一部分原因也是因为其基于 DOM 的语法简洁的模板渲染引擎。这篇文章将会介绍如何实现一个基于 DOM 的模板引擎（就像 \x3ccode\x3eVue\x3c\/code\x3e 的模板引擎一样）。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3ePreface\x3c\/h2\x3e\n\x3cp\x3e开始之前，我们先来看一下最终的效果：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const compiled = Compile(`\x3ch1\x3eHey ?, \x22{{\x22 greeting \x22}}\x22\x3c\/h1\x3e`, {\n    greeting: `Hello World`,\n});\ncompiled.view \/\/ =\x3e `\x3ch1\x3eHey ?, Hello World\x3c\/h1\x3e`\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiled = Compile(\x3cspan class=\x22hljs-string\x22\x3e`\x26lt;h1\x26gt;Hey ?, \x22{{\x22 greeting \x22}}\x22\x26lt;\/h1\x26gt;`\x3c\/span\x3e, {\n    \x3cspan class=\x22hljs-attr\x22\x3egreeting\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`Hello World`\x3c\/span\x3e,\n});\ncompiled.view \x3cspan class=\x22hljs-comment\x22\x3e\/\/ =\x26gt; `\x26lt;h1\x26gt;Hey ?, Hello World\x26lt;\/h1\x26gt;`\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eCompile\x3c\/h2\x3e\n\x3cp\x3e实现一个模板引擎实际上就是实现一个编译器，就像这样：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const compiled = Compile(template: String|Node, data: Object);\ncompiled.view \/\/ =\x3e compiled template\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiled = Compile(template: \x3cspan class=\x22hljs-built_in\x22\x3eString\x3c\/span\x3e|Node, \x3cspan class=\x22hljs-attr\x22\x3edata\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e);\ncompiled.view \x3cspan class=\x22hljs-comment\x22\x3e\/\/ =\x26gt; compiled template\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e首先，让我们来看下 \x3ccode\x3eCompile\x3c\/code\x3e 内部是如何实现的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ compile.js\n\/**\n * template compiler\n *\n * @param {String|Node} template\n * @param {Object} data\n *\/\nfunction Compile(template, data) {\n    if (!(this instanceof Compile)) return new Compile(template, data);\n\n    this.options = {};\n    this.data = data;\n\n    if (template instanceof Node) {\n        this.options.template = template;\n    } else if (typeof template === \x27string\x27) {\n        this.options.template = domify(template);\n    } else {\n        console.error(`\x26quot;template\x26quot; only accept DOM node or string template`);\n    }\n\n    template = this.options.template;\n\n    walk(template, (node, next) =\x3e {\n        if (node.nodeType === 1) {\n            \/\/ compile element node\n            this.compile.elementNodes.call(this, node);\n            return next();\n        } else if (node.nodeType === 3) {\n            \/\/ compile text node\n            this.compile.textNodes.call(this, node);\n        }\n        next();\n    });\n\n    this.view = template;\n    template = null;\n}\n\nCompile.compile = {};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ compile.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * template compiler\n *\n * @param {String|Node} template\n * @param {Object} data\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eCompile\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3etemplate, data\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3einstanceof\x3c\/span\x3e Compile)) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Compile(template, data);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.options = {};\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.data = data;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (template \x3cspan class=\x22hljs-keyword\x22\x3einstanceof\x3c\/span\x3e Node) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.options.template = template;\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e template === \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.options.template = domify(template);\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.error(\x3cspan class=\x22hljs-string\x22\x3e`\x22template\x22 only accept DOM node or string template`\x3c\/span\x3e);\n    }\n\n    template = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.options.template;\n\n    walk(template, (node, next) =\x26gt; {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (node.nodeType === \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ compile element node\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.compile.elementNodes.call(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, node);\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next();\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (node.nodeType === \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ compile text node\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.compile.textNodes.call(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, node);\n        }\n        next();\n    });\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.view = template;\n    template = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n}\n\nCompile.compile = {};\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3ewalk\x3c\/h3\x3e\n\x3cp\x3e通过上面的代码，可以看到 \x3ccode\x3eCompile\x3c\/code\x3e 的构造函数主要就是做了一件事 ———— 遍历 \x3ccode\x3etemplate\x3c\/code\x3e，然后通过判断节点类型的不同来做不同的编译操作，这里就不介绍如何遍历 \x3ccode\x3etemplate\x3c\/code\x3e 了，不明白的话可以直接看 \x3ccode\x3ewalk\x3c\/code\x3e \x3ca href=\x22https:\/\/github.com\/colonjs\/colon\/blob\/master\/src\/compile\/walk.js\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e函数的源码\x3c\/a\x3e，我们着重来看下如何编译这些不同类型的节点，以编译 \x3ccode\x3enode.nodeType === 1\x3c\/code\x3e 的元素节点为例：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/**\n * compile element node\n *\n * @param {Node} node\n *\/\nCompile.compile.elementNodes = function (node) {\n    const bindSymbol = `:`;\n    let attributes = [].slice.call(node.attributes),\n        attrName = ``,\n        attrValue = ``,\n        directiveName = ``;\n\n    attributes.map(attribute =\x3e {\n        attrName = attribute.name;\n        attrValue = attribute.value.trim();\n\n        if (attrName.indexOf(bindSymbol) === 0 \x26amp;\x26amp; attrValue !== \x27\x27) {\n            directiveName = attrName.slice(bindSymbol.length);\n\n            this.bindDirective({\n                node,\n                expression: attrValue,\n                name: directiveName,\n            });\n            node.removeAttribute(attrName);\n        } else {\n            this.bindAttribute(node, attribute);\n        }\n    });\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * compile element node\n *\n * @param {Node} node\n *\/\x3c\/span\x3e\nCompile.compile.elementNodes = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3enode\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e bindSymbol = \x3cspan class=\x22hljs-string\x22\x3e`:`\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e attributes = [].slice.call(node.attributes),\n        attrName = \x3cspan class=\x22hljs-string\x22\x3e``\x3c\/span\x3e,\n        attrValue = \x3cspan class=\x22hljs-string\x22\x3e``\x3c\/span\x3e,\n        directiveName = \x3cspan class=\x22hljs-string\x22\x3e``\x3c\/span\x3e;\n\n    attributes.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eattribute\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        attrName = attribute.name;\n        attrValue = attribute.value.trim();\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (attrName.indexOf(bindSymbol) === \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \x26amp;\x26amp; attrValue !== \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e) {\n            directiveName = attrName.slice(bindSymbol.length);\n\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.bindDirective({\n                node,\n                \x3cspan class=\x22hljs-attr\x22\x3eexpression\x3c\/span\x3e: attrValue,\n                \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: directiveName,\n            });\n            node.removeAttribute(attrName);\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.bindAttribute(node, attribute);\n        }\n    });\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e噢忘记说了，这里我参考了 \x3ccode\x3eVue\x3c\/code\x3e 的指令语法，就是在带有冒号 \x3ccode\x3e:\x3c\/code\x3e 的属性名中（当然这里也可以是任何其他你所喜欢的符号），可以直接写 JavaScript 的表达式，然后也会提供几个特殊的指令，例如 \x3ccode\x3e:text\x3c\/code\x3e, \x3ccode\x3e:show\x3c\/code\x3e 等等来对元素做一些不同的操作。\x3c\/p\x3e\n\x3cp\x3e其实该函数只做了两件事：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e遍历该节点的所有属性，通过判断属性类型的不同来做不同的操作，判断的标准就是属性名是否是冒号 \x3ccode\x3e:\x3c\/code\x3e 开头并且属性的值不为空；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e绑定相应的指令去更新属性。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3eDirective\x3c\/h2\x3e\n\x3cp\x3e其次，再看一下 \x3ccode\x3eDirective\x3c\/code\x3e 内部是如何实现的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import directives from \x27.\/directives\x27;\nimport { generate } from \x27.\/compile\/generate\x27;\n\nexport default function Directive(options = {}) {\n    Object.assign(this, options);\n    Object.assign(this, directives[this.name]);\n    this.beforeUpdate \x26amp;\x26amp; this.beforeUpdate();\n    this.update \x26amp;\x26amp; this.update(generate(this.expression)(this.compile.options.data));\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e directives \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/directives\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { generate } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/compile\/generate\x27\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eDirective\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eoptions = {}\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, options);\n    \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, directives[\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.name]);\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.beforeUpdate \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.beforeUpdate();\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.update \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.update(generate(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.expression)(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.compile.options.data));\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3eDirective\x3c\/code\x3e 做了三件事：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e注册指令（\x3ccode\x3eObject.assign(this, directives[this.name])\x3c\/code\x3e）；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e计算指令表达式的实际值（\x3ccode\x3egenerate(this.expression)(this.compile.options.data)\x3c\/code\x3e）；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e把计算出来的实际值更新到 DOM 上面(\x3ccode\x3ethis.update()\x3c\/code\x3e)。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e在介绍指令之前，先看一下它的用法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Compile.prototype.bindDirective = function (options) {\n    new Directive({\n        ...options,\n        compile: this,\n    });\n};\n\nCompile.prototype.bindAttribute = function (node, attribute) {\n    if (!hasInterpolation(attribute.value) || attribute.value.trim() == \x27\x27) return false;\n\n    this.bindDirective({\n        node,\n        name: \x27attribute\x27,\n        expression: parse.text(attribute.value),\n        attrName: attribute.name,\n    });\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eCompile.prototype.bindDirective = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eoptions\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Directive({\n        ...options,\n        \x3cspan class=\x22hljs-attr\x22\x3ecompile\x3c\/span\x3e: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e,\n    });\n};\n\nCompile.prototype.bindAttribute = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3enode, attribute\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!hasInterpolation(attribute.value) || attribute.value.trim() == \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.bindDirective({\n        node,\n        \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27attribute\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3eexpression\x3c\/span\x3e: parse.text(attribute.value),\n        \x3cspan class=\x22hljs-attr\x22\x3eattrName\x3c\/span\x3e: attribute.name,\n    });\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3ebindDirective\x3c\/code\x3e 对 \x3ccode\x3eDirective\x3c\/code\x3e 做了一个非常简单的封装，接受三个必填属性：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3enode\x3c\/code\x3e: 当前所编译的节点，在 \x3ccode\x3eDirective\x3c\/code\x3e 的 \x3ccode\x3eupdate\x3c\/code\x3e 方法中用来更新当前节点；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3ename\x3c\/code\x3e: 当前所绑定的指令名称，用来区分具体使用哪个指令更新器来更新视图；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eexpression\x3c\/code\x3e: parse 之后的 JavaScript 的表达式。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3eupdater\x3c\/h3\x3e\n\x3cp\x3e在 \x3ccode\x3eDirective\x3c\/code\x3e 内部我们通过 \x3ccode\x3eObject.assign(this, directives[this.name]);\x3c\/code\x3e 来注册不同的指令，所以变量 \x3ccode\x3edirectives\x3c\/code\x3e 的值可能是这样的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ directives\nexport default {\n    \/\/ directive `:show`\n    show: {\n        beforeUpdate() {},\n        update(show) {\n            this.node.style.display = show ? `block` : `none`;\n        },\n    },\n    \/\/ directive `:text`\n    text: {\n        beforeUpdate() {},\n        update(value) {\n            \/\/ ...\n        },\n    },\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ directives\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ directive `:show`\x3c\/span\x3e\n    show: {\n        beforeUpdate() {},\n        update(show) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.node.style.display = show ? \x3cspan class=\x22hljs-string\x22\x3e`block`\x3c\/span\x3e : \x3cspan class=\x22hljs-string\x22\x3e`none`\x3c\/span\x3e;\n        },\n    },\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ directive `:text`\x3c\/span\x3e\n    text: {\n        beforeUpdate() {},\n        update(value) {\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n        },\n    },\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e所以假设某个指令的名字是 \x3ccode\x3eshow\x3c\/code\x3e 的话，那么 \x3ccode\x3eObject.assign(this, directives[this.name]);\x3c\/code\x3e 就等同于：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Object.assign(this, {\n    beforeUpdate() {},\n    update(show) {\n        this.node.style.display = show ? `block` : `none`;\n    },\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, {\n    beforeUpdate() {},\n    update(show) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.node.style.display = show ? \x3cspan class=\x22hljs-string\x22\x3e`block`\x3c\/span\x3e : \x3cspan class=\x22hljs-string\x22\x3e`none`\x3c\/span\x3e;\n    },\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e表示对于指令 \x3ccode\x3eshow\x3c\/code\x3e，指令更新器会改变该元素 \x3ccode\x3estyle\x3c\/code\x3e 的 \x3ccode\x3edisplay\x3c\/code\x3e 值，从而实现对应的功能。所以你会发现，整个编译器结构设计好后，如果我们要拓展功能的话，只需简单地编写指令的更新器即可，这里再以指令 \x3ccode\x3etext\x3c\/code\x3e 举个例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ directives\nexport default {\n    \/\/ directive `:show`\n    \/\/ show: { ... },\n    \/\/ directive `:text`\n    text: {\n        update(value) {\n            this.node.textContent = value;\n        },\n    },\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ directives\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ directive `:show`\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ show: { ... },\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ directive `:text`\x3c\/span\x3e\n    text: {\n        update(value) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.node.textContent = value;\n        },\n    },\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e有没有发现编写一个指令其实非常的简单，然后我们就可以这么使用我们的 \x3ccode\x3etext\x3c\/code\x3e 指令了：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const compiled = Compile(`\x3ch1 :text=\x26quot;\x27Hey ?, \x27 \x2b greeting\x26quot;\x3e\x3c\/h1\x3e`, {\n    greeting: `Hello World`,\n});\ncompiled.view \/\/ =\x3e `\x3ch1\x3eHey ?, Hello World\x3c\/h1\x3e`\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiled = Compile(\x3cspan class=\x22hljs-string\x22\x3e`\x26lt;h1 :text=\x22\x27Hey ?, \x27 \x2b greeting\x22\x26gt;\x26lt;\/h1\x26gt;`\x3c\/span\x3e, {\n    \x3cspan class=\x22hljs-attr\x22\x3egreeting\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`Hello World`\x3c\/span\x3e,\n});\ncompiled.view \x3cspan class=\x22hljs-comment\x22\x3e\/\/ =\x26gt; `\x26lt;h1\x26gt;Hey ?, Hello World\x26lt;\/h1\x26gt;`\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3egenerate\x3c\/h3\x3e\n\x3cp\x3e讲到这里，其实还有一个非常重要的点没有提到，就是我们如何把 \x3ccode\x3edata\x3c\/code\x3e 真实数据渲染到模板中，比如 \x3ccode\x3e\x26lt;h1\x26gt;Hey ?, \x22{{\x22 greeting \x22}}\x22\x26lt;\/h1\x26gt;\x3c\/code\x3e 如何渲染成 \x3ccode\x3e\x26lt;h1\x26gt;Hey ?, Hello World\x26lt;\/h1\x26gt;\x3c\/code\x3e，通过下面三个步骤即可计算出表达式的真实数据：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e把 \x3ccode\x3e\x26lt;h1\x26gt;Hey ?, \x22{{\x22 greeting \x22}}\x22\x26lt;\/h1\x26gt;\x3c\/code\x3e 解析成 \x3ccode\x3e\x27Hey ?, \x27 \x2b greeting\x3c\/code\x3e 这样的 JavaScript 表达式；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e提取其中的依赖变量并取得所在 \x3ccode\x3edata\x3c\/code\x3e 中的对应值；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e利用 \x3ccode\x3enew Function()\x3c\/code\x3e 来创建一个匿名函数来返回这个表达式；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e最后通过调用这个匿名函数来返回最终计算出来的数据并通过指令的 \x3ccode\x3eupdate\x3c\/code\x3e 方法更新到视图中。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch4\x3eparse text\x3c\/h4\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ reference: https:\/\/github.com\/vuejs\/vue\/blob\/dev\/src\/compiler\/parser\/text-parser.js#L15-L41\nconst tagRE = \/\\{\\{((?:.|\\n)\x2b?)\\}\\}\/g;\nfunction parse(text) {\n    if (!tagRE.test(text)) return JSON.stringify(text);\n\n    const tokens = [];\n    let lastIndex = tagRE.lastIndex = 0;\n    let index, matched;\n\n    while (matched = tagRE.exec(text)) {\n        index = matched.index;\n        if (index \x3e lastIndex) {\n            tokens.push(JSON.stringify(text.slice(lastIndex, index)));\n        }\n        tokens.push(matched[1].trim());\n        lastIndex = index \x2b matched[0].length;\n    }\n\n    if (lastIndex \x3c text.length) tokens.push(JSON.stringify(text.slice(lastIndex)));\n\n    return tokens.join(\x27\x2b\x27);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ reference: https:\/\/github.com\/vuejs\/vue\/blob\/dev\/src\/compiler\/parser\/text-parser.js#L15-L41\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e tagRE = \x3cspan class=\x22hljs-regexp\x22\x3e\/\\{\\{((?:.|\\n)\x2b?)\\}\\}\/g\x3c\/span\x3e;\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eparse\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3etext\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!tagRE.test(text)) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(text);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e tokens = [];\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e lastIndex = tagRE.lastIndex = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e index, matched;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (matched = tagRE.exec(text)) {\n        index = matched.index;\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (index \x26gt; lastIndex) {\n            tokens.push(\x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(text.slice(lastIndex, index)));\n        }\n        tokens.push(matched[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e].trim());\n        lastIndex = index \x2b matched[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e].length;\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (lastIndex \x26lt; text.length) tokens.push(\x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(text.slice(lastIndex)));\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e tokens.join(\x3cspan class=\x22hljs-string\x22\x3e\x27\x2b\x27\x3c\/span\x3e);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e该函数我是直接参考 \x3ccode\x3eVue\x3c\/code\x3e 的实现，它会把含有双花括号的字符串解析成标准的 JavaScript 表达式，例如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22parse(`Hi \x22{{\x22 user.name \x22}}\x22, \x22{{\x22 colon \x22}}\x22 is awesome.`);\n\/\/ =\x3e \x27Hi \x27 \x2b user.name \x2b \x27, \x27 \x2b colon \x2b \x27 is awesome.\x27\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eparse(\x3cspan class=\x22hljs-string\x22\x3e`Hi \x22{{\x22 user.name \x22}}\x22, \x22{{\x22 colon \x22}}\x22 is awesome.`\x3c\/span\x3e);\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ =\x26gt; \x27Hi \x27 \x2b user.name \x2b \x27, \x27 \x2b colon \x2b \x27 is awesome.\x27\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3eextract dependency\x3c\/h4\x3e\n\x3cp\x3e我们会通过下面这个函数来提取出一个表达式中可能存在的变量：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const dependencyRE = \/\x26quot;[^\x26quot;]*\x26quot;|\x27[^\x27]*\x27|\\.\\w*[a-zA-Z$_]\\w*|\\w*[a-zA-Z$_]\\w*:|(\\w*[a-zA-Z$_]\\w*)\/g;\nconst globals = [\n    \x27true\x27, \x27false\x27, \x27undefined\x27, \x27null\x27, \x27NaN\x27, \x27isNaN\x27, \x27typeof\x27, \x27in\x27,\n    \x27decodeURI\x27, \x27decodeURIComponent\x27, \x27encodeURI\x27, \x27encodeURIComponent\x27, \x27unescape\x27,\n    \x27escape\x27, \x27eval\x27, \x27isFinite\x27, \x27Number\x27, \x27String\x27, \x27parseFloat\x27, \x27parseInt\x27,\n];\n\nfunction extractDependencies(expression) {\n    const dependencies = [];\n\n    expression.replace(dependencyRE, (match, dependency) =\x3e {\n        if (\n            dependency !== undefined \x26amp;\x26amp;\n            dependencies.indexOf(dependency) === -1 \x26amp;\x26amp;\n            globals.indexOf(dependency) === -1\n        ) {\n            dependencies.push(dependency);\n        }\n    });\n\n    return dependencies;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e dependencyRE = \x3cspan class=\x22hljs-regexp\x22\x3e\/\x22[^\x22]*\x22|\x27[^\x27]*\x27|\\.\\w*[a-zA-Z$_]\\w*|\\w*[a-zA-Z$_]\\w*:|(\\w*[a-zA-Z$_]\\w*)\/g\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e globals = [\n    \x3cspan class=\x22hljs-string\x22\x3e\x27true\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27false\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27undefined\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27null\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27NaN\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27isNaN\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27typeof\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27in\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27decodeURI\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27decodeURIComponent\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27encodeURI\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27encodeURIComponent\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27unescape\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27escape\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27eval\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27isFinite\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27Number\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27String\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27parseFloat\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27parseInt\x27\x3c\/span\x3e,\n];\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eextractDependencies\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eexpression\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e dependencies = [];\n\n    expression.replace(dependencyRE, (match, dependency) =\x26gt; {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\n            dependency !== \x3cspan class=\x22hljs-literal\x22\x3eundefined\x3c\/span\x3e \x26amp;\x26amp;\n            dependencies.indexOf(dependency) === \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e \x26amp;\x26amp;\n            globals.indexOf(dependency) === \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e\n        ) {\n            dependencies.push(dependency);\n        }\n    });\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e dependencies;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e通过正则表达式 \x3ccode\x3edependencyRE\x3c\/code\x3e 匹配出可能的变量依赖后，还要进行一些对比，比如是否是全局变量等等。效果如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22extractDependencies(`typeof String(name) === \x27string\x27  \x26amp;\x26amp; \x27Hello \x27 \x2b world \x2b \x27! \x27 \x2b hello.split(\x27\x27).join(\x27\x27) \x2b \x27.\x27`);\n\/\/ =\x3e [\x26quot;name\x26quot;, \x26quot;world\x26quot;, \x26quot;hello\x26quot;]\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eextractDependencies(\x3cspan class=\x22hljs-string\x22\x3e`typeof String(name) === \x27string\x27  \x26amp;\x26amp; \x27Hello \x27 \x2b world \x2b \x27! \x27 \x2b hello.split(\x27\x27).join(\x27\x27) \x2b \x27.\x27`\x3c\/span\x3e);\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ =\x26gt; [\x22name\x22, \x22world\x22, \x22hello\x22]\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这正是我们需要的结果，\x3ccode\x3etypeof\x3c\/code\x3e, \x3ccode\x3eString\x3c\/code\x3e, \x3ccode\x3esplit\x3c\/code\x3e 和 \x3ccode\x3ejoin\x3c\/code\x3e 并不是 \x3ccode\x3edata\x3c\/code\x3e 中所依赖的变量，所以不需要被提取出来。\x3c\/p\x3e\n\x3ch4\x3egenerate\x3c\/h4\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22export function generate(expression) {\n    const dependencies = extractDependencies(expression);\n    let dependenciesCode = \x27\x27;\n\n    dependencies.map(dependency =\x3e dependenciesCode \x2b= `var ${dependency} = this.get(\x26quot;${dependency}\x26quot;); `);\n\n    return new Function(`data`, `${dependenciesCode}return ${expression};`);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egenerate\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eexpression\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e dependencies = extractDependencies(expression);\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e dependenciesCode = \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e;\n\n    dependencies.map(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3edependency\x3c\/span\x3e =\x26gt;\x3c\/span\x3e dependenciesCode \x2b= \x3cspan class=\x22hljs-string\x22\x3e`var \x3cspan class=\x22hljs-subst\x22\x3e${dependency}\x3c\/span\x3e = this.get(\x22\x3cspan class=\x22hljs-subst\x22\x3e${dependency}\x3c\/span\x3e\x22); `\x3c\/span\x3e);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eFunction\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e`data`\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${dependenciesCode}\x3c\/span\x3ereturn \x3cspan class=\x22hljs-subst\x22\x3e${expression}\x3c\/span\x3e;`\x3c\/span\x3e);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们提取变量的目的就是为了在 \x3ccode\x3egenerate\x3c\/code\x3e 函数中生成相应的变量赋值的字符串便于在 \x3ccode\x3egenerate\x3c\/code\x3e 函数中使用，例如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22new Function(`data`, `\n    var name = data[\x26quot;name\x26quot;];\n    var world = data[\x26quot;world\x26quot;];\n    var hello = data[\x26quot;hello\x26quot;];\n    return typeof String(name) === \x27string\x27  \x26amp;\x26amp; \x27Hello \x27 \x2b world \x2b \x27! \x27 \x2b hello.split(\x27\x27).join(\x27\x27) \x2b \x27.\x27;\n`);\n\n\/\/ will generated:\n\nfunction anonymous(data) {\n    var name = data[\x26quot;name\x26quot;];\n    var world = data[\x26quot;world\x26quot;];\n    var hello = data[\x26quot;hello\x26quot;];\n    return typeof String(name) === \x27string\x27  \x26amp;\x26amp; \x27Hello \x27 \x2b world \x2b \x27! \x27 \x2b hello.split(\x27\x27).join(\x27\x27) \x2b \x27.\x27;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eFunction\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e`data`\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e`\n    var name = data[\x22name\x22];\n    var world = data[\x22world\x22];\n    var hello = data[\x22hello\x22];\n    return typeof String(name) === \x27string\x27  \x26amp;\x26amp; \x27Hello \x27 \x2b world \x2b \x27! \x27 \x2b hello.split(\x27\x27).join(\x27\x27) \x2b \x27.\x27;\n`\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ will generated:\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eanonymous\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3edata\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e name = data[\x3cspan class=\x22hljs-string\x22\x3e\x22name\x22\x3c\/span\x3e];\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e world = data[\x3cspan class=\x22hljs-string\x22\x3e\x22world\x22\x3c\/span\x3e];\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e hello = data[\x3cspan class=\x22hljs-string\x22\x3e\x22hello\x22\x3c\/span\x3e];\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eString\x3c\/span\x3e(name) === \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e  \x26amp;\x26amp; \x3cspan class=\x22hljs-string\x22\x3e\x27Hello \x27\x3c\/span\x3e \x2b world \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27! \x27\x3c\/span\x3e \x2b hello.split(\x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e).join(\x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e) \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27.\x27\x3c\/span\x3e;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样的话，只需要在调用这个匿名函数的时候传入对应的 \x3ccode\x3edata\x3c\/code\x3e 即可获得我们想要的结果了。现在回过头来看之前的 \x3ccode\x3eDirective\x3c\/code\x3e 部分代码应该就一目了然了：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22export default class Directive {\n    constructor(options = {}) {\n        \/\/ ...\n        this.beforeUpdate \x26amp;\x26amp; this.beforeUpdate();\n        this.update \x26amp;\x26amp; this.update(generate(this.expression)(this.compile.data));\n    }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eDirective\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3econstructor\x3c\/span\x3e(options = {}) {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.beforeUpdate \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.beforeUpdate();\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.update \x26amp;\x26amp; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.update(generate(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.expression)(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.compile.data));\n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3egenerate(this.expression)(this.compile.data)\x3c\/code\x3e 就是表达式经过 \x3ccode\x3ethis.compile.data\x3c\/code\x3e 计算后我们所需要的值。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3ecompile text node\x3c\/h3\x3e\n\x3cp\x3e我们前面只讲了如何编译 \x3ccode\x3enode.nodeType === 1\x3c\/code\x3e 的元素节点，那么文字节点如何编译呢，其实理解了前面所讲的内容话，文字节点的编译就简单得不能再简单了：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/**\n * compile text node\n *\n * @param {Node} node\n *\/\nCompile.compile.textNodes = function (node) {\n    if (node.textContent.trim() === \x27\x27) return false;\n\n    this.bindDirective({\n        node,\n        name: \x27text\x27,\n        expression: parse.text(node.textContent),\n    });\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * compile text node\n *\n * @param {Node} node\n *\/\x3c\/span\x3e\nCompile.compile.textNodes = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3enode\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (node.textContent.trim() === \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.bindDirective({\n        node,\n        \x3cspan class=\x22hljs-attr\x22\x3ename\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27text\x27\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3eexpression\x3c\/span\x3e: parse.text(node.textContent),\n    });\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e通过绑定 \x3ccode\x3etext\x3c\/code\x3e 指令，并传入解析后的 JavaScript 表达式，在 \x3ccode\x3eDirective\x3c\/code\x3e 内部就会计算出表达式实际的值并调用 \x3ccode\x3etext\x3c\/code\x3e 的 \x3ccode\x3eupdate\x3c\/code\x3e 函数更新视图完成渲染。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e\n\x3ccode\x3e:each\x3c\/code\x3e 指令\x3c\/h2\x3e\n\x3cp\x3e到目前为止，该模板引擎只实现了比较基本的功能，而最常见且重要的列表渲染功能还没有实现，所以我们现在要实现一个 \x3ccode\x3e:each\x3c\/code\x3e 指令来渲染一个列表，这里可能要注意一下，不能按照前面两个指令的思路来实现，应该换一个角度来思考，列表渲染其实相当于一个「子模板」，里面的变量存在于 \x3ccode\x3e:each\x3c\/code\x3e 指令所接收的 \x3ccode\x3edata\x3c\/code\x3e 这个「局部作用域」中，这么说可能抽象，直接上代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ :each updater\nimport Compile from \x27path\/to\/compile.js\x27;\nexport default {\n    beforeUpdate() {\n        this.placeholder = document.createComment(`:each`);\n        this.node.parentNode.replaceChild(this.placeholder, this.node);\n    },\n    update() {\n        if (data \x26amp;\x26amp; !Array.isArray(data)) return;\n\n        const fragment = document.createDocumentFragment();\n\n        data.map((item, index) =\x3e {\n            const compiled = Compile(this.node.cloneNode(true), { item, index, });\n            fragment.appendChild(compiled.view);\n        });\n\n        this.placeholder.parentNode.replaceChild(fragment, this.placeholder);\n    },\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ :each updater\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Compile \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27path\/to\/compile.js\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e {\n    beforeUpdate() {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.placeholder = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createComment(\x3cspan class=\x22hljs-string\x22\x3e`:each`\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.node.parentNode.replaceChild(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.placeholder, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.node);\n    },\n    update() {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (data \x26amp;\x26amp; !\x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.isArray(data)) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fragment = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createDocumentFragment();\n\n        data.map(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eitem, index\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiled = Compile(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.node.cloneNode(\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e), { item, index, });\n            fragment.appendChild(compiled.view);\n        });\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.placeholder.parentNode.replaceChild(fragment, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.placeholder);\n    },\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在 \x3ccode\x3eupdate\x3c\/code\x3e 之前，我们先把 \x3ccode\x3e:each\x3c\/code\x3e 所在节点从 DOM 结构中去掉，但是要注意的是并不能直接去掉，而是要在去掉的位置插入一个 \x3ccode\x3ecomment\x3c\/code\x3e 类型的节点作为占位符，目的是为了在我们把列表数据渲染出来后，能找回原来的位置并把它插入到 DOM 中。\x3c\/p\x3e\n\x3cp\x3e那具体如何编译这个所谓的「子模板」呢，首先，我们需要遍历 \x3ccode\x3e:each\x3c\/code\x3e 指令所接收的 \x3ccode\x3eArray\x3c\/code\x3e 类型的数据（目前只支持该类型，当然你也可以增加对 \x3ccode\x3eObject\x3c\/code\x3e 类型的支持，原理是一样的）；其次，我们针对该列表的每一项数据进行一次模板的编译并把渲染后的模板插入到创建的 \x3ccode\x3edocument fragment\x3c\/code\x3e 中，当所有整个列表编译完后再把刚刚创建的 \x3ccode\x3ecomment\x3c\/code\x3e 类型的占位符替换为 \x3ccode\x3edocument fragment\x3c\/code\x3e 以完成列表的渲染。\x3c\/p\x3e\n\x3cp\x3e此时，我们可以这么使用 \x3ccode\x3e:each\x3c\/code\x3e 指令：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Compile(`\x3cli :each=\x26quot;comments\x26quot; data-index=\x26quot;\x22{{\x22 index \x22}}\x22\x26quot;\x3e\x22{{\x22 item.content \x22}}\x22\x3c\/li\x3e`, {\n    comments: [{\n        content: `Hello World.`,\n    }, {\n        content: `Just Awesome.`,\n    }, {\n        content: `WOW, Just WOW!`,\n    }],\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eCompile(\x3cspan class=\x22hljs-string\x22\x3e`\x26lt;li :each=\x22comments\x22 data-index=\x22\x22{{\x22 index \x22}}\x22\x22\x26gt;\x22{{\x22 item.content \x22}}\x22\x26lt;\/li\x26gt;`\x3c\/span\x3e, {\n    \x3cspan class=\x22hljs-attr\x22\x3ecomments\x3c\/span\x3e: [{\n        \x3cspan class=\x22hljs-attr\x22\x3econtent\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`Hello World.`\x3c\/span\x3e,\n    }, {\n        \x3cspan class=\x22hljs-attr\x22\x3econtent\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`Just Awesome.`\x3c\/span\x3e,\n    }, {\n        \x3cspan class=\x22hljs-attr\x22\x3econtent\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`WOW, Just WOW!`\x3c\/span\x3e,\n    }],\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e会渲染成：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cli data-index=\x26quot;0\x26quot;\x3eHello World.\x3c\/li\x3e\n\x3cli data-index=\x26quot;1\x26quot;\x3eJust Awesome.\x3c\/li\x3e\n\x3cli data-index=\x26quot;2\x26quot;\x3eWOW, Just WOW!\x3c\/li\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eli\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3edata-index\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x220\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3eHello World.\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eli\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eli\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3edata-index\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x221\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3eJust Awesome.\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eli\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eli\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3edata-index\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x222\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3eWOW, Just WOW!\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eli\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其实细心的话你会发现，模板中使用的 \x3ccode\x3eitem\x3c\/code\x3e 和 \x3ccode\x3eindex\x3c\/code\x3e 变量其实就是 \x3ccode\x3e:each\x3c\/code\x3e 更新函数中 \x3ccode\x3eCompile(template, data)\x3c\/code\x3e 编译器里的 \x3ccode\x3edata\x3c\/code\x3e 值的两个 \x3ccode\x3ekey\x3c\/code\x3e 值。所以要自定义这两个变量也是非常简单的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ :each updater\nimport Compile from \x27path\/to\/compile.js\x27;\nexport default {\n    beforeUpdate() {\n        this.placeholder = document.createComment(`:each`);\n        this.node.parentNode.replaceChild(this.placeholder, this.node);\n\n        \/\/ parse alias\n        this.itemName = `item`;\n        this.indexName = `index`;\n        this.dataName = this.expression;\n\n        if (this.expression.indexOf(\x27 in \x27) != -1) {\n            const bracketRE = \/\\(((?:.|\\n)\x2b?)\\)\/g;\n            const [item, data] = this.expression.split(\x27 in \x27);\n            let matched = null;\n\n            if (matched = bracketRE.exec(item)) {\n                const [item, index] = matched[1].split(\x27,\x27);\n                index ? this.indexName = index.trim() : \x27\x27;\n                this.itemName = item.trim();\n            } else {\n                this.itemName = item.trim();\n            }\n\n            this.dataName = data.trim();\n        }\n\n        this.expression = this.dataName;\n    },\n    update() {\n        if (data \x26amp;\x26amp; !Array.isArray(data)) return;\n\n        const fragment = document.createDocumentFragment();\n\n        data.map((item, index) =\x3e {\n            const compiled = Compile(this.node.cloneNode(true), {\n                [this.itemName]: item,\n                [this.indexName]: index,\n            });\n            fragment.appendChild(compiled.view);\n        });\n\n        this.placeholder.parentNode.replaceChild(fragment, this.placeholder);\n    },\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ :each updater\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Compile \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27path\/to\/compile.js\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3eexport\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e {\n    beforeUpdate() {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.placeholder = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createComment(\x3cspan class=\x22hljs-string\x22\x3e`:each`\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.node.parentNode.replaceChild(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.placeholder, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.node);\n\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ parse alias\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.itemName = \x3cspan class=\x22hljs-string\x22\x3e`item`\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.indexName = \x3cspan class=\x22hljs-string\x22\x3e`index`\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.dataName = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.expression;\n\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.expression.indexOf(\x3cspan class=\x22hljs-string\x22\x3e\x27 in \x27\x3c\/span\x3e) != \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e bracketRE = \x3cspan class=\x22hljs-regexp\x22\x3e\/\\(((?:.|\\n)\x2b?)\\)\/g\x3c\/span\x3e;\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e [item, data] = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.expression.split(\x3cspan class=\x22hljs-string\x22\x3e\x27 in \x27\x3c\/span\x3e);\n            \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e matched = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (matched = bracketRE.exec(item)) {\n                \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e [item, index] = matched[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e].split(\x3cspan class=\x22hljs-string\x22\x3e\x27,\x27\x3c\/span\x3e);\n                index ? \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.indexName = index.trim() : \x3cspan class=\x22hljs-string\x22\x3e\x27\x27\x3c\/span\x3e;\n                \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.itemName = item.trim();\n            } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.itemName = item.trim();\n            }\n\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.dataName = data.trim();\n        }\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.expression = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.dataName;\n    },\n    update() {\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (data \x26amp;\x26amp; !\x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.isArray(data)) \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n\n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e fragment = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createDocumentFragment();\n\n        data.map(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eitem, index\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e compiled = Compile(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.node.cloneNode(\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e), {\n                [\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.itemName]: item,\n                [\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.indexName]: index,\n            });\n            fragment.appendChild(compiled.view);\n        });\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.placeholder.parentNode.replaceChild(fragment, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.placeholder);\n    },\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样一来我们就可以通过 \x3ccode\x3e(aliasItem, aliasIndex) in items\x3c\/code\x3e 来自定义 \x3ccode\x3e:each\x3c\/code\x3e 指令的 \x3ccode\x3eitem\x3c\/code\x3e 和 \x3ccode\x3eindex\x3c\/code\x3e 变量了，原理就是在 \x3ccode\x3ebeforeUpdate\x3c\/code\x3e 的时候去解析 \x3ccode\x3e:each\x3c\/code\x3e 指令的表达式，提取相关的变量名，然后上面的例子就可以写成这样了：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Compile(`\x3cli :each=\x26quot;(comment, index) in comments\x26quot; data-index=\x26quot;\x22{{\x22 index \x22}}\x22\x26quot;\x3e\x22{{\x22 comment.content \x22}}\x22\x3c\/li\x3e`, {\n    comments: [{\n        content: `Hello World.`,\n    }, {\n        content: `Just Awesome.`,\n    }, {\n        content: `WOW, Just WOW!`,\n    }],\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3eCompile(\x3cspan class=\x22hljs-string\x22\x3e`\x26lt;li :each=\x22(comment, index) in comments\x22 data-index=\x22\x22{{\x22 index \x22}}\x22\x22\x26gt;\x22{{\x22 comment.content \x22}}\x22\x26lt;\/li\x26gt;`\x3c\/span\x3e, {\n    \x3cspan class=\x22hljs-attr\x22\x3ecomments\x3c\/span\x3e: [{\n        \x3cspan class=\x22hljs-attr\x22\x3econtent\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`Hello World.`\x3c\/span\x3e,\n    }, {\n        \x3cspan class=\x22hljs-attr\x22\x3econtent\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`Just Awesome.`\x3c\/span\x3e,\n    }, {\n        \x3cspan class=\x22hljs-attr\x22\x3econtent\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e`WOW, Just WOW!`\x3c\/span\x3e,\n    }],\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader8\x22\x3eConclusion\x3c\/h2\x3e\n\x3cp\x3e到这里，其实一个比较简单的模板引擎算是实现了，当然还有很多地方可以完善的，比如可以增加 \x3ccode\x3e:class\x3c\/code\x3e, \x3ccode\x3e:style\x3c\/code\x3e, \x3ccode\x3e:if\x3c\/code\x3e 或 \x3ccode\x3e:src\x3c\/code\x3e 等等你可以想到的指令功能，添加这些功能都是非常的简单的。\x3c\/p\x3e\n\x3cp\x3e全篇介绍下来，整个核心无非就是遍历整个模板的节点树，其次针对每一个节点的字符串值来解析成对应的表达式，然后通过 \x3ccode\x3enew Function()\x3c\/code\x3e 这个构造函数来计算成实际的值，最终通过指令的 \x3ccode\x3eupdate\x3c\/code\x3e 函数来更新到视图上。\x3c\/p\x3e\n\x3cp\x3e如果还是不清楚这些指令如何编写的话，可以参考我这个项目 \x3ca href=\x22https:\/\/github.com\/colonjs\/colon\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ecolon\x3c\/a\x3e 的相关源码（部分代码可能会有不影响理解的细微差别，可忽略），有任何问题都可以在 issue 上提。\x3c\/p\x3e\n\x3cp\x3e目前有一个局限就是 DOM-based 的模板引擎只适用于浏览器端，目前笔者也正在实现兼容 Node 端的版本，思路是把字符串模板解析成 AST，然后把更新数据到 AST 上，最后再把 AST 转成字符串模板，实现出来后有空的话再来介绍一下 Node 端的实现。\x3c\/p\x3e\n\x3cp\x3e最后，如果上面有说得不对或者有更好的实现方式的话，欢迎指出讨论。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>如何实现一个基于 DOM 的模板引擎</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010556585">https://segmentfault.com/a/1190000010556585</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/mxmhvbsens/" target="_blank">https://alili.tech/archive/mxmhvbsens/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/lfmj4xr00e/">2016年终总结--前端生涯从0到1的过程<aside class="dates">2019-01-27</aside></a></li><li><a href="/archive/ukfvl3yzohq/">ES6新语法疑点简析<aside class="dates">2019-01-27</aside></a></li><li><a href="/archive/adal5cm5rlr/">Icon 进化史<aside class="dates">2019-01-27</aside></a></li><li><a href="/archive/xwquh4g09bl/">JS 中 TDZ 的理解<aside class="dates">2019-01-27</aside></a></li><li><a href="/archive/13j072ppoyf/">Javascript 中 Y 组合子的推导<aside class="dates">2019-01-27</aside></a></li><li><a href="/archive/kn3l7fwd55/">Redux story-1:who creates it?<aside class="dates">2019-01-27</aside></a></li><li><a href="/archive/9gngp6sg77/">Redux概念之二: Redux的三大原则<aside class="dates">2019-01-27</aside></a></li><li><a href="/archive/ktc291v9lq/">V8 Object 内存结构与属性访问详解<aside class="dates">2019-01-27</aside></a></li><li><a href="/archive/62hk7sdq93k/">Vue&#43;MySQL&#43;Express小试牛刀<aside class="dates">2019-01-27</aside></a></li><li><a href="/archive/q9tzlra5qaj/">Vue2.0简易案例<aside class="dates">2019-01-27</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>