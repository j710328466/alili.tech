<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="全面进阶 H5 直播"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>全面进阶 H5 直播 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/8hk4d2ujrx8/",
				"appid": "1613049289050283", 
				"title": "全面进阶 H5 直播 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-17T02:30:25"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/z3kx2n3qt6q/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/414swbybii/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f&text=%e5%85%a8%e9%9d%a2%e8%bf%9b%e9%98%b6%20H5%20%e7%9b%b4%e6%92%ad"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f&text=%e5%85%a8%e9%9d%a2%e8%bf%9b%e9%98%b6%20H5%20%e7%9b%b4%e6%92%ad"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f&title=%e5%85%a8%e9%9d%a2%e8%bf%9b%e9%98%b6%20H5%20%e7%9b%b4%e6%92%ad"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f&is_video=false&description=%e5%85%a8%e9%9d%a2%e8%bf%9b%e9%98%b6%20H5%20%e7%9b%b4%e6%92%ad"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%85%a8%e9%9d%a2%e8%bf%9b%e9%98%b6%20H5%20%e7%9b%b4%e6%92%ad&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f&title=%e5%85%a8%e9%9d%a2%e8%bf%9b%e9%98%b6%20H5%20%e7%9b%b4%e6%92%ad"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f&title=%e5%85%a8%e9%9d%a2%e8%bf%9b%e9%98%b6%20H5%20%e7%9b%b4%e6%92%ad"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f&title=%e5%85%a8%e9%9d%a2%e8%bf%9b%e9%98%b6%20H5%20%e7%9b%b4%e6%92%ad"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f8hk4d2ujrx8%2f&title=%e5%85%a8%e9%9d%a2%e8%bf%9b%e9%98%b6%20H5%20%e7%9b%b4%e6%92%ad"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">全面进阶 H5 直播</h1><div class="meta"><div class="postdate"><time datetime="2019-01-17" itemprop="datePublished">2019-01-17</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e视频格式？编码？\x3c\/h2\x3e\n\x3cp\x3e如果我们想要理解 HTML5 视频，首先需要知道，你应该知道，但你不知道的内容？那怎么去判断呢？\x3cbr\x3eok，很简单，我提几个问题即可，如果某些童鞋知道答案的话，可以直接跳过。\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e你知道 ogg,mp4,flv,webm（前面加个点 \x3ccode\x3e.\x3c\/code\x3e）这些叫做什么吗？\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e那 FLV，MPEG-4，VP8 是啥？\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e如果，基友问你要片源，你会说我这是 mp4 的还是 MPEG-4 的呢？\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e当然，还有一些问题，我这里就不废话了。上面主要想说的其实就两个概念：\x3ca href=\x22https:\/\/zh.wikipedia.org\/wiki\/%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e视频文件格式\x3c\/a\x3e（容器格式），\x3ca href=\x22https:\/\/zh.wikipedia.org\/wiki\/%E8%A7%86%E9%A2%91%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e视频编解码器\x3c\/a\x3e（视频编码格式）。当然，还有另外一种，叫做音频编解码器。简而言之，就是这三个概念比较重要：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e视频文件格式（容器格式）\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e视频编解码器（视频编码格式）\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e音频编解码器（音频编码格式）\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e这里，我们主要讲解一下前面两个。视频一开始会由两个端采集，一个是视频输入口，是一个音频输入口。然后，采集的数据会分别进行相关处理，简而言之就是，将视频\/音频流，通过一定的手段转换为比特流。最终，将这里比特流以一定顺序放到一个盒子里进行存放，从而生成我们最终所看到的，比如，mp4\/mp3\/flv 等等音视频格式。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e视频编码格式\x3c\/h3\x3e\n\x3cp\x3e视频编码格式就是我们上面提到的第一步，将物理流转换为比特流，并且进行压缩。同样，它的压缩编码格式会决定它的视频文件格式。所以，第一步很重要。针对于 HTML5 中的 video\/audio，它实际上是支持多种编码格式的，但局限于各浏览器厂家的普及度，目前视频格式支持度最高的是 MPEG-4\/H.264，音频则是 MP3\/AC3。（下面就主要说下视频的，音频就先不谈了。）\x3c\/p\x3e\n\x3cp\x3e目前市面上，主流浏览器支持的几个有：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eH.264\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eMEPG-4 第 2 部分\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eVP8\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eOgg\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eWebM（免费）\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e其它格式，我们这里就不过多赘述，来看一下前两个比较有趣的。如下图：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916402?w=916\x26amp;h=262\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916402?w=916\x26amp;h=262\x22 alt=\x22demo\x22 title=\x22demo\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e请问，上面箭头所指的编码格式是同一个吗？\x3c\/p\x3e\n\x3cp\x3e答案是：No~\x3c\/p\x3e\n\x3cp\x3e因为，MPEG-4 实际上是于 1999 年提出的一个标准。而 H.264 则是后台作为优化提出的新的标准。简单来说就是，\x3cstrong\x3e我们通常说的 MPEG-4 其实就是MPEG-4 Part 2。而，H.264 则是MPEG-4（第十部分，也叫ISO\/IEC 14496-10），又可以理解为 MPEG-4 AVC\x3c\/strong\x3e。而两者，不同的地方，可以参考：\x3ca href=\x22http:\/\/www.jianshu.com\/p\/4def60dd594f\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3elatthias\x3c\/a\x3e 的讲解。简单的区别是：H.264 压缩率比以前的 MPEG-4（第 2 部分） 高很多。简单可以参考的就是：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916403?w=964\x26amp;h=368\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916403?w=964\x26amp;h=368\x22 alt=\x22demo\x22 title=\x22demo\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e详细参考: \x3ca href=\x22http:\/\/www.jianshu.com\/p\/4def60dd594f\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e编码格式详解\x3c\/a\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e视频文件格式\x3c\/h3\x3e\n\x3cp\x3e视频文件格式实际上，我们常常称作为容器格式，也就是，我们一般生活中最经常谈到的格式，flv，mp4，ogg 格式等。\x3cstrong\x3e它就可以理解为将比特流按照一定顺序放进特定的盒子里。\x3c\/strong\x3e那选用不同格式来装视频有什么问题吗？\x3cbr\x3e答案是，没有任何问题，但是你需要知道如何将该盒子解开，并且能够找到对应的解码器进行解码。那如果按照这样看的话，对于这些 mp4，ogv，webm等等视频格式，只要我有这些对应的解码器以及播放器，那么就没有任何问题。那么针对于，将视频比特流放进一个盒子里面，如果其中某一段出现问题，那么最终生成的文件实际上是不可用的，因为这个盒子本身就是有问题的。\x3cbr\x3e不过，上面有一个误解的地方在于，我只是将视频理解为一个静态的流。试想一下，如果一个视频需要持续不断的播放，例如，直播，现场播报等。这里，我们就拿 \x3ca href=\x22http:\/\/wolfcrow.com\/blog\/program-stream-vs-transport-stream-the-simple-difference\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eTS\/PS\x3c\/a\x3e 流来进行讲解。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3ePS（Program Stream）: 静态文件流\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eTS（Transport Stream）: 动态文件流\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e针对于上面两种容器格式，实际上是对一个视频比特流做了不一样的处理。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3ePS: 将完成视频比特流放到一个盒子里，生成固定的文件\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eTS: 将接受到的视频，分成不同的盒子里。最终生成带有多个盒子的文件。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e那么结果就是，如果一个或多个盒子出现损坏，PS 格式无法观看，而 TS 只是会出现跳帧或者马赛克效应。两者具体的区别就是：\x3cstrong\x3e对于视频的容错率越高，则会选用 TS，对视频容错率越低，则会选用 PS。\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e常用为：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eAVI：MPEG-2，DIVX，XVID，AC-1，H.264;\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eWMV：WMV，AC-1;\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eRM、RMVB：RV， RM;\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eMOV：MPEG-2，XVID，H.264;\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eTS\/PS：MPEG-2，H.264，MPEG-4;\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eMKV：可以封装所有的视频编码格式。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e详细参考：\x3ca href=\x22https:\/\/zh.wikipedia.org\/wiki\/%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e视频文件格式\x3c\/a\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e直播协议\x3c\/h2\x3e\n\x3cp\x3e2016 年是直播元年，一是由于各大宽带提供商顺应民意\x3ccode\x3e增宽降价\x3c\/code\x3e，二是大量资本流进了直播板块，促进了技术的更新迭代。市面上，最常用的是 Apple 推出的 HLS 直播协议（原始支持 H5 播放），当然，还有 RTMP、HTTP-FLV、RTP等。\x3cbr\x3e这里，再问一个问题：\x3c\/p\x3e\n\x3col\x3e\x3cli\x3e\x3cp\x3eHLS 和 MPEG-4\/H.264 以及容器格式 TS\/PS 是啥关系？\x3c\/p\x3e\x3c\/li\x3e\x3c\/ol\x3e\n\x3cp\x3e简单来说，没关系。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3eHLS 根本就不会涉及到视频本身的解码问题。它的存在只是为了确保你的视频能够及时，快速，正确的播放。\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e现在，直播行业依旧很火，而 HTML5 直播，一直以来都是一个比较蛋疼的内容。一是，浏览器厂商更新速度比较慢，二是，这并不是我们前端专攻的一块，所以，有时候的确很鸡肋。当然，进了前端，你就别想着休息。接下来，我们来详细的看一下市面上主流的几个协议。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3eHLS\x3c\/h3\x3e\n\x3cp\x3eHLS 全称是 HTTP Live Streaming。这是 \x3ca href=\x22https:\/\/developer.apple.com\/streaming\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eApple\x3c\/a\x3e 提出的直播流协议。目前，IOS 和 高版本 Android 都支持 HLS。那什么是 HLS 呢？\x3cbr\x3eHLS 主要的两块内容是 \x3ccode\x3e.m3u8\x3c\/code\x3e 文件和 \x3ccode\x3e.ts\x3c\/code\x3e 播放文件。接受服务器会将接受到的视频流进行缓存，然后缓存到一定程度后，会将这些视频流进行编码格式化，同时会生成一份 \x3ccode\x3e.m3u8\x3c\/code\x3e 文件和其它很多的 \x3ccode\x3e.ts\x3c\/code\x3e 文件。根据 \x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/HTTP_Live_Streaming\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ewiki\x3c\/a\x3e 阐述，HLS 的基本架构为：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3cp\x3e服务器：后台服务器接受视频流，然后进行编码和片段化。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e编码：视频格式编码采用 H.264。音频编码为 AAC, MP3, AC-3，EC-3。然后使用 MPEG-2 Transport Stream 作为容器格式。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e分片：将 TS 文件分成若干个相等大小的 \x3ccode\x3e.ts\x3c\/code\x3e 文件。并且生成一个 \x3ccode\x3e.m3u8\x3c\/code\x3e 作为索引文件（确保包的顺序）\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e分发：由于 HLS 是基于 HTTP 的，所以，作为分发，最常用的就是 CDN 了。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e客户端：使用一个 URL 去下载 m3u8 文件，然后，开始下载 ts 文件，下载完成后，使用 \x3ccode\x3eplayback software\x3c\/code\x3e（即时播放器） 进行播放。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e这里，我们着重介绍一下客户端的过程。首先，直播之所以是直播，在于它的内容是实时更新的。那 HLS 是怎么完成呢？\x3cbr\x3e我们使用 HLS 直接就用一个 video 进行包括即可：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cvideo controls autoplay\x3e  \n    \x3csource src=\x26quot;http:\/\/devimages.apple.com\/iphone\/samples\/bipbop\/bipbopall.m3u8\x26quot; type=\x26quot;application\/vnd.apple.mpegurl\x26quot; \/\x3e \n    \x3cp class=\x26quot;warning\x26quot;\x3eYour browser does not support HTML5 video.\x3c\/p\x3e  \n\x3c\/video\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3e\x26lt;\x3cspan class=\x22hljs-selector-tag\x22\x3evideo\x3c\/span\x3e controls autoplay\x26gt;  \n    \x26lt;source src=\x3cspan class=\x22hljs-string\x22\x3e\x22http:\/\/devimages.apple.com\/iphone\/samples\/bipbop\/bipbopall.m3u8\x22\x3c\/span\x3e type=\x3cspan class=\x22hljs-string\x22\x3e\x22application\/vnd.apple.mpegurl\x22\x3c\/span\x3e \/\x26gt; \n    \x26lt;\x3cspan class=\x22hljs-selector-tag\x22\x3ep\x3c\/span\x3e class=\x3cspan class=\x22hljs-string\x22\x3e\x22warning\x22\x3c\/span\x3e\x26gt;Your browser does not support HTML5 \x3cspan class=\x22hljs-selector-tag\x22\x3evideo\x3c\/span\x3e.\x26lt;\/p\x26gt;  \n\x26lt;\/video\x26gt;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e根据上面的描述，它实际上就是去请求一个 \x3ccode\x3e.m3u8\x3c\/code\x3e 的索引文件。该文件包含了对 \x3ccode\x3e.ts\x3c\/code\x3e 文件的相关描述，例如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22#EXT-X-VERSION:3            PlayList 的版本，可带可不带。下面有说明\n#EXTM3U                     m3u文件头\n#EXT-X-TARGETDURATION:10    分片最大时长，单位为 s\n#EXT-X-MEDIA-SEQUENCE:1     第一个TS分片的序列号，如果没有，默认为 0\n#EXT-X-ALLOW-CACHE          是否允许cache\n#EXT-X-ENDLIST              m3u8文件结束符\n#EXTINF                     指定每个媒体段(ts)的持续时间（秒），仅对其后面的URI有效\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-VERSION\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e            PlayList 的版本，可带可不带。下面有说明\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTM3U\x3c\/span\x3e                     m3u文件头\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-TARGETDURATION\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e    分片最大时长，单位为 s\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-MEDIA-SEQUENCE\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e     第一个TS分片的序列号，如果没有，默认为 \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-ALLOW-CACHE\x3c\/span\x3e          是否允许cache\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-ENDLIST\x3c\/span\x3e              m3u8文件结束符\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTINF\x3c\/span\x3e                     指定每个媒体段(ts)的持续时间（秒），仅对其后面的URI有效\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e不过，这只是一个非常简单，不涉及任何功能的直播流。实际上，HLS 的整个架构，可以分为：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916404?w=1061\x26amp;h=924\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916404?w=1061\x26amp;h=924\x22 alt=\x22stream_playlists_2x.png-35.5kB\x22 title=\x22stream_playlists_2x.png-35.5kB\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e当然，如果你使用的是 \x3ccode\x3emasterplaylist\x3c\/code\x3e 作为链接，如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cvideo controls autoplay\x3e  \n    \x3csource src=\x26quot;http:\/\/devimages.apple.com\/iphone\/samples\/bipbop\/masterplaylist.m3u8\x26quot; type=\x26quot;application\/vnd.apple.mpegurl\x26quot; \/\x3e \n    \x3cp class=\x26quot;warning\x26quot;\x3eYour browser does not support HTML5 video.\x3c\/p\x3e  \n\x3c\/video\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3e\x26lt;\x3cspan class=\x22hljs-selector-tag\x22\x3evideo\x3c\/span\x3e controls autoplay\x26gt;  \n    \x26lt;source src=\x3cspan class=\x22hljs-string\x22\x3e\x22http:\/\/devimages.apple.com\/iphone\/samples\/bipbop\/masterplaylist.m3u8\x22\x3c\/span\x3e type=\x3cspan class=\x22hljs-string\x22\x3e\x22application\/vnd.apple.mpegurl\x22\x3c\/span\x3e \/\x26gt; \n    \x26lt;\x3cspan class=\x22hljs-selector-tag\x22\x3ep\x3c\/span\x3e class=\x3cspan class=\x22hljs-string\x22\x3e\x22warning\x22\x3c\/span\x3e\x26gt;Your browser does not support HTML5 \x3cspan class=\x22hljs-selector-tag\x22\x3evideo\x3c\/span\x3e.\x26lt;\/p\x26gt;  \n\x26lt;\/video\x26gt;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们看一下，masterplaylist 里面具体的内容是啥：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22#EXTM3U\n#EXT-X-VERSION:6\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=2855600,CODECS=\x26quot;avc1.4d001f,mp4a.40.2\x26quot;,RESOLUTION=960x540\nlive\/medium.m3u8\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=5605600,CODECS=\x26quot;avc1.640028,mp4a.40.2\x26quot;,RESOLUTION=1280x720\nlive\/high.m3u8\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=1755600,CODECS=\x26quot;avc1.42001f,mp4a.40.2\x26quot;,RESOLUTION=640x360\nlive\/low.m3u8\n#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=545600,CODECS=\x26quot;avc1.42001e,mp4a.40.2\x26quot;,RESOLUTION=416x234\nlive\/cellular.m3u8\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTM3U\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-VERSION\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-STREAM-INF\x3c\/span\x3e:PROGRAM-ID=\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,BANDWIDTH=\x3cspan class=\x22hljs-number\x22\x3e2855600\x3c\/span\x3e,CODECS=\x3cspan class=\x22hljs-string\x22\x3e\x22avc1.4d001f,mp4a.40.2\x22\x3c\/span\x3e,RESOLUTION=\x3cspan class=\x22hljs-number\x22\x3e960\x3c\/span\x3ex540\nlive\/medium\x3cspan class=\x22hljs-selector-class\x22\x3e.m3u8\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-STREAM-INF\x3c\/span\x3e:PROGRAM-ID=\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,BANDWIDTH=\x3cspan class=\x22hljs-number\x22\x3e5605600\x3c\/span\x3e,CODECS=\x3cspan class=\x22hljs-string\x22\x3e\x22avc1.640028,mp4a.40.2\x22\x3c\/span\x3e,RESOLUTION=\x3cspan class=\x22hljs-number\x22\x3e1280\x3c\/span\x3ex720\nlive\/high\x3cspan class=\x22hljs-selector-class\x22\x3e.m3u8\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-STREAM-INF\x3c\/span\x3e:PROGRAM-ID=\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,BANDWIDTH=\x3cspan class=\x22hljs-number\x22\x3e1755600\x3c\/span\x3e,CODECS=\x3cspan class=\x22hljs-string\x22\x3e\x22avc1.42001f,mp4a.40.2\x22\x3c\/span\x3e,RESOLUTION=\x3cspan class=\x22hljs-number\x22\x3e640\x3c\/span\x3ex360\nlive\/low\x3cspan class=\x22hljs-selector-class\x22\x3e.m3u8\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-STREAM-INF\x3c\/span\x3e:PROGRAM-ID=\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e,BANDWIDTH=\x3cspan class=\x22hljs-number\x22\x3e545600\x3c\/span\x3e,CODECS=\x3cspan class=\x22hljs-string\x22\x3e\x22avc1.42001e,mp4a.40.2\x22\x3c\/span\x3e,RESOLUTION=\x3cspan class=\x22hljs-number\x22\x3e416\x3c\/span\x3ex234\nlive\/cellular.m3u8\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3eEXT-X-STREAM-INF\x3c\/code\x3e 这个标签头代表：当前用户的播放环境。masterplaylist 主要干的事就是根据, 当前用户的带宽，分辨率，解码器等条件决定使用哪一个流。所以，master playlist 是为了更好的用户体验而存在的。不过，弊端就是后台储备流的量会成倍增加。\x3cbr\x3e现在，我们来主要看一下,如果你使用 master playlist，那么整个流程是啥？\x3cbr\x3e当填写了 master playlist URL，那么用户只会下载一次该 master playlist。接着，播放器根据当前的环境决定使用哪一个 media playlist（就是 子 m3u8 文件）。如果，在播放当中，用户的播放条件发生变化时，播放器也会切换对应的 media playlist。关于 master playlist 内容，我们就先介绍到这里。\x3cbr\x3e关于 HLS，感觉主要内容还在 media playlist 上。当然，media playlist 还分为三种 list：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3elive playlist: 动态列表。顾名思义，该列表是动态变化的，里面的 ts 文件会实时更新，并且过期的 ts 索引会被删除。默认，情况下都是使用动态列表。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eevent playlist: 静态列表。它和动态列表主要区别就是，原来的 ts 文件索引不会被删除，该列表是不断更新，而且文件大小会逐渐增大。它会在文件中，直接添加 \x3ccode\x3e#EXT-X-PLAYLIST-TYPE:EVENT\x3c\/code\x3e 作为标识。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eVOD playlist: 全量列表。它就是将所有的 ts 文件都列在 list 当中。如果，使用该列表，就和播放一整个视频没有啥区别了。它是使用 \x3ccode\x3e#EXT-X-ENDLIST\x3c\/code\x3e 表示文件结尾。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cstrong\x3elive playlist DEMO：\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22#EXTM3U\n#EXT-X-VERSION:6\n#EXT-X-TARGETDURATION:10\n#EXT-X-MEDIA-SEQUENCE:26\n#EXTINF:9.901,\nhttp:\/\/media.example.com\/wifi\/segment26.ts\n#EXTINF:9.901,\nhttp:\/\/media.example.com\/wifi\/segment27.ts\n#EXTINF:9.501,\nhttp:\/\/media.example.com\/wifi\/segment28.ts\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTM3U\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-VERSION\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-TARGETDURATION\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-MEDIA-SEQUENCE\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e26\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTINF\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e9.901\x3c\/span\x3e,\nhttp:\x3cspan class=\x22hljs-comment\x22\x3e\/\/media.example.com\/wifi\/segment26.ts\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTINF\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e9.901\x3c\/span\x3e,\nhttp:\x3cspan class=\x22hljs-comment\x22\x3e\/\/media.example.com\/wifi\/segment27.ts\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTINF\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e9.501\x3c\/span\x3e,\nhttp:\x3cspan class=\x22hljs-comment\x22\x3e\/\/media.example.com\/wifi\/segment28.ts\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3eevet playlist DEMO：\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22#EXTM3U\n#EXT-X-VERSION:6\n#EXT-X-TARGETDURATION:10\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-PLAYLIST-TYPE:EVENT\n#EXTINF:9.9001,\nhttp:\/\/media.example.com\/wifi\/segment0.ts\n#EXTINF:9.9001,\nhttp:\/\/media.example.com\/wifi\/segment1.ts\n#EXTINF:9.9001,\nhttp:\/\/media.example.com\/wifi\/segment2.ts\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTM3U\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-VERSION\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-TARGETDURATION\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-MEDIA-SEQUENCE\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXT-X-PLAYLIST-TYPE\x3c\/span\x3e:EVENT\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTINF\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e9.9001\x3c\/span\x3e,\nhttp:\x3cspan class=\x22hljs-comment\x22\x3e\/\/media.example.com\/wifi\/segment0.ts\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTINF\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e9.9001\x3c\/span\x3e,\nhttp:\x3cspan class=\x22hljs-comment\x22\x3e\/\/media.example.com\/wifi\/segment1.ts\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-id\x22\x3e#EXTINF\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e9.9001\x3c\/span\x3e,\nhttp:\x3cspan class=\x22hljs-comment\x22\x3e\/\/media.example.com\/wifi\/segment2.ts\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3eVOD playlist DEMO：\x3c\/strong\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22#EXTM3U\n#EXT-X-VERSION:6\n#EXT-X-TARGETDURATION:10\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXTINF:9.9001,\nhttp:\/\/media.example.com\/wifi\/segment0.ts\n#EXTINF:9.9001,\nhttp:\/\/media.example.com\/wifi\/segment1.ts\n#EXTINF:9.9001,\nhttp:\/\/media.example.com\/wifi\/segment2.ts\n#EXT-X-ENDLIST\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs vala\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-meta\x22\x3e#EXTM3U\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e#EXT-X-VERSION:6\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e#EXT-X-TARGETDURATION:10\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e#EXT-X-MEDIA-SEQUENCE:0\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e#EXT-X-PLAYLIST-TYPE:VOD\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e#EXTINF:9.9001,\x3c\/span\x3e\nhttp:\x3cspan class=\x22hljs-comment\x22\x3e\/\/media.example.com\/wifi\/segment0.ts\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e#EXTINF:9.9001,\x3c\/span\x3e\nhttp:\x3cspan class=\x22hljs-comment\x22\x3e\/\/media.example.com\/wifi\/segment1.ts\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e#EXTINF:9.9001,\x3c\/span\x3e\nhttp:\x3cspan class=\x22hljs-comment\x22\x3e\/\/media.example.com\/wifi\/segment2.ts\x3c\/span\x3e\n\x3cspan class=\x22hljs-meta\x22\x3e#EXT-X-ENDLIST\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面提到过一个 \x3ccode\x3eEXT-X-VERSION\x3c\/code\x3e 这样的标签，这是用来表示当前 HLS 的版本。那 HLS 有哪些版本呢？\x3cbr\x3e根据 \x3ca href=\x22https:\/\/developer.apple.com\/library\/content\/referencelibrary\/GettingStarted\/AboutHTTPLiveStreaming\/about\/about.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eapple 官方文档\x3c\/a\x3e 的说明，我们可以了解到，不同版本的区别：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916405?w=623\x26amp;h=756\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916405?w=623\x26amp;h=756\x22 alt=\x22page.png-18.4kB\x22 title=\x22page.png-18.4kB\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e当然，HLS 支持的功能，并不只是分片播放（专门适用于直播），它还包括其他应有的功能。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e使用 HTTPS 加密 ts 文件\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e快\/倒放\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e广告插入\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e不同分辨率视频切换\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch4\x3eHLS 的弊端\x3c\/h4\x3e\n\x3cp\x3e由于 HLS 是基于 HTTP 的，所以，它关于 HTTP 的好处，我们大部分都了解，比如，高兼容性，高可扩展性等。不过正由于是 HTTP 协议，所以会在握手协议上造成一定的延迟性。HLS 首次连接时，总共的延时包括：\x3c\/p\x3e\n\x3col\x3e\x3cli\x3e\x3cp\x3eTCP 握手，2. m3u8 文件下载，3. m3u8 下的 ts 文件下载。\x3c\/p\x3e\x3c\/li\x3e\x3c\/ol\x3e\n\x3cp\x3e其中，每个 ts 文件，大概会存放 5s~10s 的时长，并且每个 m3u8 文件会存放 3~8 个 ts 文件。我们折中算一下，5 个 ts 文件，每个时长大约 8s 那么，总的下来，一共延时 40s。当然，这还不算上 TCP 握手，m3u8 文件下载等问题。那优化办法有吗？有的，那就是减少每个 m3u8 文件中的 ts 数量和 ts 文件时长，不过，这样也会成倍的增加后台承受流量请求的压力。所以，这还是需要到业务中去探索最优的配置（打个广告：腾讯云的直播视频流业务，做的确实挺棒。）\x3cbr\x3e关于 HLS 的详细内容，可以参考：\x3ca href=\x22https:\/\/developer.apple.com\/library\/content\/referencelibrary\/GettingStarted\/AboutHTTPLiveStreaming\/about\/about.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eHLS 详解\x3c\/a\x3e\x3cbr\x3e关于 m3u8 文件的标签内容，可以参考：\x3ca href=\x22https:\/\/tools.ietf.org\/html\/draft-pantos-http-live-streaming-20#section-4.3.4\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eHLS 标签头详解\x3c\/a\x3e\x3cbr\x3e总而言之，HLS 之所以能这么流行，关键在于它的支持度是真的广，所以，对于一般 H5 直播来说，应该是非常友好的。不过，既然是直播，关键在于它的实时性，而 HLS 天生就存在一定的延时，所以，就可以考虑其他低延时的方案，比如 RTMP，HTTP-FLV。下面，我们来看一下 RTMP 内容。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3eRTMP\x3c\/h3\x3e\n\x3cp\x3eRTMP 全称为：Real-Time Messaging Protocol 。它是专门应对实时交流场景而开发出来的一个协议。它爹是 \x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Macromedia\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eMacromedia\x3c\/a\x3e，后来卖身给了 Adobe。RTMP 根据不同的业务场景，有很多变种：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e纯 RTMP 使用 TCP 连接，默认端口为 1935（有可能被封）。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eRTMPS: 就是 RTMP \x2b TLS\/SSL\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eRTMPE: RTMP \x2b encryption。在 RTMP 原始协议上使用，Adobe 自身的加密方法\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eRTMPT: RTMP \x2b HTTP。使用 HTTP 的方式来包裹 RTMP 流，这样能直接通过防火墙。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eRTMFP: RMPT \x2b UDP。该协议常常用于 P2P 的场景中，针对延时有变态的要求。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e既然是 Adobe 公司开发的（算吧），那么，该协议针对的就是 Flash Video，即，FLV。不过，在移动端上，Flash Player 已经被杀绝了，那为啥还会出现这个呢？简单来说，它主要是针对 PC 端的。RTMP 出现的时候，还是 零几 年的时候，IE 还在大行其道，Flash Player 也并未被各大浏览器所排斥。那时候 RTMP 毋庸置疑的可以在视频界有自己的一席之地。\x3c\/p\x3e\n\x3cp\x3eRTMP 由于借由 TCP 长连接协议，所以，客户端向服务端推流这些操作而言，延时性很低。它会将上传的流分成不同的分片，这些分片的大小，有时候变，有时候不会变。默认情况下就是，64B 的音频数据 \x2b 128B 的视频数据 \x2b 其它数据（比如 头，协议标签等）。但 RTMP 具体传输的时候，会将分片进一步划分为包，即，视频包，音频包，协议包等。因为，RTMP 在进行传输的时候，会建立不同的通道，来进行数据的传输，这样对于不同的资源，对不同的通道设置相关的带宽上限。\x3c\/p\x3e\n\x3cp\x3eRTMP 处理的格式是 MP3\/ACC \x2b FLV1。\x3cbr\x3e不过，由于支持性的原因，RTMP 并未在 H5 直播中，展示出优势。下列是简单的对比：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916406?w=654\x26amp;h=101\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916406?w=654\x26amp;h=101\x22 alt=\x22dff.png-15.8kB\x22 title=\x22dff.png-15.8kB\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3eHTTP-FLV\x3c\/h3\x3e\n\x3cp\x3eHTTP-FLV 和 RTMPT 类似，都是针对于 FLV 视频格式做的直播分发流。但，两者有着很大的区别。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3cp\x3e相同点\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e两者都是针对 FLV 格式\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e两者延时都很低\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e两者都走的 HTTP 通道\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e不同点\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3cp\x3eHTTP-FLv\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e直接发起长连接，下载对应的 FLV 文件\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e头部信息简单\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3eRTMPT\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e握手协议过于复杂\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e分包，组包过程耗费精力大\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e通过上面来看，HTTP-FLV 和 RTMPT 确实不是一回事，但，如果了解 \x3ca href=\x22https:\/\/github.com\/ossrs\/srs\/wiki\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eSRS\x3c\/a\x3e（simple rtmp server），那么 对 HTTP-FLV 应该清楚不少。SRS 本质上，就是 RTMP \x2b FLV 进行传输。因为 RTMP 发的包很容易处理，通常 RTMP 协议会作为视频上传端来处理，然后经由服务器转换为 FLV 文件，通过 HTTP-FLV 下发给用户。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916407?w=571\x26amp;h=229\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916407?w=571\x26amp;h=229\x22 alt=\x22STRU.png-2.9kB\x22 title=\x22STRU.png-2.9kB\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e现在市面上，比较常用的就是 HTTP-FLV 进行播放。但，由于手机端上不支持，所以，H5 的 HTTP-FLV 也是一个痛点。不过，现在 \x3ca href=\x22https:\/\/github.com\/Bilibili\/flv.js?utm_source=tool.lu\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eflv.js\x3c\/a\x3e 可以帮助高版本的浏览器，通过 \x3ca href=\x22http:\/\/caniuse.com\/#search=mediasource\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3emediaSource\x3c\/a\x3e 来进行解析。HTTP-FLV 的使用方式也很简单。和 HLS 一样，只需要添加一个连接即可：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cobject type=\x26quot;application\/x-shockwave-flash\x26quot; src=\x26quot;http:\/\/s6.pdim.gs\/static\/a2a36bc596148316.flv\x26quot;\x3e\x3c\/object\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs nimrod\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3e\x26lt;\x3cspan class=\x22hljs-keyword\x22\x3eobject\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22application\/x-shockwave-flash\x22\x3c\/span\x3e src=\x3cspan class=\x22hljs-string\x22\x3e\x22http:\/\/s6.pdim.gs\/static\/a2a36bc596148316.flv\x22\x3c\/span\x3e\x26gt;\x26lt;\/\x3cspan class=\x22hljs-keyword\x22\x3eobject\x3c\/span\x3e\x26gt;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e不过，并不是末尾是 \x3ccode\x3e.flv\x3c\/code\x3e 的都是 HTTP-FLV 协议，因为，涉及 FLV 的流有\x3ca href=\x22https:\/\/github.com\/ossrs\/srs\/wiki\/v2_EN_DeliveryHttpStream%60\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e三种\x3c\/a\x3e，它们三种的使用方式都是一模一样的。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eFLV 文件：相当于就是一整个文件，官方称为 渐进 HTTP 流。它的特点是只能渐进下载，不能进行点播。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eFLV 伪流：该方式，可以通过在末尾添加 \x3ccode\x3e?start=xxx\x3c\/code\x3e 的参数，指定返回的对应开始时间视频数据。该方式比上面那种就多了一个点播的功能。本质上还是 FLV 直播。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eFLV 直播流：这就是 HTTP-FLV 真正所支持的流。SRS 在内部使用的是 RTMP 进行分发，然后在传给用户的使用，经过一层转换，变为 HTTP 流，最终传递给用户。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e上面说到，HTTP-FLV 就是长连接，简而言之只需要加上一个 \x3ccode\x3eConnection:keep-alive\x3c\/code\x3e 即可。关键是它的响应头，由于，HTTP-FLV 传递的是视频格式，所有，它的 \x3ccode\x3eContent-Type\x3c\/code\x3e 和 \x3ccode\x3eTransfer-Encoding\x3c\/code\x3e 需要设置其它值。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Content-Type:video\/x-flv\nExpires:Fri, 10 Feb 2017 05:24:03 GMT\nPragma:no-cache\nTransfer-Encoding:chunked\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs yaml\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-attr\x22\x3eContent-Type:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3evideo\/x-flv\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eExpires:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3eFri,\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3eFeb\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e2017\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e05\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e:24:03\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3eGMT\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3ePragma:\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3eno\x3c\/span\x3e\x3cspan class=\x22hljs-bullet\x22\x3e-cache\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eTransfer-Encoding:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3echunked\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e不过，一般而言，直播服务器一般和业务服务是不会放在一块的，所以这里，可能会额外需要支持跨域直播的相关技术。在 XHR2 里面，解决办法也很简单，直接使用 CORS 即可：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 那么整个响应头，可以为：\nAccess-Control-Allow-credentials:true\nAccess-Control-Allow-max-age:86400\nAccess-Control-Allow-methods:GET,POST,OPTIONS\nAccess-Control-Allow-Origin:*\nCache-Control:no-cache\nContent-Type:video\/x-flv\nExpires:Fri, 10 Feb 2017 05:24:03 GMT\nPragma:no-cache\nTransfer-Encoding:chunked\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs yaml\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-string\x22\x3e\/\/\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e那么整个响应头，可以为：\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eAccess-Control-Allow-credentials:\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eAccess-Control-Allow-max-age:\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e86400\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eAccess-Control-Allow-methods:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3eGET,POST,OPTIONS\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eAccess-Control-Allow-Origin:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e*\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eCache-Control:\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3eno\x3c\/span\x3e\x3cspan class=\x22hljs-bullet\x22\x3e-cache\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eContent-Type:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3evideo\/x-flv\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eExpires:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3eFri,\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e10\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3eFeb\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e2017\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e05\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e:24:03\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3eGMT\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3ePragma:\x3c\/span\x3e\x3cspan class=\x22hljs-literal\x22\x3eno\x3c\/span\x3e\x3cspan class=\x22hljs-bullet\x22\x3e-cache\x3c\/span\x3e\n\x3cspan class=\x22hljs-attr\x22\x3eTransfer-Encoding:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3echunked\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e对于 HTTP-FLV 来说，关键难点在于 RTMP 和 HTTP 协议的转换，这里我就不多说了。因为，我们主要针对的是前端开发，讲一下和前端相关的内容。\x3c\/p\x3e\n\x3cp\x3e接下来，我们在主要来介绍一下 FLV 格式的。因为，后面我们需要通过 mediaSource 来解码 FLV。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3eFLV 格式浅析\x3c\/h2\x3e\n\x3cp\x3eFLV 原始格式，Adobe 可以直接看 \x3ca href=\x22https:\/\/www.adobe.com\/content\/dam\/Adobe\/en\/devnet\/flv\/pdfs\/video_file_format_spec_v10.pdf\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eflv格式详解\x3c\/a\x3e。我这里就抽主要的内容讲讲。FLV 也是与时俱进，以前 FLV 的格式叫做 FLV，新版的可以叫做 F4V。两者的区别，简单的区分方法就是：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eFLV 是专门针对 Flash 播放器的\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eF4V 是有点像 MEPG 格式的 Flash 播放，主要为了兼容 H.264\/ACC。F4V 不支持 FLV（两者本来都不是同一个格式）\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e这里我们主要针对 FLV 进行相关了解。因为，一般情况下，后台发送视频流时，为了简洁快速，就是发送 FLV 视频。FLV 由于年限比较久，它所支持的内容是 H.263，VP6 codec。FLV 一般可以嵌套在 \x3ccode\x3e.swf\x3c\/code\x3e 文件当中，不过，对于 \x3ccode\x3eHTTP-FLV\x3c\/code\x3e 等 FLV 直播流来说，一般直接使用 \x3ccode\x3e.flv\x3c\/code\x3e 文件即可。在 07 年的时候，提出了 F4V 这个视频格式，当然，FLV 等也会向前兼容。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916408?w=832\x26amp;h=349\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916408?w=832\x26amp;h=349\x22 alt=\x22flv\x22 title=\x22flv\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e这里，我们来正式介绍一下 FLV 的格式。一个完整的 FLV 流包括 FLV Header \x2b FLV Packets。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3eFLV Header\x3c\/h3\x3e\n\x3cp\x3eFLV 格式头不难，就几个字段：\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth align=\x22left\x22\x3eField\x3c\/th\x3e\n\x3cth align=\x22left\x22\x3eData Type\x3c\/th\x3e\n\x3cth align=\x22left\x22\x3eDefault\x3c\/th\x3e\n\x3cth\x3eDetails\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eSignature\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3ebyte[3]\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e“FLV”\x3c\/td\x3e\n\x3ctd\x3e有三个B的大小,算是一种身份的象征\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eVersion\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3euint8\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e1\x3c\/td\x3e\n\x3ctd\x3e只有 0x01 是有效的。其实就是默认值\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eFlags\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3euint8 bitmask\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e0x05\x3c\/td\x3e\n\x3ctd\x3e表示该流的特征。0x04 是 audio，0x01 是 video，0x05 是 audio\x2bvideo\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eHeader Size\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3euint32_be\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e9\x3c\/td\x3e\n\x3ctd\x3e用来跳过多余的头\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3c\/tbody\x3e\n\x3c\/table\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3eFLV Packets\x3c\/h3\x3e\n\x3cp\x3e在 FLV 的头部之后，就正式开始发送 FLV 文件。文件会被拆解为数个包（FLV tags）进行传输。每个包都带有 15B 的头。前 4 个字节是用来代表前一个包的头部内容，用来完成倒放的功能。整个包的结构为：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916409?w=820\x26amp;h=360\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916409?w=820\x26amp;h=360\x22 alt=\x22FLV\x22 title=\x22FLV\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e具体解释如下：\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth align=\x22left\x22\x3e字段\x3c\/th\x3e\n\x3cth align=\x22left\x22\x3e字段大小\x3c\/th\x3e\n\x3cth align=\x22left\x22\x3e默认值\x3c\/th\x3e\n\x3cth align=\x22left\x22\x3e详解\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eSize of previous packet\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3euint32_be\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e0\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e关于前一个包的信息，如果是第一个包，则该部分为 NULL\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3ePacket Type\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3euint8\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e18\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e设置包的内容，如果是第一个包，则该部分为 AMF 元数据\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3ePayload Size\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3euint24_be\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3evaries\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e该包的大小\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eTimestamp Lower\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3euint24_be\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e0\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e起始时间戳\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eTimestamp Upper\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3euint8\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e0\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e持续时间戳，通常加上 Lower 实际上戳，代表整个时间。\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eStream ID\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3euint24_be\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e0\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e流的类型，第一个流设为 NULL\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3ePayload Data\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3efreeform\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3evaries\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e传输数据\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3c\/tbody\x3e\n\x3c\/table\x3e\n\x3cp\x3e其中，由于 Packet Type 的值可以取多个， 需要额外说明一下。\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\n\x3cp\x3ePacket Type\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e1: RTMP 包的大小\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e3: RTMP 字节读包反馈，RTMP ping，RTMP 服务器带宽，RTMP 客户端带宽\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e8: 音频和视频的数据\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e15: RTMP flex 流\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e24: 经过封装的 flash video。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e上面是关于 FLV 简单的介绍。不过，如果没有 `\x3cbr\x3eMedia Source Extensions` 的帮助，那么上面说的基本上全是废话。由于，Flash Player 已经被时代所遗弃，所以，我们不能在浏览器上，顺利的播放 FLV 视频。接下来，我们先来详细了解一下 MSE 的相关内容。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader10\x22\x3eMedia Source Extensions\x3c\/h2\x3e\n\x3cp\x3e在没有 MSE 出现之前，前端对 video 的操作，仅仅局限在对视频文件的操作，而并不能对视频流做任何相关的操作。现在 MSE 提供了一系列的\x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/MediaSource\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e接口\x3c\/a\x3e，使开发者可以直接提供 media stream。\x3c\/p\x3e\n\x3cp\x3e那 MSE 是如何完成视频流的加载和播放呢？\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader11\x22\x3e入门实例\x3c\/h3\x3e\n\x3cp\x3e这可以参考 google 的 \x3ca href=\x22https:\/\/developers.google.com\/web\/fundamentals\/getting-started\/primers\/media-source-extensions\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eMSE 简介\x3c\/a\x3e\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var vidElement = document.querySelector(\x27video\x27);\n\nif (window.MediaSource) {\n  var mediaSource = new MediaSource();\n  vidElement.src = URL.createObjectURL(mediaSource);\n  mediaSource.addEventListener(\x27sourceopen\x27, sourceOpen);\n} else {\n  console.log(\x26quot;The Media Source Extensions API is not supported.\x26quot;)\n}\n\nfunction sourceOpen(e) {\n  URL.revokeObjectURL(vidElement.src);\n  var mime = \x27video\/webm; codecs=\x26quot;opus, vp9\x26quot;\x27;\n  var mediaSource = e.target;\n  var sourceBuffer = mediaSource.addSourceBuffer(mime);\n  var videoUrl = \x27droid.webm\x27;\n  fetch(videoUrl)\n    .then(function(response) {\n      return response.arrayBuffer();\n    })\n    .then(function(arrayBuffer) {\n      sourceBuffer.addEventListener(\x27updateend\x27, function(e) {\n        if (!sourceBuffer.updating \x26amp;\x26amp; mediaSource.readyState === \x27open\x27) {\n          mediaSource.endOfStream();\n        }\n      });\n      sourceBuffer.appendBuffer(arrayBuffer);\n    });\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e vidElement = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.querySelector(\x3cspan class=\x22hljs-string\x22\x3e\x27video\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.MediaSource) {\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e mediaSource = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e MediaSource();\n  vidElement.src = URL.createObjectURL(mediaSource);\n  mediaSource.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27sourceopen\x27\x3c\/span\x3e, sourceOpen);\n} \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22The Media Source Extensions API is not supported.\x22\x3c\/span\x3e)\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esourceOpen\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ee\x3c\/span\x3e) \x3c\/span\x3e{\n  URL.revokeObjectURL(vidElement.src);\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e mime = \x3cspan class=\x22hljs-string\x22\x3e\x27video\/webm; codecs=\x22opus, vp9\x22\x27\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e mediaSource = e.target;\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sourceBuffer = mediaSource.addSourceBuffer(mime);\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e videoUrl = \x3cspan class=\x22hljs-string\x22\x3e\x27droid.webm\x27\x3c\/span\x3e;\n  fetch(videoUrl)\n    .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eresponse\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e response.arrayBuffer();\n    })\n    .then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3earrayBuffer\x3c\/span\x3e) \x3c\/span\x3e{\n      sourceBuffer.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27updateend\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ee\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!sourceBuffer.updating \x26amp;\x26amp; mediaSource.readyState === \x3cspan class=\x22hljs-string\x22\x3e\x27open\x27\x3c\/span\x3e) {\n          mediaSource.endOfStream();\n        }\n      });\n      sourceBuffer.appendBuffer(arrayBuffer);\n    });\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e可以从上面的代码看出，一套完整的执行代码，不仅需要使用 MSE 而且，还有一下这些相关的 API。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eHTMLVideoElement.getVideoPlaybackQuality()\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eSourceBuffer\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eSourceBufferList\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eTextTrack.sourceBuffer\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eTrackDefault\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eTrackDefaultList\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eURL.createObjectURL()\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eVideoPlaybackQuality\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eVideoTrack.sourceBuffer\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e我们简单讲解一下上面的流程。根据 google 的阐述，整个过程可以为：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916410?w=305\x26amp;h=250\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916410?w=305\x26amp;h=250\x22 alt=\x22image.png-16kB\x22 title=\x22image.png-16kB\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e第一步，通过异步拉取数据。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e第二步，通过 MediaSource 处理数据。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e第三步，将数据流交给 audio\/video 标签进行播放。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e而中间传递的数据都是通过 \x3ccode\x3eBuffer\x3c\/code\x3e 的形式来进行传递的。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000008916411?w=504\x26amp;h=574\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000008916411?w=504\x26amp;h=574\x22 alt=\x22image.png-29.5kB\x22 title=\x22image.png-29.5kB\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e中间有个需要注意的点，MS 的实例通过 \x3ccode\x3eURL.createObjectURL()\x3c\/code\x3e 创建的 url 并不会同步连接到 video.src。换句话说，\x3ccode\x3eURL.createObjectURL()\x3c\/code\x3e 只是将底层的流（MS）和 video.src 连接中间者，一旦两者连接到一起之后，该对象就没用了。\x3c\/p\x3e\n\x3cp\x3e那么什么时候 MS 才会和 video.src 连接到一起呢？\x3c\/p\x3e\n\x3cp\x3e创建实例都是同步的，但是底层流和 video.src 的连接时异步的。MS 提供了一个 \x3ccode\x3esourceopen\x3c\/code\x3e 事件给我们进行这项异步处理。一旦连接到一起之后，该 URL object 就没用了，处于内存节省的目的，可以使用 \x3ccode\x3eURL.revokeObjectURL(vidElement.src)\x3c\/code\x3e 销毁指定的 URL object。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22mediaSource.addEventListener(\x27sourceopen\x27, sourceOpen);\n\nfunction sourceOpen(){\n    URL.revokeObjectURL(vidElement.src)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3emediaSource.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27sourceopen\x27\x3c\/span\x3e, sourceOpen);\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esourceOpen\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e\x3c\/span\x3e{\n    URL.revokeObjectURL(vidElement.src)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3eMS 对流的解析\x3c\/h4\x3e\n\x3cp\x3eMS 提供了我们对底层音视频流的处理，那一开始我们怎么决定以何种格式进行编解码呢？\x3c\/p\x3e\n\x3cp\x3e这里，可以使用 \x3ccode\x3eaddSourceBuffer(mime)\x3c\/code\x3e 来设置相关的编码器：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  var mime = \x27video\/webm; codecs=\x26quot;opus, vp9\x26quot;\x27;  \n  var sourceBuffer = mediaSource.addSourceBuffer(mime);  \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs ebnf\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-attribute\x22\x3e  var mime\x3c\/span\x3e = \x3cspan class=\x22hljs-string\x22\x3e\x27video\/webm; codecs=\x22opus, vp9\x22\x27\x3c\/span\x3e;  \n\x3cspan class=\x22hljs-attribute\x22\x3e  var sourceBuffer\x3c\/span\x3e = mediaSource.addSourceBuffer(mime);  \x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后通过，异步拉取相关的音视频流：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fetch(url)\n.then(res=\x3e{\n    return res.arrayBuffer();\n})\n.then(buffer=\x3e{\n    sourceBuffer.appendBuffer(buffer);\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs coq\x22\x3e\x3ccode\x3efetch(url)\n.\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(res=\x26gt;{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e res.arrayBuffer();\n})\n.\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e(buffer=\x26gt;{\n    sourceBuffer.appendBuffer(buffer);\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果视频已经传完了，而相关的 Buffer 还在占用内存，这时候，就需要我们显示的中断当前的 Buffer 内容。那么最终我们的异步处理结果变为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22fetch(url)\n.then(res=\x3e{\n    return res.arrayBuffer();\n})\n.then(function(arrayBuffer) {\n      sourceBuffer.addEventListener(\x27updateend\x27, function(e) {\n      \/\/ 是否有持续更新的流\n        if (!sourceBuffer.updating \x26amp;\x26amp; mediaSource.readyState === \x27open\x27) {\n        \/\/ 没有，则中断连接\n          mediaSource.endOfStream();\n        }\n      });\n      sourceBuffer.appendBuffer(arrayBuffer);\n    });\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3efetch(url)\n.then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e=\x26gt;\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e res.arrayBuffer();\n})\n.then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3earrayBuffer\x3c\/span\x3e) \x3c\/span\x3e{\n      sourceBuffer.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27updateend\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ee\x3c\/span\x3e) \x3c\/span\x3e{\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 是否有持续更新的流\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!sourceBuffer.updating \x26amp;\x26amp; mediaSource.readyState === \x3cspan class=\x22hljs-string\x22\x3e\x27open\x27\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 没有，则中断连接\x3c\/span\x3e\n          mediaSource.endOfStream();\n        }\n      });\n      sourceBuffer.appendBuffer(arrayBuffer);\n    });\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面我们大致了解了一下关于 Media Source Extensions 的大致流程，但里面的细节我们还没有细讲。接下来，我们来具体看一下 MSE 一篮子的生态技术包含哪些内容。首先是，MediaSource\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader12\x22\x3eMediaSource\x3c\/h2\x3e\n\x3cp\x3eMS(MediaSource) 可以理解为多个视频流的管理工具。以前，我们只能下载一个清晰度的流，并且不能平滑切换低画质或者高画质的流，而现在我们可以利用 MS 实现这里特性。我们先来简单了解一下他的 API。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader13\x22\x3eMS 的创建\x3c\/h3\x3e\n\x3cp\x3e创建一个 MS:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var mediaSource = new MediaSource();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs haxe\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e mediaSource = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eMediaSource\x3c\/span\x3e();\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader14\x22\x3e相关方法\x3c\/h3\x3e\n\x3ch4\x3eaddSourceBuffer()\x3c\/h4\x3e\n\x3cp\x3e该是用来返回一个具体的视频流，接受一个 mimeType 表示该流的编码格式。例如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var mimeType = \x27video\/mp4; codecs=\x26quot;avc1.42E01E, mp4a.40.2\x26quot;\x27;\nvar sourceBuffer = mediaSource.addSourceBuffer(mimeType);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs ebnf\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-attribute\x22\x3evar mimeType\x3c\/span\x3e = \x3cspan class=\x22hljs-string\x22\x3e\x27video\/mp4; codecs=\x22avc1.42E01E, mp4a.40.2\x22\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-attribute\x22\x3evar sourceBuffer\x3c\/span\x3e = mediaSource.addSourceBuffer(mimeType);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3esourceBuffer 是直接和视频流有交集的 API。例如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function sourceOpen (_) {\n  var mediaSource = this;\n  var sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);\n  fetchAB(assetURL, function (buf) {\n    sourceBuffer.addEventListener(\x27updateend\x27, function (_) {\n      mediaSource.endOfStream();\n      video.play();\n    });\n    \/\/ 通过 fetch 添加视频 Buffer\n    sourceBuffer.appendBuffer(buf);\n  });\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esourceOpen\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(_)\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e mediaSource = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);\n  fetchAB(assetURL, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(buf)\x3c\/span\x3e \x3c\/span\x3e{\n    sourceBuffer.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27updateend\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(_)\x3c\/span\x3e \x3c\/span\x3e{\n      mediaSource.endOfStream();\n      video.play();\n    });\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 通过 fetch 添加视频 Buffer\x3c\/span\x3e\n    sourceBuffer.appendBuffer(buf);\n  });\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e它通过 \x3ccode\x3eappendBuffer\x3c\/code\x3e 直接添加视频流，实现播放。不过，在使用 \x3ccode\x3eaddSourceBuffer\x3c\/code\x3e 创建之前，还需要保证当前浏览器是否支持该编码格式。\x3c\/p\x3e\n\x3ch4\x3eremoveSourceBuffer()\x3c\/h4\x3e\n\x3cp\x3e用来移除某个 sourceBuffer。移除也主要是考虑性能原因，将不需要的流移除以节省相应的空间，格式为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22mediaSource.removeSourceBuffer(sourceBuffer);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs abnf\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3emediaSource.removeSourceBuffer(sourceBuffer)\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3eendOfStream()\x3c\/h4\x3e\n\x3cp\x3e用来表示接受的视频流的停止，注意，这里并不是断开，相当于只是下好了一部分视频，然后你可以进行播放。此时，MS 的状态变为：\x3ccode\x3eended\x3c\/code\x3e。例如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\n  var mediaSource = this;\n  var sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);\n  fetchAB(assetURL, function (buf) {\n    sourceBuffer.addEventListener(\x27updateend\x27, function (_) {\n      mediaSource.endOfStream(); \/\/ 结束当前的接受\n      video.play(); \/\/ 可以播放当前获得的流\n    });\n    sourceBuffer.appendBuffer(buf);\n  });\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e mediaSource = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);\n  fetchAB(assetURL, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(buf)\x3c\/span\x3e \x3c\/span\x3e{\n    sourceBuffer.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27updateend\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(_)\x3c\/span\x3e \x3c\/span\x3e{\n      mediaSource.endOfStream(); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 结束当前的接受\x3c\/span\x3e\n      video.play(); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 可以播放当前获得的流\x3c\/span\x3e\n    });\n    sourceBuffer.appendBuffer(buf);\n  });\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3eisTypeSupported()\x3c\/h4\x3e\n\x3cp\x3e该是用来检测当前浏览器是否支持指定视频格式的解码。格式为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var isItSupported = mediaSource.isTypeSupported(mimeType); \/\/ 返回值为 Boolean\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e isItSupported = mediaSource.isTypeSupported(mimeType); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回值为 Boolean\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3emimeType 可以为 type 或者 type \x2b codec。\x3c\/p\x3e\n\x3cp\x3e例如：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 不同的浏览器支持不一样，不过基本的类型都支持。\nMediaSource.isTypeSupported(\x27audio\/mp3\x27); \/\/ false，这里应该为 audio\/mpeg \nMediaSource.isTypeSupported(\x27video\/mp4\x27); \/\/ true\nMediaSource.isTypeSupported(\x27video\/mp4; codecs=\x26quot;avc1.4D4028, mp4a.40.2\x26quot;\x27); \/\/ true\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs less\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 不同的浏览器支持不一样，不过基本的类型都支持。\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3eMediaSource\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.isTypeSupported\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27audio\/mp3\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ false，这里应该为 audio\/mpeg \x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3eMediaSource\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.isTypeSupported\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27video\/mp4\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ true\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3eMediaSource\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.isTypeSupported\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27video\/mp4; codecs=\x22avc1.4D4028, mp4a.40.2\x22\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ true\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里有一份具体的 \x3ca href=\x22https:\/\/wiki.whatwg.org\/wiki\/Video_type_parameters#Browser_Support\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3emimeType\x3c\/a\x3e 参考列表。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader15\x22\x3eMS 的状态\x3c\/h3\x3e\n\x3cp\x3e当 MS 从创建开始，都会自带一个 \x3ccode\x3ereadyState\x3c\/code\x3e 属性，用来表示其当前打开的状态。MS 有三个状态：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eclosed: 当前 MS 没有和 media element(比如：video.src) 相关联。创建时，MS 就是该状态。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eopen: source 打开，并且准备接受通过 sourceBuffer.appendBuffer 添加的数据。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eended: 当 endOfStream() 执行完成，会变为该状态，此时，source 依然和 media element 连接。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var mediaSource = new MediaSource;\nmediaSource.readyState; \/\/ 默认为 closed\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs haxe\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e mediaSource = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eMediaSource\x3c\/span\x3e;\nmediaSource.readyState; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 默认为 closed\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当由 closed 变为 open 状态时，需要监听 \x3ccode\x3esourceopen\x3c\/code\x3e 事件。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22video.src = URL.createObjectURL(mediaSource);\nmediaSource.addEventListener(\x27sourceopen\x27, sourceOpen);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs mipsasm\x22\x3e\x3ccode\x3evideo.src = URL.createObjectURL(mediaSource)\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\nmediaSource.\x3cspan class=\x22hljs-keyword\x22\x3eaddEventListener(\x27sourceopen\x27, \x3c\/span\x3esourceOpen)\x3cspan class=\x22hljs-comment\x22\x3e;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eMS 针对这几个状态变化，提供了相关的事件：\x3ccode\x3esourceopen\x3c\/code\x3e，\x3ccode\x3esourceended\x3c\/code\x3e，\x3ccode\x3esourceclose\x3c\/code\x3e。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3esourceopen: 当  \x22closed\x22 to \x22open\x22 或者 \x22ended\x22 to \x22open\x22 时触发。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3esourceended: 当  \x22open\x22 to \x22ended\x22 时触发。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3esourceclose: 当 \x22open\x22 to \x22closed\x22 或者 \x22ended\x22 to \x22closed\x22 时触发。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3eMS 还提供了其他的监听事件 sourceopen，sourceended，sourceclose，updatestart，update，updateend，error，abort，addsourcebuffer，removesourcebuffer. 这里主要选了比较重要的，其他的可以参考官方文档。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader16\x22\x3eMS 属性\x3c\/h3\x3e\n\x3cp\x3e比较常用的属性有: duration，readyState。\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3eduration: 获得当前媒体播放的时间，既可以设置(get)，也可以获取(set)。单位为 s(秒)\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22mediaSource.duration = 5.5; \/\/ 设置媒体流播放的时间\nvar myDuration = mediaSource.duration; \/\/ 获得媒体流开始播放的时间\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lasso\x22\x3e\x3ccode\x3emediaSource.\x3cspan class=\x22hljs-built_in\x22\x3eduration\x3c\/span\x3e = \x3cspan class=\x22hljs-number\x22\x3e5.5\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 设置媒体流播放的时间\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3evar\x3c\/span\x3e myDuration = mediaSource.\x3cspan class=\x22hljs-built_in\x22\x3eduration\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 获得媒体流开始播放的时间\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在实际应用中为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22sourceBuffer.addEventListener(\x27updateend\x27, function (_) {\n      mediaSource.endOfStream();\n      mediaSource.duration = 120; \/\/ 设置当前流播放的时间\n      video.play();\n    });\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3esourceBuffer.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27updateend\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(_)\x3c\/span\x3e \x3c\/span\x3e{\n      mediaSource.endOfStream();\n      mediaSource.duration = \x3cspan class=\x22hljs-number\x22\x3e120\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 设置当前流播放的时间\x3c\/span\x3e\n      video.play();\n    });\x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3ereadyState: 获得当前 MS 的状态。取值上面已经讲过了: \x3ccode\x3eclosed\x3c\/code\x3e，\x3ccode\x3eopen\x3c\/code\x3e，\x3ccode\x3eended\x3c\/code\x3e。\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var mediaSource = new MediaSource;\n  \/\/此时的 mediaSource.readyState 状态为 closed\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs haxe\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e mediaSource = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eMediaSource\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/此时的 mediaSource.readyState 状态为 closed\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e以及：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22sourceBuffer.addEventListener(\x27updateend\x27, function (_) {\n      mediaSource.endOfStream(); \/\/ 调用该方法后结果为：ended\n      video.play();\n    });\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3esourceBuffer.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27updateend\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(_)\x3c\/span\x3e \x3c\/span\x3e{\n      mediaSource.endOfStream(); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 调用该方法后结果为：ended\x3c\/span\x3e\n      video.play();\n    });\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e除了上面两个属性外，还有 \x3ccode\x3esourceBuffers\x3c\/code\x3e，\x3ccode\x3eactiveSourceBuffers\x3c\/code\x3e 这两个属性。用来返回通过 \x3ccode\x3eaddSourceBuffer()\x3c\/code\x3e 创建的 SourceBuffer 数组。这没啥过多的难度。\x3c\/p\x3e\n\x3cp\x3e接下来我们就来看一下靠底层的 \x3ccode\x3esourceBuffer\x3c\/code\x3e。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader17\x22\x3eSourceBuffer\x3c\/h2\x3e\n\x3cp\x3eSourceBuffer 是由 \x3ccode\x3emediaSource\x3c\/code\x3e 创建，并直接和 \x3ccode\x3eHTMLMediaElement\x3c\/code\x3e 接触。简单来说，它就是一个流的容器，里面提供的 \x3ccode\x3eappend()\x3c\/code\x3e，\x3ccode\x3eremove()\x3c\/code\x3e 来进行流的操作，它可以包含一个或者多个 \x3ccode\x3emedia segments\x3c\/code\x3e。同样，接下来，我们再来看一下该构造函数上的基本属性和内容。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader18\x22\x3e基础内容\x3c\/h3\x3e\n\x3cp\x3e前面说过 sourceBuffer 主要是一个用来存放流的容器，那么，它是怎么存放的，它存放的内容是啥，有没有顺序等等。这些都是 sourceBuffer 最最根本的问题。OK，接下来，我们来看一下的它的基本架构有些啥。\x3c\/p\x3e\n\x3cp\x3e参考 \x3ca href=\x22https:\/\/www.w3.org\/TR\/media-source\/#sourcebuffer\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eW3C\x3c\/a\x3e，可以基本了解到里面的内容为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22interface SourceBuffer : EventTarget {\n             attribute AppendMode          mode;\n    readonly attribute boolean             updating;\n    readonly attribute TimeRanges          buffered;\n             attribute double              timestampOffset;\n    readonly attribute AudioTrackList      audioTracks;\n    readonly attribute VideoTrackList      videoTracks;\n    readonly attribute TextTrackList       textTracks;\n             attribute double              appendWindowStart;\n             attribute unrestricted double appendWindowEnd;\n             attribute EventHandler        onupdatestart;\n             attribute EventHandler        onupdate;\n             attribute EventHandler        onupdateend;\n             attribute EventHandler        onerror;\n             attribute EventHandler        onabort;\n    void appendBuffer(BufferSource data);\n    void abort();\n    void remove(double start, unrestricted double end);\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs glsl\x22\x3e\x3ccode\x3einterface SourceBuffer : EventTarget {\n             \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e AppendMode          mode;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereadonly\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e boolean             updating;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereadonly\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e TimeRanges          buffered;\n             \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3edouble\x3c\/span\x3e              timestampOffset;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereadonly\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e AudioTrackList      audioTracks;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereadonly\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e VideoTrackList      videoTracks;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereadonly\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e TextTrackList       textTracks;\n             \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3edouble\x3c\/span\x3e              appendWindowStart;\n             \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e unrestricted \x3cspan class=\x22hljs-type\x22\x3edouble\x3c\/span\x3e appendWindowEnd;\n             \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e EventHandler        onupdatestart;\n             \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e EventHandler        onupdate;\n             \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e EventHandler        onupdateend;\n             \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e EventHandler        onerror;\n             \x3cspan class=\x22hljs-keyword\x22\x3eattribute\x3c\/span\x3e EventHandler        onabort;\n    \x3cspan class=\x22hljs-type\x22\x3evoid\x3c\/span\x3e appendBuffer(BufferSource data);\n    \x3cspan class=\x22hljs-type\x22\x3evoid\x3c\/span\x3e abort();\n    \x3cspan class=\x22hljs-type\x22\x3evoid\x3c\/span\x3e remove(\x3cspan class=\x22hljs-type\x22\x3edouble\x3c\/span\x3e start, unrestricted \x3cspan class=\x22hljs-type\x22\x3edouble\x3c\/span\x3e end);\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面这些属性决定了其 sourceBuffer 整个基础。\x3c\/p\x3e\n\x3cp\x3e首先是 \x3ccode\x3emode\x3c\/code\x3e。上面说过，SB(SourceBuffer) 里面存储的是 media segments（就是你每次通过 append 添加进去的流片段）。SB.mode 有两种格式：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3esegments: 乱序排放。通过 \x3ccode\x3etimestamps\x3c\/code\x3e 来标识其具体播放的顺序。比如：20s的 buffer，30s 的 buffer 等。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3esequence: 按序排放。通过 \x3ccode\x3eappendBuffer\x3c\/code\x3e 的顺序来决定每个 mode 添加的顺序。\x3ccode\x3etimestamps\x3c\/code\x3e 根据 sequence 自动产生。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e那么上面两个哪个是默认值呢？\x3c\/p\x3e\n\x3cp\x3e看情况，讲真，没骗你。\x3c\/p\x3e\n\x3cp\x3e当 \x3ccode\x3emedia segments\x3c\/code\x3e 天生自带 \x3ccode\x3etimestamps\x3c\/code\x3e，那么 \x3ccode\x3emode\x3c\/code\x3e 就为 \x3ccode\x3esegments\x3c\/code\x3e ，否则为 \x3ccode\x3esequence\x3c\/code\x3e。所以，一般情况下，我们是不用管它的值。不过，你可以在后面，将 \x3ccode\x3esegments\x3c\/code\x3e 设置为 \x3ccode\x3esequence\x3c\/code\x3e 这个是没毛病的。反之，将 \x3ccode\x3esequence\x3c\/code\x3e 设置为 \x3ccode\x3esegments\x3c\/code\x3e 就有问题了。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var bufferMode = sourceBuffer.mode;\nif (bufferMode == \x27segments\x27) {\n  sourceBuffer.mode = \x27sequence\x27;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs bash\x22\x3e\x3ccode\x3evar bufferMode = \x3cspan class=\x22hljs-built_in\x22\x3esource\x3c\/span\x3eBuffer.mode;\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (bufferMode == \x3cspan class=\x22hljs-string\x22\x3e\x27segments\x27\x3c\/span\x3e) {\n  \x3cspan class=\x22hljs-built_in\x22\x3esource\x3c\/span\x3eBuffer.mode = \x3cspan class=\x22hljs-string\x22\x3e\x27sequence\x27\x3c\/span\x3e;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后另外两个就是 \x3ccode\x3ebuffered\x3c\/code\x3e 和 \x3ccode\x3eupdating\x3c\/code\x3e。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3ebuffered：返回一个 \x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/TimeRanges\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3etimeRange\x3c\/a\x3e 对象。用来表示当前被存储在 SB 中的 buffer。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eupdating: 返回 Boolean，表示当前 SB 是否正在被更新。例如: SourceBuffer.appendBuffer(), SourceBuffer.appendStream(), SourceBuffer.remove() 调用时。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e另外还有一些其他的相关属性，比如 textTracks,timestampOffset,trackDefaults，这里就不多说了。实际上，SB 是一个事件驱动的对象，一些常见的处理，都是在具体的事件中完成的。那么它又有哪些事件呢？\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader19\x22\x3e事件触发\x3c\/h3\x3e\n\x3cp\x3e在 SB 中，相关事件触发包括：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eupdatestart： 当 updating 由 false 变为 true。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eupdate：当 append()\/remove() 方法被成功调用完成时，updating 由 true 变为 false。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eupdateend: append()\/remove() 已经结束\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eerror: 在 append() 过程中发生错误，updating 由 true 变为 false。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eabort: 当 append()\/remove() 过程中，使用 \x3ccode\x3eabort()\x3c\/code\x3e 方法废弃时，会触发。此时，updating 由 true 变为 false。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e注意上面有两个事件比较类似：\x3ccode\x3eupdate\x3c\/code\x3e 和 \x3ccode\x3eupdateend\x3c\/code\x3e。都是表示处理的结束，不同的是，update 比 updateend 先触发。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22sourceBuffer.addEventListener(\x27updateend\x27, function (e) {\n    \/\/ 当指定的 buffer 加载完后，就可以开始播放\n      mediaSource.endOfStream();\n      video.play();\n    });\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs actionscript\x22\x3e\x3ccode\x3esourceBuffer.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27updateend\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-params\x22\x3e(e)\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 当指定的 buffer 加载完后，就可以开始播放\x3c\/span\x3e\n      mediaSource.endOfStream();\n      video.play();\n    });\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader20\x22\x3e相关方法\x3c\/h3\x3e\n\x3cp\x3eSB 处理流的方法就是 \x2b\/- ： appendBuffer, remove。另外还有一个中断处理函数 \x3ccode\x3eabort()\x3c\/code\x3e。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eappendBuffer(ArrayBuffer)：用来添加 ArrayBuffer。该 ArrayBuffer 一般是通过 fetch 的 \x3ccode\x3eresponse.arrayBuffer();\x3c\/code\x3e 来获取的。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3eremove(start, end)： 用来移除具体某段的 media segments。\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3e@param start\/end: 都是时间单位（s）。用来表示具体某段的 media segments 的范围。\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eabort(): 用来放弃当前 append 流的操作。不过，该方法的业务场景也比较有限。它只能用在当 SB 正在更新流的时候。即，此时通过 fetch,已经接受到新流，并且使用 appendBuffer 添加，此为开始的时间。然后到 updateend 事件触发之前，这段时间之内调用 \x3ccode\x3eabort()\x3c\/code\x3e。有一个业务场景是，当用户移动进度条，而，此时 fetch 已经获取前一次的 media segments，那么可以使用 \x3ccode\x3eabort\x3c\/code\x3e 放弃该操作，转而请求新的 media segments。具体可以参考：\x3ca href=\x22https:\/\/github.com\/nickdesaulniers\/netfix\/blob\/gh-pages\/demo\/bufferWhenNeeded.html#L92-L101\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eabort 使用\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e上面主要介绍了处理音视频流需要用的 Web 技术，后面章节，我们接入实战，具体来讲一下，如何做到使用 MSE 进行 remux 和 demux。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>全面进阶 H5 直播</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000008916399">https://segmentfault.com/a/1190000008916399</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/8hk4d2ujrx8/" target="_blank">https://alili.tech/archive/8hk4d2ujrx8/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/t42iv2yle7e/">2016-我的前端之路:工具化与工程化<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/xlhryjzdso/">2016年总结--成长<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/4wvjfeus9ur/">2016年末总结，我的前端之路<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/w7062tmcw3/">3D 视差效果<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/5jt1iw1t77b/">AlloyTouch实战--60行代码搞定QQ看点资料卡<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/kquf0fxkw2j/">ES6，你不得不学！<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/r5b6g4133jh/">Emmet-前端开发神器<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/5dbaikv4emi/">FreeCodeCamp中级算法题答案<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/iuyeljg6lm/">JSONP是什么<aside class="dates">2019-01-29</aside></a></li><li><a href="/archive/23ftsgrtzzc/">JS中的观察者模式(发布订阅)<aside class="dates">2019-01-29</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>