<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="并发服务器（一）：简介"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>并发服务器（一）：简介 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/kjduk29ztri/",
				"appid": "1613049289050283", 
				"title": "并发服务器（一）：简介 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-22T02:30:07"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/mp18c7w80r9/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/cz3dtad7ue/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f&text=%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e7%ae%80%e4%bb%8b"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f&text=%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e7%ae%80%e4%bb%8b"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f&title=%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e7%ae%80%e4%bb%8b"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f&is_video=false&description=%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e7%ae%80%e4%bb%8b"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e7%ae%80%e4%bb%8b&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f&title=%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e7%ae%80%e4%bb%8b"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f&title=%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e7%ae%80%e4%bb%8b"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f&title=%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e7%ae%80%e4%bb%8b"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fkjduk29ztri%2f&title=%e5%b9%b6%e5%8f%91%e6%9c%8d%e5%8a%a1%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e7%ae%80%e4%bb%8b"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">并发服务器（一）：简介</h1><div class="meta"><div class="postdate"><time datetime="2019-01-22" itemprop="datePublished">2019-01-22</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n            \x3ch1\x3e\x3ca href=\x22#并发服务器一简介\x22\x3e\x3c\/a\x3e并发服务器（一）：简介\x3c\/h1\x3e\n\x3cp\x3e这是关于并发网络服务器编程的第一篇教程。我计划测试几个主流的、可以同时处理多个客户端请求的服务器并发模型，基于可扩展性和易实现性对这些模型进行评判。所有的服务器都会监听套接字连接，并且实现一些简单的协议用于与客户端进行通讯。\x3c\/p\x3e\n\x3cp\x3e该系列的所有文章：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/eli.thegreenplace.net\/2017\/concurrent-servers-part-1-introduction\/\x22\x3e第一节 - 简介\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/eli.thegreenplace.net\/2017\/concurrent-servers-part-2-threads\/\x22\x3e第二节 - 线程\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/eli.thegreenplace.net\/2017\/concurrent-servers-part-3-event-driven\/\x22\x3e第三节 - 事件驱动\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3\x3e\x3ca href=\x22#协议\x22\x3e\x3c\/a\x3e协议\x3c\/h3\x3e\n\x3cp\x3e该系列教程所用的协议都非常简单，但足以展示并发服务器设计的许多有趣层面。而且这个协议是 \x3cem\x3e有状态的\x3c\/em\x3e —— 服务器根据客户端发送的数据改变内部状态，然后根据内部状态产生相应的行为。并非所有的协议都是有状态的 —— 实际上，基于 HTTP 的许多协议是无状态的，但是有状态的协议也是很常见，值得认真讨论。\x3c\/p\x3e\n\x3cp\x3e在服务器端看来，这个协议的视图是这样的：\x3c\/p\x3e\n\x3cp\x3e\x3ca href=\x22https:\/\/raw.githubusercontent.com\/LCTT\/wiki-images\/master\/TranslateProject\/ref_img\/005.png\x22\x3e\x3cimg src=\x22https:\/\/p0.ssl.qhimg.com\/t01bc465ffec2289a57.jpg\x22 alt=\x22\x22\x3e\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e总之：服务器等待新客户端的连接；当一个客户端连接的时候，服务器会向该客户端发送一个 \x3ccode\x3e*\x3c\/code\x3e 字符，进入“等待消息”的状态。在该状态下，服务器会忽略客户端发送的所有字符，除非它看到了一个 \x3ccode\x3e^\x3c\/code\x3e 字符，这表示一个新消息的开始。这个时候服务器就会转变为“正在通信”的状态，这时它会向客户端回送数据，把收到的所有字符的每个字节加 1 回送给客户端^注1 。当客户端发送了 \x3ccode\x3e$\x3c\/code\x3e 字符，服务器就会退回到等待新消息的状态。\x3ccode\x3e^\x3c\/code\x3e 和 \x3ccode\x3e$\x3c\/code\x3e 字符仅仅用于分隔消息 —— 它们不会被服务器回送。\x3c\/p\x3e\n\x3cp\x3e每个状态之后都有个隐藏的箭头指向 “等待客户端” 状态，用来客户端断开连接。因此，客户端要表示“我已经结束”的方法很简单，关掉它那一端的连接就好。\x3c\/p\x3e\n\x3cp\x3e显然，这个协议是真实协议的简化版，真实使用的协议一般包含复杂的报文头、转义字符序列（例如让消息体中可以出现 \x3ccode\x3e$\x3c\/code\x3e 符号），额外的状态变化。但是我们这个协议足以完成期望。\x3c\/p\x3e\n\x3cp\x3e另一点：这个系列是介绍性的，并假设客户端都工作的很好（虽然可能运行很慢）；因此没有设置超时，也没有设置特殊的规则来确保服务器不会因为客户端的恶意行为（或是故障）而出现阻塞，导致不能正常结束。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#顺序服务器\x22\x3e\x3c\/a\x3e顺序服务器\x3c\/h3\x3e\n\x3cp\x3e这个系列中我们的第一个服务端程序是一个简单的“顺序”服务器，用 C 进行编写，除了标准的 POSIX 中用于套接字的内容以外没有使用其它库。服务器程序是顺序，因为它一次只能处理一个客户端的请求；当有客户端连接时，像之前所说的那样，服务器会进入到状态机中，并且不再监听套接字接受新的客户端连接，直到当前的客户端结束连接。显然这不是并发的，而且即便在很少的负载下也不能服务多个客户端，但它对于我们的讨论很有用，因为我们需要的是一个易于理解的基础。\x3c\/p\x3e\n\x3cp\x3e这个服务器的完整代码在\x3ca href=\x22https:\/\/github.com\/eliben\/code-for-blog\/blob\/master\/2017\/async-socket-server\/sequential-server.c\x22\x3e这里\x3c\/a\x3e；接下来，我会着重于一些重点的部分。\x3ccode\x3emain\x3c\/code\x3e 函数里面的外层循环用于监听套接字，以便接受新客户端的连接。一旦有客户端进行连接，就会调用 \x3ccode\x3eserve_connection\x3c\/code\x3e，这个函数中的代码会一直运行，直到客户端断开连接。\x3c\/p\x3e\n\x3cp\x3e顺序服务器在循环里调用 \x3ccode\x3eaccept\x3c\/code\x3e 用来监听套接字，并接受新连接：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) {\n  \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3estruct\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esockaddr_in\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3epeer_addr\x3c\/span\x3e;\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3esocklen_t\x3c\/span\x3e peer_addr_len = \x3cspan class=\x22hljs-keyword\x22\x3esizeof\x3c\/span\x3e(peer_addr);\n\n  \x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e newsockfd =\n      accept(sockfd, (struct sockaddr*)\x26amp;peer_addr, \x26amp;peer_addr_len);\n\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (newsockfd \x26lt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {\n    perror_die(\x3cspan class=\x22hljs-string\x22\x3e\x22ERROR on accept\x22\x3c\/span\x3e);\n  }\n\n  report_peer_connected(\x26amp;peer_addr, peer_addr_len);\n  serve_connection(newsockfd);\n  \x3cspan class=\x22hljs-built_in\x22\x3eprintf\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22peer done\\n\x22\x3c\/span\x3e);\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e\x3ccode\x3eaccept\x3c\/code\x3e 函数每次都会返回一个新的已连接的套接字，然后服务器调用 \x3ccode\x3eserve_connection\x3c\/code\x3e；注意这是一个 \x3cem\x3e阻塞式\x3c\/em\x3e 的调用 —— 在 \x3ccode\x3eserve_connection\x3c\/code\x3e 返回前，\x3ccode\x3eaccept\x3c\/code\x3e 函数都不会再被调用了；服务器会被阻塞，直到客户端结束连接才能接受新的连接。换句话说，客户端按 _顺序_ 得到响应。\x3c\/p\x3e\n\x3cp\x3e这是 \x3ccode\x3eserve_connection\x3c\/code\x3e 函数：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs cpp\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3etypedef\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eenum\x3c\/span\x3e { WAIT_FOR_MSG, IN_MSG } ProcessingState;\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evoid\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eserve_connection\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(\x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e sockfd)\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (send(sockfd, \x3cspan class=\x22hljs-string\x22\x3e\x22*\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) \x26lt; \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) {\n    perror_die(\x3cspan class=\x22hljs-string\x22\x3e\x22send\x22\x3c\/span\x3e);\n  }\n\n  ProcessingState state = WAIT_FOR_MSG;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) {\n    \x3cspan class=\x22hljs-keyword\x22\x3euint8_t\x3c\/span\x3e buf[\x3cspan class=\x22hljs-number\x22\x3e1024\x3c\/span\x3e];\n    \x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e len = recv(sockfd, buf, \x3cspan class=\x22hljs-keyword\x22\x3esizeof\x3c\/span\x3e buf, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e);\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (len \x26lt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {\n      perror_die(\x3cspan class=\x22hljs-string\x22\x3e\x22recv\x22\x3c\/span\x3e);\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (len == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; len; \x2b\x2bi) {\n      \x3cspan class=\x22hljs-keyword\x22\x3eswitch\x3c\/span\x3e (state) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e WAIT_FOR_MSG:\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (buf[i] == \x3cspan class=\x22hljs-string\x22\x3e\x27^\x27\x3c\/span\x3e) {\n          state = IN_MSG;\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e IN_MSG:\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (buf[i] == \x3cspan class=\x22hljs-string\x22\x3e\x27$\x27\x3c\/span\x3e) {\n          state = WAIT_FOR_MSG;\n        } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n          buf[i] \x2b= \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n          \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (send(sockfd, \x26amp;buf[i], \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) \x26lt; \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e) {\n            perror(\x3cspan class=\x22hljs-string\x22\x3e\x22send error\x22\x3c\/span\x3e);\n            close(sockfd);\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n          }\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e;\n      }\n    }\n  }\n\n  close(sockfd);\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e它完全是按照状态机协议进行编写的。每次循环的时候，服务器尝试接收客户端的数据。收到 0 字节意味着客户端断开连接，然后循环就会退出。否则，会逐字节检查接收缓存，每一个字节都可能会触发一个状态。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3erecv\x3c\/code\x3e 函数返回接收到的字节数与客户端发送消息的数量完全无关（\x3ccode\x3e^...$\x3c\/code\x3e 闭合序列的字节）。因此，在保持状态的循环中遍历整个缓冲区很重要。而且，每一个接收到的缓冲中可能包含多条信息，但也有可能开始了一个新消息，却没有显式的结束字符；而这个结束字符可能在下一个缓冲中才能收到，这就是处理状态在循环迭代中进行维护的原因。\x3c\/p\x3e\n\x3cp\x3e例如，试想主循环中的 \x3ccode\x3erecv\x3c\/code\x3e 函数在某次连接中返回了三个非空的缓冲：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3ccode\x3e^abc$de^abte$f\x3c\/code\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ccode\x3exyz^123\x3c\/code\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ccode\x3e25$^ab$abab\x3c\/code\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e服务端返回的是哪些数据？追踪代码对于理解状态转变很有用。（答案见^注\x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Mealy_machine\x22\x3e2\x3c\/a\x3e ）\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#多个并发客户端\x22\x3e\x3c\/a\x3e多个并发客户端\x3c\/h3\x3e\n\x3cp\x3e如果多个客户端在同一时刻向顺序服务器发起连接会发生什么事情？\x3c\/p\x3e\n\x3cp\x3e服务器端的代码（以及它的名字 “顺序服务器”）已经说的很清楚了，一次只能处理 _一个_ 客户端的请求。只要服务器在 \x3ccode\x3eserve_connection\x3c\/code\x3e 函数中忙于处理客户端的请求，就不会接受别的客户端的连接。只有当前的客户端断开了连接，\x3ccode\x3eserve_connection\x3c\/code\x3e 才会返回，然后最外层的循环才能继续执行接受其他客户端的连接。\x3c\/p\x3e\n\x3cp\x3e为了演示这个行为，\x3ca href=\x22https:\/\/github.com\/eliben\/code-for-blog\/tree\/master\/2017\/async-socket-server\x22\x3e该系列教程的示例代码\x3c\/a\x3e 包含了一个 Python 脚本，用于模拟几个想要同时连接服务器的客户端。每一个客户端发送类似之前那样的三个数据缓冲 ^注3 ，不过每次发送数据之间会有一定延迟。\x3c\/p\x3e\n\x3cp\x3e客户端脚本在不同的线程中并发地模拟客户端行为。这是我们的序列化服务器与客户端交互的信息记录：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs dns\x22\x3e$ python3.\x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3e simple-client.py  -n \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e localhost \x3cspan class=\x22hljs-number\x22\x3e9090\x3c\/span\x3e\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:17,763\x3c\/span\x3e:conn1 connected...\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:17,763\x3c\/span\x3e:conn1 sending b\x27^abc$de^abte$f\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:17,763\x3c\/span\x3e:conn1 received b\x27b\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:17,802\x3c\/span\x3e:conn1 received b\x27cdbcuf\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:18,764\x3c\/span\x3e:conn1 sending b\x27xyz^\x3cspan class=\x22hljs-number\x22\x3e123\x3c\/span\x3e\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:18,764\x3c\/span\x3e:conn1 received b\x27\x3cspan class=\x22hljs-number\x22\x3e234\x3c\/span\x3e\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:19,764\x3c\/span\x3e:conn1 sending b\x27\x3cspan class=\x22hljs-number\x22\x3e25\x3c\/span\x3e$^ab0000$abab\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:19,765\x3c\/span\x3e:conn1 received b\x27\x3cspan class=\x22hljs-number\x22\x3e36\x3c\/span\x3ebc1111\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:19,965\x3c\/span\x3e:conn1 disconnecting\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:19,966\x3c\/span\x3e:conn2 connected...\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:19,967\x3c\/span\x3e:conn2 sending b\x27^abc$de^abte$f\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:19,967\x3c\/span\x3e:conn2 received b\x27b\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:20,006\x3c\/span\x3e:conn2 received b\x27cdbcuf\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:20,968\x3c\/span\x3e:conn2 sending b\x27xyz^\x3cspan class=\x22hljs-number\x22\x3e123\x3c\/span\x3e\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:20,969\x3c\/span\x3e:conn2 received b\x27\x3cspan class=\x22hljs-number\x22\x3e234\x3c\/span\x3e\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:21,970\x3c\/span\x3e:conn2 sending b\x27\x3cspan class=\x22hljs-number\x22\x3e25\x3c\/span\x3e$^ab0000$abab\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:21,970\x3c\/span\x3e:conn2 received b\x27\x3cspan class=\x22hljs-number\x22\x3e36\x3c\/span\x3ebc1111\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14:14:22,171\x3c\/span\x3e:conn2 disconnecting\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14:14:22,171\x3c\/span\x3e:conn0 connected...\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14:14:22,172\x3c\/span\x3e:conn0 sending b\x27^abc$de^abte$f\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14:14:22,172\x3c\/span\x3e:conn0 received b\x27b\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14:14:22,210\x3c\/span\x3e:conn0 received b\x27cdbcuf\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14:14:23,173\x3c\/span\x3e:conn0 sending b\x27xyz^\x3cspan class=\x22hljs-number\x22\x3e123\x3c\/span\x3e\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14:14:23,174\x3c\/span\x3e:conn0 received b\x27\x3cspan class=\x22hljs-number\x22\x3e234\x3c\/span\x3e\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14:14:24,175\x3c\/span\x3e:conn0 sending b\x27\x3cspan class=\x22hljs-number\x22\x3e25\x3c\/span\x3e$^ab0000$abab\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14:14:24,176\x3c\/span\x3e:conn0 received b\x27\x3cspan class=\x22hljs-number\x22\x3e36\x3c\/span\x3ebc1111\x27\nINFO:\x3cspan class=\x22hljs-number\x22\x3e2017-09-16\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e14\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e14:24,376\x3c\/span\x3e:conn0 disconnecting\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这里要注意连接名：\x3ccode\x3econn1\x3c\/code\x3e 是第一个连接到服务器的，先跟服务器交互了一段时间。接下来的连接 \x3ccode\x3econn2\x3c\/code\x3e —— 在第一个断开连接后，连接到了服务器，然后第三个连接也是一样。就像日志显示的那样，每一个连接让服务器变得繁忙，持续了大约 2.2 秒的时间（这实际上是人为地在客户端代码中加入的延迟），在这段时间里别的客户端都不能连接。\x3c\/p\x3e\n\x3cp\x3e显然，这不是一个可扩展的策略。这个例子中，客户端中加入了延迟，让服务器不能处理别的交互动作。一个智能服务器应该能处理一堆客户端的请求，而这个原始的服务器在结束连接之前一直繁忙（我们将会在之后的章节中看到如何实现智能的服务器）。尽管服务端有延迟，但这不会过度占用 CPU；例如，从数据库中查找信息（时间基本上是花在连接到数据库服务器上，或者是花在硬盘中的本地数据库）。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#总结及期望\x22\x3e\x3c\/a\x3e总结及期望\x3c\/h3\x3e\n\x3cp\x3e这个示例服务器达成了两个预期目标：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e首先是介绍了问题范畴和贯彻该系列文章的套接字编程基础。\x3c\/li\x3e\n\x3cli\x3e对于并发服务器编程的抛砖引玉 —— 就像之前的部分所说，顺序服务器还不能在非常轻微的负载下进行扩展，而且没有高效的利用资源。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e在看下一篇文章前，确保你已经理解了这里所讲的服务器\/客户端协议，还有顺序服务器的代码。我之前介绍过了这个简单的协议；例如 \x3ca href=\x22http:\/\/eli.thegreenplace.net\/2009\/08\/12\/framing-in-serial-communications\/\x22\x3e串行通信分帧\x3c\/a\x3e 和 \x3ca href=\x22http:\/\/eli.thegreenplace.net\/2009\/08\/29\/co-routines-as-an-alternative-to-state-machines\x22\x3e用协程来替代状态机\x3c\/a\x3e。要学习套接字网络编程的基础，\x3ca href=\x22http:\/\/beej.us\/guide\/bgnet\/\x22\x3eBeej 的教程\x3c\/a\x3e 用来入门很不错，但是要深入理解我推荐你还是看本书。\x3c\/p\x3e\n\x3cp\x3e如果有什么不清楚的，请在评论区下进行评论或者向我发送邮件。深入理解并发服务器！\x3c\/p\x3e\n\x3chr\x3e\n\x3cul\x3e\n\x3cli\x3e注1：状态转变中的 In\/Out 记号是指 \x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Mealy_machine\x22\x3eMealy machine\x3c\/a\x3e。\x3c\/li\x3e\n\x3cli\x3e注2：回应的是 \x3ccode\x3ebcdbcuf23436bc\x3c\/code\x3e。\x3c\/li\x3e\n\x3cli\x3e注3：这里在结尾处有一点小区别，加了字符串 \x3ccode\x3e0000\x3c\/code\x3e —— 服务器回应这个序列，告诉客户端让其断开连接；这是一个简单的握手协议，确保客户端有足够的时间接收到服务器发送的所有回复。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3chr\x3e\n\x3cp\x3evia: \x3ca href=\x22https:\/\/eli.thegreenplace.net\/2017\/concurrent-servers-part-1-introduction\/\x22\x3ehttps:\/\/eli.thegreenplace.net\/2017\/concurrent-servers-part-1-introduction\/\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e作者：\x3ca href=\x22https:\/\/eli.thegreenplace.net\/pages\/about\x22\x3eEli Bendersky\x3c\/a\x3e 译者：\x3ca href=\x22https:\/\/github.com\/GitFuture\x22\x3eGitFuture\x3c\/a\x3e 校对：\x3ca href=\x22https:\/\/github.com\/wxy\x22\x3ewxy\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e本文由 \x3ca href=\x22https:\/\/github.com\/LCTT\/TranslateProject\x22\x3eLCTT\x3c\/a\x3e 原创编译，\x3ca href=\x22https:\/\/linux.cn\/\x22\x3eLinux中国\x3c\/a\x3e 荣誉推出\x3c\/p\x3e\n\n          \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>并发服务器（一）：简介</p><h2 id="原文链接">原文链接</h2><p><a href="https://www.zcfy.cc/article/concurrent-servers-part-1-introduction">https://www.zcfy.cc/article/concurrent-servers-part-1-introduction</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/kjduk29ztri/" target="_blank">https://alili.tech/archive/kjduk29ztri/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5328xogjarn/">IndexedDB--HTML5本地存储<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/xpccu0hsqbr/">JS学习系列 01 - 编译原理和作用域<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/shv09bbtbfd/">Vue2 SSR 的优化之旅<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/5vj1ojfo6h6/">[2016年末巨献] — HTML5可交互地铁线路图（第二季：帝都进阶版）<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/m02hlm4bzh/">vue2.0开发聊天程序（三）组件的通信<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/mz5o7n90plg/">《很高兴我没有猝死》- 前端新人的 2016 年总结和感悟<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/3vhoe2mo09k/">一道颇有难度的JavaScript题<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/uj12mb7thp/">使用CANVAS实现交互性圆形马赛克效果<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/ja636h8hcxa/">写于 2016 年末<aside class="dates">2019-01-28</aside></a></li><li><a href="/archive/5uomnoq1kmi/">前端学习资源整理<aside class="dates">2019-01-28</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>