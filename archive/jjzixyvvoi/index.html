<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="Linux 中的 DTrace ：BPF 进入 4.9 内核"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>Linux 中的 DTrace ：BPF 进入 4.9 内核 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/jjzixyvvoi/",
				"appid": "1613049289050283", 
				"title": "Linux 中的 DTrace ：BPF 进入 4.9 内核 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-25T02:30:23"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/378mgqslkvt/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/8x2p8kdm04b/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f&text=Linux%20%e4%b8%ad%e7%9a%84%20DTrace%20%ef%bc%9aBPF%20%e8%bf%9b%e5%85%a5%204.9%20%e5%86%85%e6%a0%b8"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f&text=Linux%20%e4%b8%ad%e7%9a%84%20DTrace%20%ef%bc%9aBPF%20%e8%bf%9b%e5%85%a5%204.9%20%e5%86%85%e6%a0%b8"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f&title=Linux%20%e4%b8%ad%e7%9a%84%20DTrace%20%ef%bc%9aBPF%20%e8%bf%9b%e5%85%a5%204.9%20%e5%86%85%e6%a0%b8"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f&is_video=false&description=Linux%20%e4%b8%ad%e7%9a%84%20DTrace%20%ef%bc%9aBPF%20%e8%bf%9b%e5%85%a5%204.9%20%e5%86%85%e6%a0%b8"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Linux%20%e4%b8%ad%e7%9a%84%20DTrace%20%ef%bc%9aBPF%20%e8%bf%9b%e5%85%a5%204.9%20%e5%86%85%e6%a0%b8&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f&title=Linux%20%e4%b8%ad%e7%9a%84%20DTrace%20%ef%bc%9aBPF%20%e8%bf%9b%e5%85%a5%204.9%20%e5%86%85%e6%a0%b8"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f&title=Linux%20%e4%b8%ad%e7%9a%84%20DTrace%20%ef%bc%9aBPF%20%e8%bf%9b%e5%85%a5%204.9%20%e5%86%85%e6%a0%b8"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f&title=Linux%20%e4%b8%ad%e7%9a%84%20DTrace%20%ef%bc%9aBPF%20%e8%bf%9b%e5%85%a5%204.9%20%e5%86%85%e6%a0%b8"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fjjzixyvvoi%2f&title=Linux%20%e4%b8%ad%e7%9a%84%20DTrace%20%ef%bc%9aBPF%20%e8%bf%9b%e5%85%a5%204.9%20%e5%86%85%e6%a0%b8"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Linux 中的 DTrace ：BPF 进入 4.9 内核</h1><div class="meta"><div class="postdate"><time datetime="2019-01-25" itemprop="datePublished">2019-01-25</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n            \x3ch1\x3e\x3ca href=\x22#linux-中的-dtrace-bpf-进入-49-内核\x22\x3e\x3c\/a\x3eLinux 中的 DTrace ：BPF 进入 4.9 内核\x3c\/h1\x3e\n\x3cp\x3e随着 BPF 追踪系统（基于时间采样）最后一个主要功能被合并至 Linux 4.9-rc1 版本的内核中，现在 Linux 内核拥有类似 DTrace 的原生追踪功能。DTrace 是 Solaris 系统中的高级追踪器。对于长期使用 DTrace 的用户和专家，这将是一个振奋人心的里程碑！现在在 Linux 系统上，你可以在生产环境中使用安全的、低负载的定制追踪系统，通过执行时间的柱状图和频率统计等信息，分析应用的性能以及内核。\x3c\/p\x3e\n\x3cp\x3e用于 Linux 的追踪项目有很多，但是这个最终被合并进 Linux 内核的技术从一开始就根本不是一个追踪项目：它是最开始是用于伯克利包过滤器（Berkeley Packet Filter）（BPF）的增强功能。这些补丁允许 BPF 重定向数据包，从而创建软件定义网络（SDN）。久而久之，对事件追踪的支持就被添加进来了，使得程序追踪可用于 Linux 系统。\x3c\/p\x3e\n\x3cp\x3e尽管目前 BPF 没有像 DTrace 一样的高级语言，但它所提供的前端已经足够让我创建很多 BPF 工具了，其中有些是基于我以前的 \x3ca href=\x22https:\/\/github.com\/opendtrace\/toolkit\x22\x3eDTraceToolkit\x3c\/a\x3e。这个帖子将告诉你怎么去用这些 BPF 提供的前端工具，以及畅谈这项技术将会何去何从。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#示例\x22\x3e\x3c\/a\x3e示例\x3c\/h3\x3e\n\x3cp\x3e我已经将基于 BPF 的追踪工具添加到了开源的 \x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\x22\x3ebcc\x3c\/a\x3e 项目里（感谢 PLUMgrid 公司的 Brenden Blanco 带领 bcc 项目的发展）。详见 \x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\/blob\/master\/INSTALL.md\x22\x3ebcc 安装\x3c\/a\x3e 手册。它会在 \x3ccode\x3e\/usr\/share\/bcc\/tools\x3c\/code\x3e 目录下添加一系列工具，包括接下来的那些工具。\x3c\/p\x3e\n\x3cp\x3e捕获新进程：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs lsl\x22\x3e# execsnoop\nPCOMM            PID    RET ARGS\nbash             \x3cspan class=\x22hljs-number\x22\x3e15887\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \/usr\/bin\/man ls\npreconv          \x3cspan class=\x22hljs-number\x22\x3e15894\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \/usr\/bin\/preconv -e UTF\x3cspan class=\x22hljs-number\x22\x3e-8\x3c\/span\x3e\nman              \x3cspan class=\x22hljs-number\x22\x3e15896\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \/usr\/bin\/tbl\nman              \x3cspan class=\x22hljs-number\x22\x3e15897\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \/usr\/bin\/nroff -mandoc -rLL=\x3cspan class=\x22hljs-number\x22\x3e169\x3c\/span\x3en -rLT=\x3cspan class=\x22hljs-number\x22\x3e169\x3c\/span\x3en -Tutf8\nman              \x3cspan class=\x22hljs-number\x22\x3e15898\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \/usr\/bin\/pager -s\nnroff            \x3cspan class=\x22hljs-number\x22\x3e15900\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \/usr\/bin\/locale charmap\nnroff            \x3cspan class=\x22hljs-number\x22\x3e15901\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \/usr\/bin\/groff -mtty-char -Tutf8 -mandoc -rLL=\x3cspan class=\x22hljs-number\x22\x3e169\x3c\/span\x3en -rLT=\x3cspan class=\x22hljs-number\x22\x3e169\x3c\/span\x3en\ngroff            \x3cspan class=\x22hljs-number\x22\x3e15902\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \/usr\/bin\/troff -mtty-char -mandoc -rLL=\x3cspan class=\x22hljs-number\x22\x3e169\x3c\/span\x3en -rLT=\x3cspan class=\x22hljs-number\x22\x3e169\x3c\/span\x3en -Tutf8\ngroff            \x3cspan class=\x22hljs-number\x22\x3e15903\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e \/usr\/bin\/grotty\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e硬盘 I\/O 延迟的柱状图：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs tap\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e# biolatency -m\x3c\/span\x3e\nTracing block device I\/O... Hit Ctrl-C to end.\n^C\n     msecs           : count     distribution\n      \x3cspan class=\x22hljs-number\x22\x3e 0 \x3c\/span\x3e-\x26gt;\x3cspan class=\x22hljs-number\x22\x3e 1 \x3c\/span\x3e       :\x3cspan class=\x22hljs-number\x22\x3e 96 \x3c\/span\x3e      |************************************  |\n      \x3cspan class=\x22hljs-number\x22\x3e 2 \x3c\/span\x3e-\x26gt;\x3cspan class=\x22hljs-number\x22\x3e 3 \x3c\/span\x3e       :\x3cspan class=\x22hljs-number\x22\x3e 25 \x3c\/span\x3e      |*********                             |\n      \x3cspan class=\x22hljs-number\x22\x3e 4 \x3c\/span\x3e-\x26gt;\x3cspan class=\x22hljs-number\x22\x3e 7 \x3c\/span\x3e       :\x3cspan class=\x22hljs-number\x22\x3e 29 \x3c\/span\x3e      |***********                           |\n      \x3cspan class=\x22hljs-number\x22\x3e 8 \x3c\/span\x3e-\x26gt;\x3cspan class=\x22hljs-number\x22\x3e 15 \x3c\/span\x3e      :\x3cspan class=\x22hljs-number\x22\x3e 62 \x3c\/span\x3e      |***********************               |\n     \x3cspan class=\x22hljs-number\x22\x3e 16 \x3c\/span\x3e-\x26gt;\x3cspan class=\x22hljs-number\x22\x3e 31 \x3c\/span\x3e      :\x3cspan class=\x22hljs-number\x22\x3e 100 \x3c\/span\x3e     |**************************************|\n     \x3cspan class=\x22hljs-number\x22\x3e 32 \x3c\/span\x3e-\x26gt;\x3cspan class=\x22hljs-number\x22\x3e 63 \x3c\/span\x3e      :\x3cspan class=\x22hljs-number\x22\x3e 62 \x3c\/span\x3e      |***********************               |\n     \x3cspan class=\x22hljs-number\x22\x3e 64 \x3c\/span\x3e-\x26gt;\x3cspan class=\x22hljs-number\x22\x3e 127 \x3c\/span\x3e     :\x3cspan class=\x22hljs-number\x22\x3e 18 \x3c\/span\x3e      |******                                |\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e追踪慢于 5 毫秒的 ext4 常见操作：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs css\x22\x3e# \x3cspan class=\x22hljs-selector-tag\x22\x3eext4slower\x3c\/span\x3e 5\n\x3cspan class=\x22hljs-selector-tag\x22\x3eTracing\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3eext4\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3eoperations\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3eslower\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3ethan\x3c\/span\x3e 5 \x3cspan class=\x22hljs-selector-tag\x22\x3ems\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3eTIME\x3c\/span\x3e     \x3cspan class=\x22hljs-selector-tag\x22\x3eCOMM\x3c\/span\x3e           \x3cspan class=\x22hljs-selector-tag\x22\x3ePID\x3c\/span\x3e    \x3cspan class=\x22hljs-selector-tag\x22\x3eT\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3eBYTES\x3c\/span\x3e   \x3cspan class=\x22hljs-selector-tag\x22\x3eOFF_KB\x3c\/span\x3e   \x3cspan class=\x22hljs-selector-tag\x22\x3eLAT\x3c\/span\x3e(\x3cspan class=\x22hljs-selector-tag\x22\x3ems\x3c\/span\x3e) \x3cspan class=\x22hljs-selector-tag\x22\x3eFILENAME\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:45\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3esupervise\x3c\/span\x3e      3570   \x3cspan class=\x22hljs-selector-tag\x22\x3eW\x3c\/span\x3e 18      0           5\x3cspan class=\x22hljs-selector-class\x22\x3e.48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3estatus\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.new\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3esupervise\x3c\/span\x3e      12770  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 128     0           7\x3cspan class=\x22hljs-selector-class\x22\x3e.55\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e            12770  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 497     0          16\x3cspan class=\x22hljs-selector-class\x22\x3e.46\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3ensswitch\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.conf\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e            12770  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 1680    0          17\x3cspan class=\x22hljs-selector-class\x22\x3e.42\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3enetflix_environment\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.sh\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e            12770  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 1079    0           9\x3cspan class=\x22hljs-selector-class\x22\x3e.53\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3eservice_functions\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.sh\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e            12772  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 128     0          17\x3cspan class=\x22hljs-selector-class\x22\x3e.74\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3esvstat\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3esvstat\x3c\/span\x3e         12772  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 18      0           8\x3cspan class=\x22hljs-selector-class\x22\x3e.67\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3estatus\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e            12774  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 128     0          15\x3cspan class=\x22hljs-selector-class\x22\x3e.76\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3estat\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e            12777  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 128     0           7\x3cspan class=\x22hljs-selector-class\x22\x3e.89\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3egrep\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e            12776  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 128     0           8\x3cspan class=\x22hljs-selector-class\x22\x3e.25\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3eps\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e            12780  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 128     0          11\x3cspan class=\x22hljs-selector-class\x22\x3e.07\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3exargs\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3eps\x3c\/span\x3e             12776  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 832     0          12\x3cspan class=\x22hljs-selector-class\x22\x3e.02\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3elibprocps\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.so\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.4\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.0\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.0\x3c\/span\x3e\n21\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:49\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3erun\x3c\/span\x3e            12779  \x3cspan class=\x22hljs-selector-tag\x22\x3eR\x3c\/span\x3e 128     0          13\x3cspan class=\x22hljs-selector-class\x22\x3e.21\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3ecut\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-attr\x22\x3e[...]\x3c\/span\x3e\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e追踪新建的 TCP 活跃连接（\x3ccode\x3econnect()\x3c\/code\x3e）:\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs css\x22\x3e# \x3cspan class=\x22hljs-selector-tag\x22\x3etcpconnect\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3ePID\x3c\/span\x3e    \x3cspan class=\x22hljs-selector-tag\x22\x3eCOMM\x3c\/span\x3e         \x3cspan class=\x22hljs-selector-tag\x22\x3eIP\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3eSADDR\x3c\/span\x3e            \x3cspan class=\x22hljs-selector-tag\x22\x3eDADDR\x3c\/span\x3e            \x3cspan class=\x22hljs-selector-tag\x22\x3eDPORT\x3c\/span\x3e\n1479   \x3cspan class=\x22hljs-selector-tag\x22\x3etelnet\x3c\/span\x3e       4  127\x3cspan class=\x22hljs-selector-class\x22\x3e.0\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.0\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.1\x3c\/span\x3e        127\x3cspan class=\x22hljs-selector-class\x22\x3e.0\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.0\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.1\x3c\/span\x3e        23\n1469   \x3cspan class=\x22hljs-selector-tag\x22\x3ecurl\x3c\/span\x3e         4  10\x3cspan class=\x22hljs-selector-class\x22\x3e.201\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.219\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.236\x3c\/span\x3e   54\x3cspan class=\x22hljs-selector-class\x22\x3e.245\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.105\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.25\x3c\/span\x3e    80\n1469   \x3cspan class=\x22hljs-selector-tag\x22\x3ecurl\x3c\/span\x3e         4  10\x3cspan class=\x22hljs-selector-class\x22\x3e.201\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.219\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.236\x3c\/span\x3e   54\x3cspan class=\x22hljs-selector-class\x22\x3e.67\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.101\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.145\x3c\/span\x3e    80\n1991   \x3cspan class=\x22hljs-selector-tag\x22\x3etelnet\x3c\/span\x3e       6  \x3cspan class=\x22hljs-selector-pseudo\x22\x3e::1\x3c\/span\x3e              \x3cspan class=\x22hljs-selector-pseudo\x22\x3e::1\x3c\/span\x3e              23\n2015   \x3cspan class=\x22hljs-selector-tag\x22\x3essh\x3c\/span\x3e          6  \x3cspan class=\x22hljs-selector-tag\x22\x3efe80\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e::2000\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:bff\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:fe82\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:3ac\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3efe80\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e::2000\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:bff\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:fe82\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:3ac\x3c\/span\x3e 22\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e通过跟踪 \x3ccode\x3egetaddrinfo()\x3c\/code\x3e\/\x3ccode\x3egethostbyname()\x3c\/code\x3e 库的调用来追踪 DNS 延迟：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs css\x22\x3e# \x3cspan class=\x22hljs-selector-tag\x22\x3egethostlatency\x3c\/span\x3e\n\x3cspan class=\x22hljs-selector-tag\x22\x3eTIME\x3c\/span\x3e      \x3cspan class=\x22hljs-selector-tag\x22\x3ePID\x3c\/span\x3e    \x3cspan class=\x22hljs-selector-tag\x22\x3eCOMM\x3c\/span\x3e          \x3cspan class=\x22hljs-selector-tag\x22\x3eLATms\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3eHOST\x3c\/span\x3e\n06\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:10\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:24\x3c\/span\x3e  28011  \x3cspan class=\x22hljs-selector-tag\x22\x3ewget\x3c\/span\x3e          90\x3cspan class=\x22hljs-selector-class\x22\x3e.00\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3ewww\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.iovisor\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.org\x3c\/span\x3e\n06\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:10\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:28\x3c\/span\x3e  28127  \x3cspan class=\x22hljs-selector-tag\x22\x3ewget\x3c\/span\x3e           0\x3cspan class=\x22hljs-selector-class\x22\x3e.00\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3ewww\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.iovisor\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.org\x3c\/span\x3e\n06\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:10\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:41\x3c\/span\x3e  28404  \x3cspan class=\x22hljs-selector-tag\x22\x3ewget\x3c\/span\x3e           9\x3cspan class=\x22hljs-selector-class\x22\x3e.00\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3ewww\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.netflix\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.com\x3c\/span\x3e\n06\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:10\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:48\x3c\/span\x3e  28544  \x3cspan class=\x22hljs-selector-tag\x22\x3ecurl\x3c\/span\x3e          35\x3cspan class=\x22hljs-selector-class\x22\x3e.00\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3ewww\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.netflix\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.com\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.au\x3c\/span\x3e\n06\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:11\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:10\x3c\/span\x3e  29054  \x3cspan class=\x22hljs-selector-tag\x22\x3ecurl\x3c\/span\x3e          31\x3cspan class=\x22hljs-selector-class\x22\x3e.00\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3ewww\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.plumgrid\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.com\x3c\/span\x3e\n06\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:11\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:16\x3c\/span\x3e  29195  \x3cspan class=\x22hljs-selector-tag\x22\x3ecurl\x3c\/span\x3e           3\x3cspan class=\x22hljs-selector-class\x22\x3e.00\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3ewww\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.facebook\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.com\x3c\/span\x3e\n06\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:11\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:25\x3c\/span\x3e  29404  \x3cspan class=\x22hljs-selector-tag\x22\x3ecurl\x3c\/span\x3e          72\x3cspan class=\x22hljs-selector-class\x22\x3e.00\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3efoo\x3c\/span\x3e\n06\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:11\x3c\/span\x3e\x3cspan class=\x22hljs-selector-pseudo\x22\x3e:28\x3c\/span\x3e  29475  \x3cspan class=\x22hljs-selector-tag\x22\x3ecurl\x3c\/span\x3e           1\x3cspan class=\x22hljs-selector-class\x22\x3e.00\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3efoo\x3c\/span\x3e\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e按类别划分 VFS 操作的时间间隔统计：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs tap\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e# vfsstat\x3c\/span\x3e\nTIME         READ\/s  WRITE\/s CREATE\/s   OPEN\/s  FSYNC\/s\n18:35:32:      \x3cspan class=\x22hljs-number\x22\x3e 231 \x3c\/span\x3e     \x3cspan class=\x22hljs-number\x22\x3e 12 \x3c\/span\x3e      \x3cspan class=\x22hljs-number\x22\x3e 4 \x3c\/span\x3e     \x3cspan class=\x22hljs-number\x22\x3e 98 \x3c\/span\x3e       0\n18:35:33:      \x3cspan class=\x22hljs-number\x22\x3e 274 \x3c\/span\x3e     \x3cspan class=\x22hljs-number\x22\x3e 13 \x3c\/span\x3e      \x3cspan class=\x22hljs-number\x22\x3e 4 \x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e 106 \x3c\/span\x3e       0\n18:35:34:      \x3cspan class=\x22hljs-number\x22\x3e 586 \x3c\/span\x3e     \x3cspan class=\x22hljs-number\x22\x3e 86 \x3c\/span\x3e      \x3cspan class=\x22hljs-number\x22\x3e 4 \x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e 251 \x3c\/span\x3e       0\n18:35:35:      \x3cspan class=\x22hljs-number\x22\x3e 241 \x3c\/span\x3e     \x3cspan class=\x22hljs-number\x22\x3e 15 \x3c\/span\x3e      \x3cspan class=\x22hljs-number\x22\x3e 4 \x3c\/span\x3e     \x3cspan class=\x22hljs-number\x22\x3e 99 \x3c\/span\x3e       0\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e对一个给定的 PID，通过内核和用户堆栈轨迹来追踪 CPU 处理之外的时间（由内核进行统计）：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs routeros\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e# offcputime -d -p 24347\x3c\/span\x3e\nTracing off-CPU time (us) of PID 24347 by\x3cspan class=\x22hljs-built_in\x22\x3e user \x3c\/span\x3e\x2b kernel stack\x3cspan class=\x22hljs-built_in\x22\x3e..\x3c\/span\x3e. Hit Ctrl-C \x3cspan class=\x22hljs-keyword\x22\x3eto\x3c\/span\x3e end.\n^C\n[\x3cspan class=\x22hljs-built_in\x22\x3e..\x3c\/span\x3e.]\n    ffffffff810a9581 finish_task_switch\n    ffffffff8185d385 schedule\n    ffffffff81085672 do_wait\n    ffffffff8108687b sys_wait4\n    ffffffff81861bf6 entry_SYSCALL_64_fastpath\n    --\n    00007f6733a6b64a waitpid\n    -                bash (24347)\n        4952\n\n    ffffffff810a9581 finish_task_switch\n    ffffffff8185d385 schedule\n    ffffffff81860c48 schedule_timeout\n    ffffffff810c5672 wait_woken\n    ffffffff8150715a n_tty_read\n    ffffffff815010f2 tty_read\n    ffffffff8122cd67 __vfs_read\n    ffffffff8122df65 vfs_read\n    ffffffff8122f465 sys_read\n    ffffffff81861bf6 entry_SYSCALL_64_fastpath\n    --\n    00007f6733a969b0 read\n    -                bash (24347)\n        1450908\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e追踪 MySQL 查询延迟（通过 USDT 探针）：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs oxygene\x22\x3e# mysqld_qslower `pgrep -n mysqld`\nTracing MySQL server queries \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e PID \x3cspan class=\x22hljs-number\x22\x3e14371\x3c\/span\x3e slower than \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e ms...\nTIME(s)        PID          MS QUERY\n\x3cspan class=\x22hljs-number\x22\x3e0.000000\x3c\/span\x3e       \x3cspan class=\x22hljs-number\x22\x3e18608\x3c\/span\x3e   \x3cspan class=\x22hljs-number\x22\x3e130.751\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eSELECT\x3c\/span\x3e * \x3cspan class=\x22hljs-keyword\x22\x3eFROM\x3c\/span\x3e words \x3cspan class=\x22hljs-keyword\x22\x3eWHERE\x3c\/span\x3e word REGEXP \x3cspan class=\x22hljs-string\x22\x3e\x27^bre.*n$\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e2.921535\x3c\/span\x3e       \x3cspan class=\x22hljs-number\x22\x3e18608\x3c\/span\x3e   \x3cspan class=\x22hljs-number\x22\x3e130.590\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eSELECT\x3c\/span\x3e * \x3cspan class=\x22hljs-keyword\x22\x3eFROM\x3c\/span\x3e words \x3cspan class=\x22hljs-keyword\x22\x3eWHERE\x3c\/span\x3e word REGEXP \x3cspan class=\x22hljs-string\x22\x3e\x27^alex.*$\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e4.603549\x3c\/span\x3e       \x3cspan class=\x22hljs-number\x22\x3e18608\x3c\/span\x3e    \x3cspan class=\x22hljs-number\x22\x3e24.164\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eSELECT\x3c\/span\x3e COUNT\x3cspan class=\x22hljs-comment\x22\x3e(*) FROM words\n9.733847       18608   130.936 SELECT count(*)\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eAS\x3c\/span\x3e count \x3cspan class=\x22hljs-keyword\x22\x3eFROM\x3c\/span\x3e words \x3cspan class=\x22hljs-keyword\x22\x3eWHERE\x3c\/span\x3e word REGEXP \x3cspan class=\x22hljs-string\x22\x3e\x27^bre.*n$\x27\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e17.864776\x3c\/span\x3e      \x3cspan class=\x22hljs-number\x22\x3e18608\x3c\/span\x3e   \x3cspan class=\x22hljs-number\x22\x3e130.298\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eSELECT\x3c\/span\x3e * \x3cspan class=\x22hljs-keyword\x22\x3eFROM\x3c\/span\x3e words \x3cspan class=\x22hljs-keyword\x22\x3eWHERE\x3c\/span\x3e word REGEXP \x3cspan class=\x22hljs-string\x22\x3e\x27^bre.*n$\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eORDER\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eBY\x3c\/span\x3e word\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e监测 pam 库并使用多种追踪工具观察登录请求：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs autoit\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e# trace \x3cspan class=\x22hljs-string\x22\x3e\x27pam:pam_start \x22%s: %s\x22, arg1, arg2\x27\x3c\/span\x3e\x3c\/span\x3e\nTIME     PID    COMM         \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eFUNC\x3c\/span\x3e             -\x3c\/span\x3e\n\x3cspan class=\x22hljs-number\x22\x3e17\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e49\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e45\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e5558\x3c\/span\x3e   sshd         pam_start        sshd: root\n\x3cspan class=\x22hljs-number\x22\x3e17\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e49\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e47\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e5662\x3c\/span\x3e   sudo         pam_start        sudo: root\n\x3cspan class=\x22hljs-number\x22\x3e17\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e49\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e49\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e5727\x3c\/span\x3e   login        pam_start        login: bgregg\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3ebcc 项目里的很多工具都有帮助信息（\x3ccode\x3e-h\x3c\/code\x3e 选项），并且都应该包含有示例的 man 页面和文本文件。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#必要性\x22\x3e\x3c\/a\x3e必要性\x3c\/h3\x3e\n\x3cp\x3e2014 年，Linux 追踪程序就有一些内核相关的特性（来自 \x3ccode\x3eftrace\x3c\/code\x3e 和 \x3ccode\x3epref_events\x3c\/code\x3e），但是我们仍然要转储并报告进程数据，这种几十年前的老技术有很多的限制。你不能频繁地访问进程名、函数名、堆栈轨迹或内核中的任意的其它数据。你不能在将变量保存到一个监测事件里，又在另一个事件里访问它们，这意味着你不能在你需要的地方计算延迟（或者说时间增量）。你也不能创建一个内核内部的延迟柱状图，也不能追踪 USDT 探针，甚至不能写个自定义的程序。DTrace 可以做到所有这些，但仅限于 Solaris 或 BSD 系统。在 Linux 系统中，有些不在主线内核的追踪器，比如 SystemTap 就可以满足你的这些需求，但它也有自身的不足。（理论上说，你可以写一个基于探针的内核模块来满足需求-但实际上没人这么做。）\x3c\/p\x3e\n\x3cp\x3e2014 年我加入了 Netflix cloud performance 团队。做了这么久的 DTrace 方面的专家，转到 Linux 对我来说简直不可思议。但我确实这么做了，而且遇到了巨大的挑战：在应用快速变化、采用微服务架构和分布式系统的情况下，调优 Netflix cloud。有时要用到系统追踪，而我之前是用的 DTrace。在 Linux 系统上可没有 DTrace，我就开始用 Linux 内核内建的 \x3ccode\x3eftrace\x3c\/code\x3e 和 \x3ccode\x3eperf_events\x3c\/code\x3e 工具，构建了一个追踪工具（\x3ca href=\x22https:\/\/github.com\/brendangregg\/perf-tools\x22\x3eperf-tools\x3c\/a\x3e）。这些工具很有用，但有些工作还是没法完成，尤其是延迟柱状图以及堆栈踪迹计数。我们需要的是内核追踪的可程序化。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#发生了什么\x22\x3e\x3c\/a\x3e发生了什么？\x3c\/h3\x3e\n\x3cp\x3eBPF 将程序化的功能添加到现有的内核追踪工具中（\x3ccode\x3etracepoints\x3c\/code\x3e、\x3ccode\x3ekprobes\x3c\/code\x3e、\x3ccode\x3euprobes\x3c\/code\x3e）。在 Linux 4.x 系列的内核里，这些功能大大加强了。\x3c\/p\x3e\n\x3cp\x3e时间采样是最主要的部分，它被 Linux 4.9-rc1 所采用（\x3ca href=\x22https:\/\/lkml.org\/lkml\/2016\/9\/1\/831\x22\x3epatchset\x3c\/a\x3e）。十分感谢 Alexei Starovoitov（在 Facebook 致力于 BPF 的开发），他是这些 BPF 增强功能的主要开发者。\x3c\/p\x3e\n\x3cp\x3eLinux 内核现在内建有以下这些特性（自 2.6 版本到 4.9 版本之间增加）：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e内核级的动态追踪（BPF 对 \x3ccode\x3ekprobes\x3c\/code\x3e 的支持）\x3c\/li\x3e\n\x3cli\x3e用户级的动态追踪（BPF 对 \x3ccode\x3euprobes\x3c\/code\x3e 的支持）\x3c\/li\x3e\n\x3cli\x3e内核级的静态追踪（BPF 对 \x3ccode\x3etracepoints\x3c\/code\x3e 的支持）\x3c\/li\x3e\n\x3cli\x3e时间采样事件（BPF 的 \x3ccode\x3epref_event_open\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3ePMC 事件（BPF 的 \x3ccode\x3epref_event_open\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3e过滤器（通过 BPF 程序）\x3c\/li\x3e\n\x3cli\x3e调试输出（\x3ccode\x3ebpf_trace_printk()\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3e按事件输出（\x3ccode\x3ebpf_perf_event_output()\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3e基础变量（全局的和每个线程的变量，基于 BPF 映射）\x3c\/li\x3e\n\x3cli\x3e关联数组（通过 BPF 映射）\x3c\/li\x3e\n\x3cli\x3e频率计数（基于 BPF 映射）\x3c\/li\x3e\n\x3cli\x3e柱状图（2 的冥次方、线性及自定义，基于 BPF 映射）\x3c\/li\x3e\n\x3cli\x3e时间戳和时间增量（\x3ccode\x3ebpf_ktime_get_ns()\x3c\/code\x3e，和 BPF 程序）\x3c\/li\x3e\n\x3cli\x3e内核态的堆栈轨迹（BPF 栈映射）\x3c\/li\x3e\n\x3cli\x3e用户态的堆栈轨迹 (BPF 栈映射)\x3c\/li\x3e\n\x3cli\x3e重写 ring 缓存（\x3ccode\x3epref_event_attr.write_backward\x3c\/code\x3e）\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e我们采用的前端是 bcc，它同时提供 Python 和 lua 接口。bcc 添加了：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e用户级静态追踪（基于 \x3ccode\x3euprobes\x3c\/code\x3e 的 USDT 探针）\x3c\/li\x3e\n\x3cli\x3e调试输出（Python 中调用 \x3ccode\x3eBPF.trace_pipe()\x3c\/code\x3e 和 \x3ccode\x3eBPF.trace_fields()\x3c\/code\x3e 函数 ）\x3c\/li\x3e\n\x3cli\x3e按事件输出（\x3ccode\x3eBPF_PERF_OUTPUT\x3c\/code\x3e 宏和 \x3ccode\x3eBPF.open_perf_buffer()\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3e间隔输出（\x3ccode\x3eBPF.get_table()\x3c\/code\x3e 和 \x3ccode\x3etable.clear()\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3e打印柱状图（\x3ccode\x3etable.print_log2_hist()\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3e内核级的 C 结构体导航（bcc 重写器映射到 \x3ccode\x3ebpf_probe_read()\x3c\/code\x3e 函数）\x3c\/li\x3e\n\x3cli\x3e内核级的符号解析（\x3ccode\x3eksym()\x3c\/code\x3e、 \x3ccode\x3eksymaddr()\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3e用户级的符号解析（\x3ccode\x3eusymaddr()\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3eBPF 跟踪点支持（通过 \x3ccode\x3eTRACEPOINT_PROBE\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3eBPF 堆栈轨迹支持（包括针对堆栈框架的 \x3ccode\x3ewalk\x3c\/code\x3e 方法）\x3c\/li\x3e\n\x3cli\x3e其它各种辅助宏和方法\x3c\/li\x3e\n\x3cli\x3e例子（位于 \x3ccode\x3e\/examples\x3c\/code\x3e 目录）\x3c\/li\x3e\n\x3cli\x3e工具（位于 \x3ccode\x3e\/tools\x3c\/code\x3e 目录）\x3c\/li\x3e\n\x3cli\x3e教程（\x3ccode\x3e\/docs\/tutorial*.md\x3c\/code\x3e）\x3c\/li\x3e\n\x3cli\x3e参考手册（\x3ccode\x3e\/docs\/reference_guide.md\x3c\/code\x3e）\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e直到最新也是最主要的特性被整合进来，我才开始写这篇文章，现在它在 4.9-rc1 内核中。我们还需要去完成一些次要的东西，还有另外一些事情要做，但是现在我们所拥有的已经值得欢呼了。现在 Linux 拥有了内建的高级追踪能力。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#安全性\x22\x3e\x3c\/a\x3e安全性\x3c\/h3\x3e\n\x3cp\x3e设计 BPF 及其增强功能时就考虑到生产环境级安全，它被用在大范围的生产环境里。不过你想的话，你还是可以找到一个挂起内核的方法。这种情况是偶然的，而不是必然，类似的漏洞会被快速修复，尤其是当 BPF 合并入了 Linux。因为 Linux 可是公众的焦点。\x3c\/p\x3e\n\x3cp\x3e在开发过程中我们碰到了一些非 BPF 的漏洞，它们需要被修复：rcu 不可重入，这可能导致内核由于 funccount 挂起，在 4.6 内核版本中这个漏洞被 “bpf: map pre-alloc” 补丁集所修复，旧版本内核的漏洞 bcc 有个临时处理方案。还有一个是 uprobe 的内存计算问题，这导致 uprobe 分配内存失败，在 4.8 内核版本这个漏洞由 “uprobes: Fix the memcg accounting” 补丁所修复，并且该补丁还将被移植到之前版本的内核中（例如，它现在被移植到了 4.4.27 和 4.4.0-45.66 版本中）。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#为什么-linux-追踪用了这么久才加进来\x22\x3e\x3c\/a\x3e为什么 Linux 追踪用了这么久才加进来？\x3c\/h3\x3e\n\x3cp\x3e首要任务被分到了若干追踪器中间：这些不是某个追踪器单个的事情。想要了解更多关于这个或其它方面的问题，可以看一看我在 2014 年 \x3ca href=\x22http:\/\/www.slideshare.net\/brendangregg\/from-dtrace-to-linux\x22\x3etracing summit 上的讲话\x3c\/a\x3e。我忽视了部分方案的反面影响：有些公司发现其它追踪器（SystemTap 和 LTTng）能满足他们的需求，尽管他们乐于听到 BPF 的开发进程，但考虑到他们现有的解决方案，帮助 BPF 的开发就不那么重要了。\x3c\/p\x3e\n\x3cp\x3eBPF 仅在近两年里在追踪领域得到加强。这一过程原本可以更快的，但早期缺少全职从事于 BPF 追踪的工程师。Alexei Starovoitov (BPF 领导者)，Brenden Blanco (bcc 领导者)，我还有其它一些开发者，都有其它的事情要做。我在 Netflix 公司花了大量时间（志愿地），大概有 7% 的时间是花在 BPF 和 bcc 上。某种程度上这不是我的首要任务，因为我还有自己的工作（包括我的 perf-tools，一个可以工作在旧版本内核上的程序）。\x3c\/p\x3e\n\x3cp\x3e现在BPF 追踪器已经推出了，已经有科技公司开始寻找会 BPF 的人了。但我还是推荐 \x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-03-30\/working-at-netflix-2016.html\x22\x3eNetflix 公司\x3c\/a\x3e。（如果你为了 BPF 而要聘请我，那我还是十分乐于待在 Netflix 公司的！）\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#使用简单\x22\x3e\x3c\/a\x3e使用简单\x3c\/h3\x3e\n\x3cp\x3eDTrace 和 bcc\/BPF 现在的最大区别就是哪个更好使用。这取决于你要用 BPF 追踪做什么了。如果你要\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cstrong\x3e使用 BPF 工具\/度量\x3c\/strong\x3e：应该是没什么区别的。工具的表现都差不多，图形用户界面都能取得类似度量指标。大部分用户通过这种方式使用 BPF。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e开发工具\/度量\x3c\/strong\x3e：bcc 的开发可难多了。DTrace 有一套自己的简单语言，D 语音，和 awk 语言相似，而 bcc 使用已有的语言（C 语言，Python 和 lua）及其类库。一个用 C 和 Python 写的 bcc 工具与仅仅用 D 语言写出来的工具相比，可能要多十多倍行数的代码，或者更多。但是很多 DTrace 工具用 shell 封装来提供参数和差错检查，会让代码变得十分臃肿。编程的难处是不同的：重写 bcc 更需要巧妙性，这导致某些脚本更加难开发。（尤其是 \x3ccode\x3ebpf_probe_read()\x3c\/code\x3e 这类的函数，需要了解更多 BPF 的内涵知识）。当计划改进 bcc 时，这一情形将得到改善。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e运行常见的命令\x3c\/strong\x3e：十分相近。通过 \x3ccode\x3edtrace\x3c\/code\x3e 命令，DTrace 能做很多事，但 bcc 有各种工具，\x3ccode\x3etrace\x3c\/code\x3e、\x3ccode\x3eargdist\x3c\/code\x3e、\x3ccode\x3efunccount\x3c\/code\x3e、\x3ccode\x3efunclatency\x3c\/code\x3e 等等。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e编写自定义的特殊命令\x3c\/strong\x3e：使用 DTrace 的话，这就没有必要了。允许定制消息快速传递和系统快速响应，DTrace 的高级分析很快。而 bcc 现在受限于它的多种工具以及它们的适用范围。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e简单来说，如果你只使用 BPF 工具的话，就不必关注这些差异了。如果你经验丰富，是个开发者（像我一样），目前 bcc 的使用更难一些。\x3c\/p\x3e\n\x3cp\x3e举一个 bcc 的 Python 前端的例子，下面是追踪硬盘 I\/O 并打印出 I\/O 大小的柱状图代码：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs python\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e bcc \x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e BPF\n\x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e time \x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e sleep\n\n\x3cspan class=\x22hljs-comment\x22\x3e# load BPF program\x3c\/span\x3e\nb = BPF(text=\x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x22\n#include \x26lt;uapi\/linux\/ptrace.h\x26gt;\n#include \x26lt;linux\/blkdev.h\x26gt;\n\nBPF_HISTOGRAM(dist);\n\nint kprobe__blk_account_io_completion(struct pt_regs *ctx, struct request *req)\n{\n    dist.increment(bpf_log2l(req-\x26gt;__data_len \/ 1024));\n    return 0;\n}\n\x22\x22\x22\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-comment\x22\x3e# header\x3c\/span\x3e\nprint(\x3cspan class=\x22hljs-string\x22\x3e\x22Tracing... Hit Ctrl-C to end.\x22\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-comment\x22\x3e# trace until Ctrl-C\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e:\n    sleep(\x3cspan class=\x22hljs-number\x22\x3e99999999\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3eexcept\x3c\/span\x3e KeyboardInterrupt:\n    \x3cspan class=\x22hljs-keyword\x22\x3eprint\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-comment\x22\x3e# output\x3c\/span\x3e\nb[\x3cspan class=\x22hljs-string\x22\x3e\x22dist\x22\x3c\/span\x3e].print_log2_hist(\x3cspan class=\x22hljs-string\x22\x3e\x22kbytes\x22\x3c\/span\x3e)\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e注意 Python 代码中嵌入的 C 语句（\x3ccode\x3etext=\x3c\/code\x3e）。\x3c\/p\x3e\n\x3cp\x3e这就完成了任务，但仍有改进的空间。好在我们有时间去做：人们使用 Linux 4.9 并能用上 BPF 还得好几个月呢，所以我们有时间来制造工具和前端。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#高级语言\x22\x3e\x3c\/a\x3e高级语言\x3c\/h3\x3e\n\x3cp\x3e前端越简单，比如高级语言，所改进的可能就越不如你所期望的。绝大多数人使用封装好的工具（和图形界面），仅有少部分人能写出这些工具。但我不反对使用高级语言，比如 SystemTap，毕竟已经开发出来了。\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs d\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e#!\/usr\/bin\/stap\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/*\n * opensnoop.stp    Trace file open()s.  Basic version of opensnoop.\n *\/\x3c\/span\x3e\n\nprobe begin\n{\n    printf(\x3cspan class=\x22hljs-string\x22\x3e\x22\\n%6s %6s %16s %s\\n\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22UID\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22PID\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22COMM\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x22PATH\x22\x3c\/span\x3e);\n}\n\nprobe syscall.open\n{\n    printf(\x3cspan class=\x22hljs-string\x22\x3e\x22%6d %6d %16s %s\\n\x22\x3c\/span\x3e, uid(), pid(), execname(), filename);\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e如果拥有整合了语言和脚本的 SystemTap 前端与高性能的内置在内核中的 BPF 后端，会不会令人满意呢？RedHat 公司的 Richard Henderson 已经在进行相关工作了，并且发布了 \x3ca href=\x22https:\/\/lkml.org\/lkml\/2016\/6\/14\/749\x22\x3e初代版本\x3c\/a\x3e！\x3c\/p\x3e\n\x3cp\x3e这是 \x3ca href=\x22https:\/\/wkz.github.io\/ply\/\x22\x3eply\x3c\/a\x3e，一个完全新颖的 BPF 高级语言：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22hljs d\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e#!\/usr\/bin\/env ply\x3c\/span\x3e\n\nkprobe:SyS_*\n{\n    $syscalls[func].count()\n}\n\n\x3c\/code\x3e\x3c\/pre\x3e\x3cp\x3e这也是一份承诺。\x3c\/p\x3e\n\x3cp\x3e尽管如此，我认为工具开发者的实际难题不是使用什么语言：而是要了解要用这些强大的工具做什么？\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#如何帮助我们\x22\x3e\x3c\/a\x3e如何帮助我们\x3c\/h3\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cstrong\x3e推广\x3c\/strong\x3e：BPF 追踪器目前还没有什么市场方面的进展。尽管有公司了解并在使用它（Facebook、Netflix、Github 和其它公司），但要广为人知尚需时日。你可以分享关于 BPF 的文章和资源给业内的其它公司来帮助我们。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e教育\x3c\/strong\x3e：你可以撰写文章，发表演讲，甚至参与 bcc 文档的编写。分享 BPF 如何解决实际问题以及为公司带来收益的实例。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e解决 bcc 的问题\x3c\/strong\x3e：参考 \x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\/issues\x22\x3ebcc issue list\x3c\/a\x3e，这包含了错误和需要的特性。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e提交错误\x3c\/strong\x3e：使用 bcc\/BPF，提交你发现的错误。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e创造工具\x3c\/strong\x3e：有很多可视化的工具需要开发，但请不要太草率，因为大家会先花几个小时学习使用你做的工具，所以请尽量把工具做的直观好用（参考我的\x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\/blob\/master\/CONTRIBUTING-SCRIPTS.md\x22\x3e文档\x3c\/a\x3e）。就像 Mike Muuss 提及到他自己的 \x3ca href=\x22http:\/\/ftp.arl.army.mil\/%7Emike\/ping.html\x22\x3eping\x3c\/a\x3e 程序：“要是我早知道这是我一生中最出名的成就，我就多开发一两天，添加更多选项。”\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e高级语言\x3c\/strong\x3e：如果现有的 bcc 前端语言让你很困扰，或许你能弄门更好的语言。要是你想将这门语言内建到 bcc 里面，你需要使用 libbcc。或者你可以帮助 SystemTap BPF 或 ply 的工作。\x3c\/li\x3e\n\x3cli\x3e\x3cstrong\x3e整合图形界面\x3c\/strong\x3e：除了 bcc 可以使用的 CLI 命令行工具，怎么让这些信息可视呢？延迟热点图，火焰图等等。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3\x3e\x3ca href=\x22#其它追踪器\x22\x3e\x3c\/a\x3e其它追踪器\x3c\/h3\x3e\n\x3cp\x3e那么 SystemTap、ktap、sysdig、LTTng 等追踪器怎么样呢？它们有个共同点，要么使用了 BPF，要么在自己的领域做得更好。会有单独的文章介绍它们自己。\x3c\/p\x3e\n\x3cp\x3e至于 DTrace ？我们公司目前还在基于 FreeBSD 系统的 CDN 中使用它。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#更多-bccbpf-的信息\x22\x3e\x3c\/a\x3e更多 bcc\/BPF 的信息\x3c\/h3\x3e\n\x3cp\x3e我已经写了一篇《\x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\/blob\/master\/docs\/tutorial.md\x22\x3ebcc\/BPF 工具最终用户教程\x3c\/a\x3e》，一篇《\x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\/blob\/master\/docs\/tutorial_bcc_python_developer.md\x22\x3ebcc Python 开发者教程\x3c\/a\x3e》，一篇《\x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\/blob\/master\/docs\/reference_guide.md\x22\x3ebcc\/BPF 参考手册\x3c\/a\x3e》，并提供了一些有用的\x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\/tree\/master\/tools\x22\x3e工具\x3c\/a\x3e，每一个工具都有一个 \x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\/tree\/master\/tools\x22\x3eexample.txt\x3c\/a\x3e 文件和 \x3ca href=\x22https:\/\/github.com\/iovisor\/bcc\/tree\/master\/man\/man8\x22\x3eman page\x3c\/a\x3e。我之前写过的关于 bcc 和 BPF 的文章有：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2015-05-15\/ebpf-one-small-step.html\x22\x3eeBPF: One Small Step\x3c\/a\x3e （后来就叫做 BPF）\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2015-09-22\/bcc-linux-4.3-tracing.html\x22\x3ebcc: Taming Linux 4.3\x2b Tracing Superpowers\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-01-18\/ebpf-stack-trace-hack.html\x22\x3eLinux eBPF Stack Trace Hack\x3c\/a\x3e （现在官方支持追踪堆栈了）\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-01-20\/ebpf-offcpu-flame-graph.html\x22\x3eLinux eBPF Off-CPU Flame Graph\x3c\/a\x3e \x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-02-01\/linux-wakeup-offwake-profiling.html\x22\x3eLinux Wakeup and Off-Wake Profiling\x3c\/a\x3e \x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-02-05\/ebpf-chaingraph-prototype.html\x22\x3eLinux Chain Graph Prototype\x3c\/a\x3e \x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-02-08\/linux-ebpf-bcc-uprobes.html\x22\x3eLinux eBPF\/bcc uprobes\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-03-05\/linux-bpf-superpowers.html\x22\x3eLinux BPF Superpowers\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-06-14\/ubuntu-xenial-bcc-bpf.html\x22\x3eUbuntu Xenial bcc\/BPF\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-10-01\/linux-bcc-security-capabilities.html\x22\x3eLinux bcc Tracing Security Capabilities\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-10-04\/linux-bcc-mysqld-qslower.html\x22\x3eLinux MySQL Slow Query Tracing with bcc\/BPF\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-10-06\/linux-bcc-ext4dist-ext4slower.html\x22\x3eLinux bcc ext4 Latency Tracing\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-10-08\/linux-bcc-runqlat.html\x22\x3eLinux bcc\/BPF Run Queue (Scheduler) Latency\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-10-12\/linux-bcc-nodejs-usdt.html\x22\x3eLinux bcc\/BPF Node.js USDT Tracing\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-10-15\/linux-bcc-tcptop.html\x22\x3eLinux bcc tcptop\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-10-21\/linux-efficient-profiler.html\x22\x3eLinux 4.9\x27s Efficient BPF-based Profiler\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e我在 Facebook 的 Performance@Scale \x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-03-05\/linux-bpf-superpowers.html\x22\x3eLinux BPF Superpowers\x3c\/a\x3e 大会上发表过一次演讲。十二月份，我将在 Boston 发表关于 BPF\/bcc 在 \x3ca href=\x22https:\/\/www.usenix.org\/conference\/lisa16\x22\x3eUSENIX LISA\x3c\/a\x3e 方面的演讲和教程。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#致谢\x22\x3e\x3c\/a\x3e致谢\x3c\/h3\x3e\n\x3cul\x3e\n\x3cli\x3eVan Jacobson 和 Steve McCanne，他们创建了最初用作过滤器的 BPF 。\x3c\/li\x3e\n\x3cli\x3eBarton P. Miller，Jeffrey K. Hollingsworth，and Jon Cargille，发明了动态追踪，并发表论文《Dynamic Program Instrumentation for Scalable Performance Tools》，可扩展高性能计算协议 （SHPCC），于田纳西州诺克斯维尔市，1994 年 5 月发表。\x3c\/li\x3e\n\x3cli\x3ekerninst (ParaDyn, UW-Madison)，展示了动态跟踪的价值的早期动态跟踪工具（上世纪 90 年代后期）\x3c\/li\x3e\n\x3cli\x3eMathieu Desnoyers (在 LTTng)，内核的主要开发者，主导 tracepoints 项目。\x3c\/li\x3e\n\x3cli\x3eIBM 开发的作为 DProbes 一部分的 kprobes，DProbes 在 2000 年时曾与 LTT 一起提供 Linux 动态追踪，但没有整合到一起。\x3c\/li\x3e\n\x3cli\x3eBryan Cantrill, Mike Shapiro, and Adam Leventhal (Sun Microsystems)，DTrace 的核心开发者，DTrace 是一款很棒的动态追踪工具，安全而且简单（2004 年）。对于动态追踪技术，DTrace 是科技的重要转折点：它很安全，默认安装在 Solaris 以及其它以可靠性著称的系统里。\x3c\/li\x3e\n\x3cli\x3e来自 Sun Microsystems 的各部门的许多员工，促进了 DTrace，为我们带来了高级系统追踪的意识。\x3c\/li\x3e\n\x3cli\x3eRoland McGrath (在 Red Hat)，utrace 项目的主要开发者，utrace 变成了后来的 uprobes。\x3c\/li\x3e\n\x3cli\x3eAlexei Starovoitov (PLUMgrid， 后来是 Facebook)，加强版 BPF（可编程内核部件）的主要开发者。\x3c\/li\x3e\n\x3cli\x3e那些帮助反馈、提交代码、测试以及针对增强版 BPF 补丁（请在 lkml 搜索 BPF）的 Linux 内核工程师： Wang Nan、 Daniel Borkmann、 David S. Miller、 Peter Zijlstra 以及其它很多人。\x3c\/li\x3e\n\x3cli\x3eBrenden Blanco (PLUMgrid)，bcc 的主要开发者。\x3c\/li\x3e\n\x3cli\x3eSasha Goldshtein (Sela) 开发了 bcc 中的跟踪点支持，和功能最强大的 bcc 工具 trace 及 argdist，帮助 USDT 项目的开发。\x3c\/li\x3e\n\x3cli\x3eVicent Martí 和其它 Github 上的工程师，为 bcc 编写了基于 lua 的前端，帮助 USDT 部分项目的开发。\x3c\/li\x3e\n\x3cli\x3eAllan McAleavy、 Mark Drayton，和其他的改进 bcc 的贡献者。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e感觉 Netflix 提供的环境和支持，让我能够编写 BPF 和 bcc 跟踪器并完成它们。我已经编写了多年的追踪工具（使用 TNF\/prex、DTrace、SystemTap、ktap、ftrace、perf，现在是 bcc\/BPF），并写书、博客以及评论，\x3c\/p\x3e\n\x3cp\x3e最后，感谢 \x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-07-23\/deirdre.html\x22\x3eDeirdré\x3c\/a\x3e 编辑了另外一篇文章。\x3c\/p\x3e\n\x3ch3\x3e\x3ca href=\x22#总结\x22\x3e\x3c\/a\x3e总结\x3c\/h3\x3e\n\x3cp\x3eLinux 没有 DTrace（语言），但它现在有了，或者说拥有了 DTraceTookit（工具）。\x3c\/p\x3e\n\x3cp\x3e通过增强内置的 BPF 引擎，Linux 4.9 内核拥有了用来支持现代化追踪的最后一项能力。内核支持这一最难的部分已经做完了。今后的任务包括更多的命令行执行工具，以及高级语言和图形用户界面。\x3c\/p\x3e\n\x3cp\x3e对于性能分析产品的客户，这也是一件好事：你能查看延迟柱状图和热点图，CPU 处理和 CPU 之外的火焰图，拥有更好的时延断点和更低耗的工具。在用户空间按包跟踪和处理是没有效率的方式。\x3c\/p\x3e\n\x3cp\x3e那么你什么时候会升级到 Linux 4.9 呢？一旦官方发布，新的性能测试工具就来了：\x3ccode\x3eapt-get install bcc-tools\x3c\/code\x3e 。\x3c\/p\x3e\n\x3cp\x3e开始享受它吧!\x3c\/p\x3e\n\x3cp\x3eBrendan\x3c\/p\x3e\n\x3chr\x3e\n\x3cp\x3evia: \x3ca href=\x22http:\/\/www.brendangregg.com\/blog\/2016-10-27\/dtrace-for-linux-2016.html\x22\x3ehttp:\/\/www.brendangregg.com\/blog\/2016-10-27\/dtrace-for-linux-2016.html\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e作者：\x3ca href=\x22http:\/\/www.brendangregg.com\/\x22\x3eBrendan Gregg\x3c\/a\x3e 译者：\x3ca href=\x22https:\/\/github.com\/GitFuture\x22\x3eGitFuture\x3c\/a\x3e 校对：\x3ca href=\x22https:\/\/github.com\/wxy\x22\x3ewxy\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e本文由 \x3ca href=\x22https:\/\/github.com\/LCTT\/TranslateProject\x22\x3eLCTT\x3c\/a\x3e 原创编译，\x3ca href=\x22https:\/\/linux.cn\/\x22\x3eLinux中国\x3c\/a\x3e 荣誉推出\x3c\/p\x3e\n\n          \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>Linux 中的 DTrace ：BPF 进入 4.9 内核</p><h2 id="原文链接">原文链接</h2><p><a href="https://www.zcfy.cc/article/dtrace-for-linux-2016">https://www.zcfy.cc/article/dtrace-for-linux-2016</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/jjzixyvvoi/" target="_blank">https://alili.tech/archive/jjzixyvvoi/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/t61hviqrk8g/">1-vuejs2.0实战：仿豆瓣app项目，创建自定义组件tabbar<aside class="dates">2019-01-26</aside></a></li><li><a href="/archive/zsxxn0n7jj/">2-vuejs2.0实战：仿豆瓣app项目，创建组件header,tabbar路由跳转<aside class="dates">2019-01-26</aside></a></li><li><a href="/archive/4ns5cwxsi05/">40 行代码内实现一个 React.js<aside class="dates">2019-01-26</aside></a></li><li><a href="/archive/imbao5um82/">50行代码搞定无限滑动幻灯片<aside class="dates">2019-01-26</aside></a></li><li><a href="/archive/kfss2f33qsh/">CSS效果篇--CSS3实现5种预载动画效果<aside class="dates">2019-01-26</aside></a></li><li><a href="/archive/4tsylfrtz8w/">ES6—类的实现原理<aside class="dates">2019-01-26</aside></a></li><li><a href="/archive/mzd8glfuhd/">H5实例教学--从AnimateCC到CreateJS入门<aside class="dates">2019-01-26</aside></a></li><li><a href="/archive/xhjgf527wvr/">H5实例教学--微信内嵌视频1（案例浅析）<aside class="dates">2019-01-26</aside></a></li><li><a href="/archive/0hqst6af5tx/">HTML&#43;CSS&#43;JAVASCRIPT 高仿低配网页版网易云音乐播放器<aside class="dates">2019-01-26</aside></a></li><li><a href="/archive/14vf08gpmnw/">HTTP验证大法(Basic Auth,Session, JWT, Oauth, Openid)<aside class="dates">2019-01-26</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>