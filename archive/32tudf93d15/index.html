<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="connect-history-api-fallback分析"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>connect-history-api-fallback分析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/32tudf93d15/",
				"appid": "1613049289050283", 
				"title": "connect-history-api-fallback分析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-29T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/udt573c7g6/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/gsepvhxuxvf/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f&text=connect-history-api-fallback%e5%88%86%e6%9e%90"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f&text=connect-history-api-fallback%e5%88%86%e6%9e%90"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f&title=connect-history-api-fallback%e5%88%86%e6%9e%90"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f&is_video=false&description=connect-history-api-fallback%e5%88%86%e6%9e%90"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=connect-history-api-fallback%e5%88%86%e6%9e%90&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f&title=connect-history-api-fallback%e5%88%86%e6%9e%90"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f&title=connect-history-api-fallback%e5%88%86%e6%9e%90"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f&title=connect-history-api-fallback%e5%88%86%e6%9e%90"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f32tudf93d15%2f&title=connect-history-api-fallback%e5%88%86%e6%9e%90"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">connect-history-api-fallback分析</h1><div class="meta"><div class="postdate"><time datetime="2019-01-29" itemprop="datePublished">2019-01-29</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e研究下connect-history-api-fallback v1.3.0，地址：\x3ca href=\x22https:\/\/github.com\/bripkens\/connect-history-api-fallback\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/bripkens\/c...\x3c\/a\x3e，当然它也可以作为express的中间件使用\x3c\/p\x3e\n\x3cp\x3eREADME中介绍的很清楚\x3c\/p\x3e\n\x3cblockquote\x3e\n\x3cp\x3eSingle Page Applications (SPA) typically only utilise one index file that is accessible by web browsers: usually index.html. Navigation in the application is then commonly handled using JavaScript with the help of the HTML5 History API. This results in issues when the user hits the refresh button or is directly accessing a page other than the landing page, e.g. \/help or \/help\/online as the web server bypasses the index file to locate the file at this location. As your application is a SPA, the web server will fail trying to retrieve the file and return a 404 - Not Found message to the user.\x3c\/p\x3e\n\x3cp\x3eThis tiny middleware addresses some of the issues. Specifically, it will change the requested location to the index you specify (default being \/index.html) whenever there is a request which fulfills the following criteria:\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3eThe request is a GET request\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3ewhich accepts text\/html,\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eis not a direct file request, i.e. the requested path does not contain a . (DOT) character and\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3edoes not match a pattern provided in options.rewrites (see options below)\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3c\/blockquote\x3e\n\x3ch4\x3e解释一下：\x3c\/h4\x3e\n\x3cp\x3eserver.js\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const path = require(\x27path\x27)\n\nconst express = require(\x27express\x27)\nconst router = express.Router()\n\nconst indexRoute = router.get(\x27\/\x27, (req, res) =\x3e {\n  res.status(200).render(\x27index\x27, {\n    title: \x27首页\x27\n  })\n})\n\napp.set(\x27views\x27, path.join(__dirname, \x27templates\x27))\napp.set(\x27view engine\x27, \x27html\x27)\napp.engine(\x27html\x27, ejs.__express)\n\napp.use(\x27\/static\x27, express.static(path.join(__dirname, \x27public\x27)))\n\napp.use(history({\n  rewrites: [\n    { from: \/^\\\/abc$\/, to: \x27\/\x27 }\n  ]\n}))\n\napp.get(\x27\/\x27, indexRoute)\n\napp.use((req, res) =\x3e {\n  res.status(404).send(\x27File not found!\x27)\n})\n\napp.listen(9090, \x27127.0.0.1\x27, () =\x3e {\n  console.log(\x27ther server is running at port \x27 \x2b 9090)\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e)\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e express = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27express\x27\x3c\/span\x3e)\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e router = express.Router()\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e indexRoute = router.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e, (req, res) =\x26gt; {\n  res.status(\x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e).render(\x3cspan class=\x22hljs-string\x22\x3e\x27index\x27\x3c\/span\x3e, {\n    \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27首页\x27\x3c\/span\x3e\n  })\n})\n\napp.set(\x3cspan class=\x22hljs-string\x22\x3e\x27views\x27\x3c\/span\x3e, path.join(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27templates\x27\x3c\/span\x3e))\napp.set(\x3cspan class=\x22hljs-string\x22\x3e\x27view engine\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27html\x27\x3c\/span\x3e)\napp.engine(\x3cspan class=\x22hljs-string\x22\x3e\x27html\x27\x3c\/span\x3e, ejs.__express)\n\napp.use(\x3cspan class=\x22hljs-string\x22\x3e\x27\/static\x27\x3c\/span\x3e, express.static(path.join(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27public\x27\x3c\/span\x3e)))\n\napp.use(history({\n  \x3cspan class=\x22hljs-attr\x22\x3erewrites\x3c\/span\x3e: [\n    { \x3cspan class=\x22hljs-attr\x22\x3efrom\x3c\/span\x3e: \x3cspan class=\x22hljs-regexp\x22\x3e\/^\\\/abc$\/\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3eto\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e }\n  ]\n}))\n\napp.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e, indexRoute)\n\napp.use(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  res.status(\x3cspan class=\x22hljs-number\x22\x3e404\x3c\/span\x3e).send(\x3cspan class=\x22hljs-string\x22\x3e\x27File not found!\x27\x3c\/span\x3e)\n})\n\napp.listen(\x3cspan class=\x22hljs-number\x22\x3e9090\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27127.0.0.1\x27\x3c\/span\x3e, () =\x26gt; {\n  \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27ther server is running at port \x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-number\x22\x3e9090\x3c\/span\x3e)\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eindex.html\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cdiv id=\x26quot;test\x26quot;\x3e\n  \x3crouter-view\x3e\x3c\/router-view\x3e\n\x3c\/div\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eid\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22test\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n  \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3erouter-view\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3erouter-view\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eindex.js\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Vue.use(VueRouter)\n\nvar s = \x27\x3cdiv\x3e\x3crouter-link to=\x26quot;\/foo\x26quot;\x3eGo to Foo\x3c\/router-link\x3e - \x3crouter-link to=\x26quot;\/bar\x26quot;\x3eGo to Bar\x3c\/router-link\x3e - \x3crouter-link to=\x26quot;\/\x26quot;\x3eGo to Home\x3c\/router-link\x3e\x3c\/div\x3e\x27\n\nvar Home =  { template: \x27\x3cdiv\x3e\x27 \x2b s \x2b \x27\x3cdiv\x3ehome\x3c\/div\x3e\x27 \x2b \x27\x3c\/div\x3e\x27, created: function() { console.log(\x27home\x27) } }\nvar Foo = { template: \x27\x3cdiv\x3e\x27 \x2b s \x2b \x27\x3cdiv\x3efoo\x3c\/div\x3e\x27 \x2b \x27\x3c\/div\x3e\x27, created: function() { console.log(\x27foo\x27) \x22}}\x22\nvar Bar = { template: \x27\x3cdiv\x3e\x27 \x2b s \x2b \x27\x3cdiv\x3ebar\x3c\/div\x3e\x27 \x2b \x27\x3c\/div\x3e\x27, created: function() { console.log(\x27bar\x27) \x22}}\x22\nvar NotFoundComponent = { template: \x27\x3cdiv\x3e\x27 \x2b s \x2b \x27\x3cdiv\x3enot found\x3c\/div\x3e\x27 \x2b \x27\x3c\/div\x3e\x27, created: function() { console.log(\x27not found\x27) \x22}}\x22\n\nvar routes = [\n  { path: \x27\/\x27, component: Home },\n  { path: \x27\/foo\x27, component: Foo },\n  { path: \x27\/bar\x27, component: Bar },\n  { path: \x27*\x27, component: NotFoundComponent }\n]\n\nvar router = new VueRouter({\n  mode: \x27history\x27,\n  routes: routes\n})\n\nnew Vue({\n  router: router\n}).$mount(\x27#test\x27)\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3eVue.use(VueRouter)\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e s = \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div\x26gt;\x26lt;router-link to=\x22\/foo\x22\x26gt;Go to Foo\x26lt;\/router-link\x26gt; - \x26lt;router-link to=\x22\/bar\x22\x26gt;Go to Bar\x26lt;\/router-link\x26gt; - \x26lt;router-link to=\x22\/\x22\x26gt;Go to Home\x26lt;\/router-link\x26gt;\x26lt;\/div\x26gt;\x27\x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e Home =  { \x3cspan class=\x22hljs-attr\x22\x3etemplate\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div\x26gt;\x27\x3c\/span\x3e \x2b s \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div\x26gt;home\x26lt;\/div\x26gt;\x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\/div\x26gt;\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ecreated\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{ \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27home\x27\x3c\/span\x3e) } }\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e Foo = { \x3cspan class=\x22hljs-attr\x22\x3etemplate\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div\x26gt;\x27\x3c\/span\x3e \x2b s \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div\x26gt;foo\x26lt;\/div\x26gt;\x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\/div\x26gt;\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ecreated\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{ \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27foo\x27\x3c\/span\x3e) \x22}}\x22\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e Bar = { \x3cspan class=\x22hljs-attr\x22\x3etemplate\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div\x26gt;\x27\x3c\/span\x3e \x2b s \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div\x26gt;bar\x26lt;\/div\x26gt;\x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\/div\x26gt;\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ecreated\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{ \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27bar\x27\x3c\/span\x3e) \x22}}\x22\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e NotFoundComponent = { \x3cspan class=\x22hljs-attr\x22\x3etemplate\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div\x26gt;\x27\x3c\/span\x3e \x2b s \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;div\x26gt;not found\x26lt;\/div\x26gt;\x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;\/div\x26gt;\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ecreated\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{ \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27not found\x27\x3c\/span\x3e) \x22}}\x22\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e routes = [\n  { \x3cspan class=\x22hljs-attr\x22\x3epath\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ecomponent\x3c\/span\x3e: Home },\n  { \x3cspan class=\x22hljs-attr\x22\x3epath\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/foo\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ecomponent\x3c\/span\x3e: Foo },\n  { \x3cspan class=\x22hljs-attr\x22\x3epath\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/bar\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ecomponent\x3c\/span\x3e: Bar },\n  { \x3cspan class=\x22hljs-attr\x22\x3epath\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27*\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3ecomponent\x3c\/span\x3e: NotFoundComponent }\n]\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e router = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e VueRouter({\n  \x3cspan class=\x22hljs-attr\x22\x3emode\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27history\x27\x3c\/span\x3e,\n  \x3cspan class=\x22hljs-attr\x22\x3eroutes\x3c\/span\x3e: routes\n})\n\n\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Vue({\n  \x3cspan class=\x22hljs-attr\x22\x3erouter\x3c\/span\x3e: router\n}).$mount(\x3cspan class=\x22hljs-string\x22\x3e\x27#test\x27\x3c\/span\x3e)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e比如我使用vue-router, 访问\x3ca href=\x22http:\/\/localhost:9090\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/localhost:9090\x3c\/a\x3e，发现显示home，点击Go to Foo，显示foo，地址栏变为\x3ca href=\x22http:\/\/localhost:9090\/foo\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/localhost:9090\/foo\x3c\/a\x3e，一切正常，ok\x3cbr\x3e这时候刷新当前页面(ctrl\x2bR或ctrl\x2bcommand\x2bR或点击浏览器的刷新按钮或在地址栏上再敲一下回车)，发现404了哦\x3cbr\x3evue-router文档针对这种情况做了很好的解释:\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3eNot to worry: To fix the issue, all you need to do is add a simple catch-all fallback route to your server. If the URL doesn\x27t match any static assets, it should serve the same index.html page that your app lives in. Beautiful, again!\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e如果express server使用了connect-history-api-fallback middleware，在你定义router的前面app.use(history({ rewrites: [ { from: \/^\/abc$\/, to: \x27\/\x27 } ] }))一下\x3c\/p\x3e\n\x3cp\x3e再刷新页面，发现地址仍然\x3ca href=\x22http:\/\/localhost:9090\/foo\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/localhost:9090\/foo\x3c\/a\x3e，然而走进了咱们的前端路由，chrome控制台显示了foo，真的是beautiful again\x3c\/p\x3e\n\x3cp\x3e其实过程也很简单啦，请求\/foo，走到了咱们的history-api-fallback中间件，然后他看你没有rewrite，那么好，我把req.url改成\x27\/\x27，于是vue-router发现地址\/foo，所以根据routes的map，渲染了Foo组件\x3c\/p\x3e\n\x3cp\x3e但是万一有人输入地址\/abc，怎么办? vue-router定义了{ path: \x27*\x27, component: NotFoundComponent }用来catch-all route within your Vue app to show a 404 page\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3eAlternatively, if you are using a Node.js server, you can implement the fallback by using the router on the server side to match the incoming URL and respond with 404 if no route is matched.\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e地址输入\/abc，回车，走到vue-router，会显示not found\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e地址输入\/xyz，回车，走到服务端路由，http状态为404，然后显示File not found!\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch3 id=\x22articleHeader0\x22\x3esource code 分析\x3c\/h3\x3e\n\x3cp\x3e贴下代码\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x27use strict\x27;\n\nvar url = require(\x27url\x27);\n\nexports = module.exports = function historyApiFallback(options) {\n  options = options || {};\n  var logger = getLogger(options);\n\n  return function(req, res, next) {\n    var headers = req.headers;\n    if (req.method !== \x27GET\x27) {\n      logger(\n        \x27Not rewriting\x27,\n        req.method,\n        req.url,\n        \x27because the method is not GET.\x27\n      );\n      return next();\n    } else if (!headers || typeof headers.accept !== \x27string\x27) {\n      logger(\n        \x27Not rewriting\x27,\n        req.method,\n        req.url,\n        \x27because the client did not send an HTTP accept header.\x27\n      );\n      return next();\n    } else if (headers.accept.indexOf(\x27application\/json\x27) === 0) {\n      logger(\n        \x27Not rewriting\x27,\n        req.method,\n        req.url,\n        \x27because the client prefers JSON.\x27\n      );\n      return next();\n    } else if (!acceptsHtml(headers.accept, options)) {\n      logger(\n        \x27Not rewriting\x27,\n        req.method,\n        req.url,\n        \x27because the client does not accept HTML.\x27\n      );\n      return next();\n    }\n\n    var parsedUrl = url.parse(req.url);\n    var rewriteTarget;\n    options.rewrites = options.rewrites || [];\n    for (var i = 0; i \x3c options.rewrites.length; i\x2b\x2b) {\n      var rewrite = options.rewrites[i];\n      var match = parsedUrl.pathname.match(rewrite.from);\n      if (match !== null) {\n        rewriteTarget = evaluateRewriteRule(parsedUrl, match, rewrite.to);\n        logger(\x27Rewriting\x27, req.method, req.url, \x27to\x27, rewriteTarget);\n        req.url = rewriteTarget;\n        return next();\n      }\n    }\n\n    if (parsedUrl.pathname.indexOf(\x27.\x27) !== -1 \x26amp;\x26amp;\n        options.disableDotRule !== true) {\n      logger(\n        \x27Not rewriting\x27,\n        req.method,\n        req.url,\n        \x27because the path includes a dot (.) character.\x27\n      );\n      return next();\n    }\n\n    rewriteTarget = options.index || \x27\/index.html\x27;\n    logger(\x27Rewriting\x27, req.method, req.url, \x27to\x27, rewriteTarget);\n    req.url = rewriteTarget;\n    next();\n  };\n};\n\nfunction evaluateRewriteRule(parsedUrl, match, rule) {\n  if (typeof rule === \x27string\x27) {\n    return rule;\n  } else if (typeof rule !== \x27function\x27) {\n    throw new Error(\x27Rewrite rule can only be of type string of function.\x27);\n  }\n\n  return rule({\n    parsedUrl: parsedUrl,\n    match: match\n  });\n}\n\nfunction acceptsHtml(header, options) {\n  options.htmlAcceptHeaders = options.htmlAcceptHeaders || [\x27text\/html\x27, \x27*\/*\x27];\n  for (var i = 0; i \x3c options.htmlAcceptHeaders.length; i\x2b\x2b) {\n    if (header.indexOf(options.htmlAcceptHeaders[i]) !== -1) {\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction getLogger(options) {\n  if (options \x26amp;\x26amp; options.logger) {\n    return options.logger;\n  } else if (options \x26amp;\x26amp; options.verbose) {\n    return console.log.bind(console);\n  }\n  return function(){};\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e\x27use strict\x27\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e url = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27url\x27\x3c\/span\x3e);\n\nexports = \x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ehistoryApiFallback\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eoptions\x3c\/span\x3e) \x3c\/span\x3e{\n  options = options || {};\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e logger = getLogger(options);\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ereq, res, next\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e headers = req.headers;\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (req.method !== \x3cspan class=\x22hljs-string\x22\x3e\x27GET\x27\x3c\/span\x3e) {\n      logger(\n        \x3cspan class=\x22hljs-string\x22\x3e\x27Not rewriting\x27\x3c\/span\x3e,\n        req.method,\n        req.url,\n        \x3cspan class=\x22hljs-string\x22\x3e\x27because the method is not GET.\x27\x3c\/span\x3e\n      );\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next();\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!headers || \x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e headers.accept !== \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e) {\n      logger(\n        \x3cspan class=\x22hljs-string\x22\x3e\x27Not rewriting\x27\x3c\/span\x3e,\n        req.method,\n        req.url,\n        \x3cspan class=\x22hljs-string\x22\x3e\x27because the client did not send an HTTP accept header.\x27\x3c\/span\x3e\n      );\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next();\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (headers.accept.indexOf(\x3cspan class=\x22hljs-string\x22\x3e\x27application\/json\x27\x3c\/span\x3e) === \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) {\n      logger(\n        \x3cspan class=\x22hljs-string\x22\x3e\x27Not rewriting\x27\x3c\/span\x3e,\n        req.method,\n        req.url,\n        \x3cspan class=\x22hljs-string\x22\x3e\x27because the client prefers JSON.\x27\x3c\/span\x3e\n      );\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next();\n    } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!acceptsHtml(headers.accept, options)) {\n      logger(\n        \x3cspan class=\x22hljs-string\x22\x3e\x27Not rewriting\x27\x3c\/span\x3e,\n        req.method,\n        req.url,\n        \x3cspan class=\x22hljs-string\x22\x3e\x27because the client does not accept HTML.\x27\x3c\/span\x3e\n      );\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next();\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e parsedUrl = url.parse(req.url);\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e rewriteTarget;\n    options.rewrites = options.rewrites || [];\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; options.rewrites.length; i\x2b\x2b) {\n      \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e rewrite = options.rewrites[i];\n      \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e match = parsedUrl.pathname.match(rewrite.from);\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (match !== \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e) {\n        rewriteTarget = evaluateRewriteRule(parsedUrl, match, rewrite.to);\n        logger(\x3cspan class=\x22hljs-string\x22\x3e\x27Rewriting\x27\x3c\/span\x3e, req.method, req.url, \x3cspan class=\x22hljs-string\x22\x3e\x27to\x27\x3c\/span\x3e, rewriteTarget);\n        req.url = rewriteTarget;\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next();\n      }\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (parsedUrl.pathname.indexOf(\x3cspan class=\x22hljs-string\x22\x3e\x27.\x27\x3c\/span\x3e) !== \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e \x26amp;\x26amp;\n        options.disableDotRule !== \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e) {\n      logger(\n        \x3cspan class=\x22hljs-string\x22\x3e\x27Not rewriting\x27\x3c\/span\x3e,\n        req.method,\n        req.url,\n        \x3cspan class=\x22hljs-string\x22\x3e\x27because the path includes a dot (.) character.\x27\x3c\/span\x3e\n      );\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e next();\n    }\n\n    rewriteTarget = options.index || \x3cspan class=\x22hljs-string\x22\x3e\x27\/index.html\x27\x3c\/span\x3e;\n    logger(\x3cspan class=\x22hljs-string\x22\x3e\x27Rewriting\x27\x3c\/span\x3e, req.method, req.url, \x3cspan class=\x22hljs-string\x22\x3e\x27to\x27\x3c\/span\x3e, rewriteTarget);\n    req.url = rewriteTarget;\n    next();\n  };\n};\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eevaluateRewriteRule\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eparsedUrl, match, rule\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e rule === \x3cspan class=\x22hljs-string\x22\x3e\x27string\x27\x3c\/span\x3e) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e rule;\n  } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e rule !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27Rewrite rule can only be of type string of function.\x27\x3c\/span\x3e);\n  }\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e rule({\n    \x3cspan class=\x22hljs-attr\x22\x3eparsedUrl\x3c\/span\x3e: parsedUrl,\n    \x3cspan class=\x22hljs-attr\x22\x3ematch\x3c\/span\x3e: match\n  });\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eacceptsHtml\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eheader, options\x3c\/span\x3e) \x3c\/span\x3e{\n  options.htmlAcceptHeaders = options.htmlAcceptHeaders || [\x3cspan class=\x22hljs-string\x22\x3e\x27text\/html\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27*\/*\x27\x3c\/span\x3e];\n  \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; options.htmlAcceptHeaders.length; i\x2b\x2b) {\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (header.indexOf(options.htmlAcceptHeaders[i]) !== \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e;\n    }\n  }\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetLogger\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eoptions\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (options \x26amp;\x26amp; options.logger) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e options.logger;\n  } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (options \x26amp;\x26amp; options.verbose) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log.bind(\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e);\n  }\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{};\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVHgOa?w=462\x26amp;h=223\x22 src=\x22https:\/\/static.alili.tech\/img\/bVHgOa?w=462\x26amp;h=223\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3egetLogger, 默认不输出，options.verbose为true，则默认console.log.bind(console)，但不知道这里bind意义何在 - -，也可以直接传logger，比如debug\x3c\/p\x3e\n\x3cp\x3e如果req.method != \x27GET\x27，灰，结束\x3cbr\x3e如果!headers || !headers.accept != \x27string\x27 (有这情况?)，灰，结束\x3cbr\x3e如果headers.accept.indexOf(\x27application\/json\x27) === 0，灰，结束\x3c\/p\x3e\n\x3cp\x3eacceptsHtml函数a判断headers.accept字符串是否含有[\x27text\/html\x27, \x27\x3cem\x3e\/\x3c\/em\x3e\x27]中任意一个\x3cbr\x3e当然不够这两个不够你可以自定义到选项options.htmlAcceptHeaders中\x3cbr\x3e!acceptsHtml(headers.accept, options)，灰，结束\x3c\/p\x3e\n\x3cp\x3e然后根据你定义的选项rewrites(没定义就相当于跳过了)\x3cbr\x3e按定义的数组顺序，字符串依次匹配路由rewrite.from，匹配成功则走rewrite.to，to可以是字符串也可以是函数，绿，结束\x3c\/p\x3e\n\x3cp\x3e判断dot file，即pathname中包含.(点)，并且选项disableDotRule !== true，即没有关闭点文件限制规则，灰，结束\x3cbr\x3e那么剩下的情况(parsedUrl.pathname不含点，或者含点但关闭了点文件规则)\x3cbr\x3erewriteTarget = options.index || \x27\/index.html\x27，绿结束\x3c\/p\x3e\n\x3cp\x3e稍微注意下，他是先匹配自定义rewrites规则，再匹配点文件规则\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e测试部分\x3c\/h3\x3e\n\x3cp\x3e用的是nodeunit，具体用法\x3ca href=\x22https:\/\/github.com\/caolan\/nodeunit\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/caolan\/nod...\x3c\/a\x3e\x3cbr\x3e随便看两个测试用例\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\nvar sinon = require(\x27sinon\x27);\nvar historyApiFallback = require(\x27..\/lib\x27);\n\nvar tests = module.exports = {};\n\nvar middleware;\nvar req = null;\nvar requestedUrl;\nvar next;\n\ntests.setUp = function(done) {\n  middleware = historyApiFallback();\n  requestedUrl = \x27\/foo\x27;\n  req = {\n    method: \x27GET\x27,\n    url: requestedUrl,\n    headers: {\n      accept: \x27text\/html, *\/*\x27\n    }\n  };\n  next = sinon.stub();\n\n  done();\n};\n\n\/\/ ....\n\ntests[\x27should ignore requests that do not accept html\x27] = function(test) {\n  req.headers.accept = \x27application\/json\x27;\n  \/\/ 调用middleware\n  middleware(req, null, next);\n  \/\/ 测试req.url是否等于requestedUrl\n  test.equal(req.url, requestedUrl);\n  \/\/ next是否被调用过\n  test.ok(next.called);\n  \/\/ 测试结束\n  test.done();\n};\n\n\/\/ ...\n\ntests[\x27should rewrite requests when the . rule is disabled\x27] = function(test) {\n  req.url = \x27js\/app.js\x27;\n  middleware = historyApiFallback({\n    disableDotRule: true\n  });\n  middleware(req, null, next);\n  \/\/ 测试req.url是否等于\/index.html\n  \/\/ 因为pathname中有点，且关闭了点规则\n  \/\/ req.url应该被rewrit成了\/index.html\n  test.equal(req.url, \x27\/index.html\x27);\n  test.ok(next.called);\n  test.done();\n};\n\n\/\/ ...\ntests[\x27should test rewrite rules\x27] = function(test) {\n  req.url = \x27\/socer\x27;\n  middleware = historyApiFallback({\n    rewrites: [\n      {from: \/\\\/soccer\/, to: \x27\/soccer.html\x27}\n    ]\n  });\n     \n  middleware(req, null, next);\n  \/\/ 因为没有匹配上rewrites里的规则\n  \/\/ 而req.url pathname又不含点\n  \/\/ 所以req.url 倒退到了index.html\n  test.equal(req.url, \x27\/index.html\x27);\n  test.ok(next.called);\n  test.done();\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sinon = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27sinon\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e historyApiFallback = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27..\/lib\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e tests = \x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = {};\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e middleware;\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e req = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e requestedUrl;\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e next;\n\ntests.setUp = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3edone\x3c\/span\x3e) \x3c\/span\x3e{\n  middleware = historyApiFallback();\n  requestedUrl = \x3cspan class=\x22hljs-string\x22\x3e\x27\/foo\x27\x3c\/span\x3e;\n  req = {\n    \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27GET\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3eurl\x3c\/span\x3e: requestedUrl,\n    \x3cspan class=\x22hljs-attr\x22\x3eheaders\x3c\/span\x3e: {\n      \x3cspan class=\x22hljs-attr\x22\x3eaccept\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27text\/html, *\/*\x27\x3c\/span\x3e\n    }\n  };\n  next = sinon.stub();\n\n  done();\n};\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ ....\x3c\/span\x3e\n\ntests[\x3cspan class=\x22hljs-string\x22\x3e\x27should ignore requests that do not accept html\x27\x3c\/span\x3e] = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3etest\x3c\/span\x3e) \x3c\/span\x3e{\n  req.headers.accept = \x3cspan class=\x22hljs-string\x22\x3e\x27application\/json\x27\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 调用middleware\x3c\/span\x3e\n  middleware(req, \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, next);\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 测试req.url是否等于requestedUrl\x3c\/span\x3e\n  test.equal(req.url, requestedUrl);\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ next是否被调用过\x3c\/span\x3e\n  test.ok(next.called);\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 测试结束\x3c\/span\x3e\n  test.done();\n};\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n\ntests[\x3cspan class=\x22hljs-string\x22\x3e\x27should rewrite requests when the . rule is disabled\x27\x3c\/span\x3e] = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3etest\x3c\/span\x3e) \x3c\/span\x3e{\n  req.url = \x3cspan class=\x22hljs-string\x22\x3e\x27js\/app.js\x27\x3c\/span\x3e;\n  middleware = historyApiFallback({\n    \x3cspan class=\x22hljs-attr\x22\x3edisableDotRule\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n  });\n  middleware(req, \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, next);\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 测试req.url是否等于\/index.html\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 因为pathname中有点，且关闭了点规则\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ req.url应该被rewrit成了\/index.html\x3c\/span\x3e\n  test.equal(req.url, \x3cspan class=\x22hljs-string\x22\x3e\x27\/index.html\x27\x3c\/span\x3e);\n  test.ok(next.called);\n  test.done();\n};\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\ntests[\x3cspan class=\x22hljs-string\x22\x3e\x27should test rewrite rules\x27\x3c\/span\x3e] = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3etest\x3c\/span\x3e) \x3c\/span\x3e{\n  req.url = \x3cspan class=\x22hljs-string\x22\x3e\x27\/socer\x27\x3c\/span\x3e;\n  middleware = historyApiFallback({\n    \x3cspan class=\x22hljs-attr\x22\x3erewrites\x3c\/span\x3e: [\n      {\x3cspan class=\x22hljs-attr\x22\x3efrom\x3c\/span\x3e: \x3cspan class=\x22hljs-regexp\x22\x3e\/\\\/soccer\/\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3eto\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27\/soccer.html\x27\x3c\/span\x3e}\n    ]\n  });\n     \n  middleware(req, \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e, next);\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 因为没有匹配上rewrites里的规则\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 而req.url pathname又不含点\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 所以req.url 倒退到了index.html\x3c\/span\x3e\n  test.equal(req.url, \x3cspan class=\x22hljs-string\x22\x3e\x27\/index.html\x27\x3c\/span\x3e);\n  test.ok(next.called);\n  test.done();\n};\x3c\/code\x3e\x3c\/pre\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>connect-history-api-fallback分析</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000007890379">https://segmentfault.com/a/1190000007890379</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/32tudf93d15/" target="_blank">https://alili.tech/archive/32tudf93d15/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5x6tenwjeux/">ES6中的异步编程：Generators函数&#43;Promise:最强大的异步处理方式<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/nvtmua2a1hd/">GreenSock (TweenMax) 极简入门指南<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/7kt5s47oysx/">HTML5 中 canvas 的使用总结<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/41pgo3a2iyp/">JavaScript 开发者所需要知道的 V8（一）：V8 In NodeJS<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/krb1zm7x38j/">JavaScript 时间与日期处理实战:你肯定被坑过<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/yh2lq30d0x/">JavaScript中的各种宽高属性<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/eydwczesyv/">Muse UI — 基于 Vue2.0 的 Material Design UI 库<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/y62oejm8cr/">Nodejs基础：路径处理模块path总结<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/06cwh88ankmd/">PhantomJS &amp; NodeJS 在京东网站前端监控平台的最佳实践<aside class="dates">2019-01-31</aside></a></li><li><a href="/archive/z4ymvs0jz2h/">Promise 的链式调用与中止<aside class="dates">2019-01-31</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>