<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="从零实现一个简单的 Promise"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>从零实现一个简单的 Promise | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/g2l5bwplc0q/",
				"appid": "1613049289050283", 
				"title": "从零实现一个简单的 Promise | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-01-06T02:30:10"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/p0ig7q2v9ac/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/76sfxfg8ify/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f&text=%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20Promise"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f&text=%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20Promise"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f&title=%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20Promise"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f&is_video=false&description=%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20Promise"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20Promise&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f&title=%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20Promise"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f&title=%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20Promise"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f&title=%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20Promise"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fg2l5bwplc0q%2f&title=%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20Promise"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">从零实现一个简单的 Promise</h1><div class="meta"><div class="postdate"><time datetime="2019-01-06" itemprop="datePublished">2019-01-06</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e本文参考了\x3cdiv class=\x22video-prev vp_XMjY4MjM4MjA2MA==\x22\x3e\x3cdiv class=\x22clearfix video-header\x22\x3e\x3cimg class=\x22pull-left\x22 src=\x22https:\/\/static.alili.techundefined\x22\x3e\x3cdiv class=\x22pull-left\x22\x3e\x3ch5\x3eNode.js 实践教程 - Promise 实现\x3c\/h5\x3e\x3cspan class=\x22text-muted\x22\x3ehttp:\/\/v.youku.com\/v_show\/id_XMjY4MjM4MjA2MA==.html\x3c\/span\x3e\x3c\/div\x3e\x3c\/div\x3e\x3c\/div\x3e这个视频，并添加了自己的一些想法。\x3c\/p\x3e\n\x3cp\x3e首先来看 Promise 的构造：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 这里用 Prometheus 代替 Promise\nlet p = new Prometheus((resolve, reject) =\x3e {\n    resolve(\x27hello\x27)\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 这里用 Prometheus 代替 Promise\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e p = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Prometheus(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27hello\x27\x3c\/span\x3e)\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e下面我们来实现它：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 三种状态\nconst PENDING = Symbol()\nconst FULFILLED = Symbol()\nconst REJECTED = Symbol()\n\nfunction Prometheus (fn) {\n    \/\/ fn 必须是函数\n    if (typeof fn !== \x27function\x27) {\n        throw new Error(\x27fn must be a function!\x27)\n    }\n\n    let state = PENDING \/\/ 初始状态是 PENDING\n    let value = null \/\/ 返回值\n\n    function fulfill (result) {\n        state = FULFILLED\n        value = result\n    }\n\n    \/\/ 完成时调用的方法，这里做了容错\n    function resolve (result) {\n        try {\n            fulfill(result)\n        } catch (err) {\n            reject(err)\n        }\n    }\n\n    \/\/ 拒绝时调用的方法\n    function reject (error) {\n        state = REJECTED\n        value = error\n    }\n\n    fn(resolve, reject)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 三种状态\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e PENDING = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e FULFILLED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e REJECTED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ePrometheus\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3efn\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ fn 必须是函数\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e fn !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fn must be a function!\x27\x3c\/span\x3e)\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e state = PENDING \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始状态是 PENDING\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e value = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回值\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efulfill\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        state = FULFILLED\n        value = result\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 完成时调用的方法，这里做了容错\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eresolve\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n            fulfill(result)\n        } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n            reject(err)\n        }\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 拒绝时调用的方法\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ereject\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerror\x3c\/span\x3e) \x3c\/span\x3e{\n        state = REJECTED\n        value = error\n    }\n\n    fn(resolve, reject)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e第二步，实现 then 方法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let p = new Prometheus((resolve, reject) =\x3e {\n    resolve(\x27hello\x27)\n})\n\np.then(val =\x3e {\n    console.log(val)\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e p = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Prometheus(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27hello\x27\x3c\/span\x3e)\n})\n\np.then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(val)\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 三种状态\nconst PENDING = Symbol()\nconst FULFILLED = Symbol()\nconst REJECTED = Symbol()\n\nfunction Prometheus (fn) {\n    \/\/ fn 必须是函数\n    if (typeof fn !== \x27function\x27) {\n        throw new Error(\x27fn must be a function!\x27)\n    }\n\n    let state = PENDING \/\/ 初始状态是 PENDING\n    let value = null \/\/ 返回值\n\n    function fulfill (result) {\n        state = FULFILLED\n        value = result\n    }\n\n    \/\/ 完成时调用的方法，这里做了容错\n    function resolve (result) {\n        try {\n            fulfill(result)\n        } catch (err) {\n            reject(err)\n        }\n    }\n\n    \/\/ 拒绝时调用的方法\n    function reject (error) {\n        state = REJECTED\n        value = error\n    }\n\n    this.then = function (onFulfill, onReject) {\n        switch (state) {\n            case FULFILLED:\n                onFulfill(value)\n                break\n            case REJECTED:\n                onReject(value)\n                break\n        }\n    }\n\n    fn(resolve, reject)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 三种状态\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e PENDING = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e FULFILLED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e REJECTED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ePrometheus\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3efn\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ fn 必须是函数\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e fn !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fn must be a function!\x27\x3c\/span\x3e)\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e state = PENDING \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始状态是 PENDING\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e value = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回值\x3c\/span\x3e\n\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efulfill\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        state = FULFILLED\n        value = result\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 完成时调用的方法，这里做了容错\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eresolve\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n            fulfill(result)\n        } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n            reject(err)\n        }\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 拒绝时调用的方法\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ereject\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerror\x3c\/span\x3e) \x3c\/span\x3e{\n        state = REJECTED\n        value = error\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.then = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eonFulfill, onReject\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eswitch\x3c\/span\x3e (state) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e FULFILLED:\n                onFulfill(value)\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e REJECTED:\n                onReject(value)\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e\n        }\n    }\n\n    fn(resolve, reject)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e第三步，在 Promise 里使用异步\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let p = new Prometheus((resolve, reject) =\x3e {\n    setTimeout(() =\x3e {\n        resolve(\x27hello\x27)\n    }, 0)\n})\n\np.then(val =\x3e {\n    console.log(val)\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e p = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Prometheus(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27hello\x27\x3c\/span\x3e)\n    }, \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e)\n})\n\np.then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(val)\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e直接运行上面的代码发现控制台没有打印出 \x3ccode\x3ehello\x3c\/code\x3e，原因是 \x3ccode\x3ePrometheus\x3c\/code\x3e 里的代码是异步执行，导致记下来执行 \x3ccode\x3ethen\x3c\/code\x3e 方法的时候，\x3ccode\x3estate\x3c\/code\x3e 是 \x3ccode\x3ePENDING\x3c\/code\x3e，后面再执行 \x3ccode\x3eresolve\x3c\/code\x3e 的时候就不会走到 \x3ccode\x3eonFulfill\x3c\/code\x3e 了，所以我们要在 \x3ccode\x3ethen\x3c\/code\x3e 方法里添加 \x3ccode\x3estate\x3c\/code\x3e 为 \x3ccode\x3ePENDING\x3c\/code\x3e 的分支判断，把 \x3ccode\x3eonFulfill\x3c\/code\x3e 和 \x3ccode\x3eonReject\x3c\/code\x3e 存到一个变量中：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 三种状态\nconst PENDING = Symbol()\nconst FULFILLED = Symbol()\nconst REJECTED = Symbol()\n\nfunction Prometheus (fn) {\n    \/\/ fn 必须是函数\n    if (typeof fn !== \x27function\x27) {\n        throw new Error(\x27fn must be a function!\x27)\n    }\n\n    let state = PENDING \/\/ 初始状态是 PENDING\n    let value = null \/\/ 返回值\n    let hanler = {}\n\n    function fulfill (result) {\n        state = FULFILLED\n        value = result\n        handler.onFulfill(result)\n    }\n\n    \/\/ 完成时调用的方法，这里做了容错\n    function resolve (result) {\n        try {\n            fulfill(result)\n        } catch (err) {\n            reject(err)\n        }\n    }\n\n    \/\/ 拒绝时调用的方法\n    function reject (error) {\n        state = REJECTED\n        value = error\n        handler.onReject(error)\n    }\n\n    this.then = function (onFulfill, onReject) {\n        switch (state) {\n            case FULFILLED:\n                onFulfill(value)\n                break\n            case REJECTED:\n                onReject(value)\n                break\n            case PENDING:\n                handler = { onFulfill, onReject }\n        }\n    }\n\n    fn(resolve, reject)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 三种状态\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e PENDING = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e FULFILLED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e REJECTED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ePrometheus\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3efn\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ fn 必须是函数\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e fn !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fn must be a function!\x27\x3c\/span\x3e)\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e state = PENDING \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始状态是 PENDING\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e value = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回值\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e hanler = {}\n\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efulfill\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        state = FULFILLED\n        value = result\n        handler.onFulfill(result)\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 完成时调用的方法，这里做了容错\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eresolve\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n            fulfill(result)\n        } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n            reject(err)\n        }\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 拒绝时调用的方法\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ereject\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerror\x3c\/span\x3e) \x3c\/span\x3e{\n        state = REJECTED\n        value = error\n        handler.onReject(error)\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.then = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eonFulfill, onReject\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eswitch\x3c\/span\x3e (state) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e FULFILLED:\n                onFulfill(value)\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e REJECTED:\n                onReject(value)\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e PENDING:\n                handler = { onFulfill, onReject }\n        }\n    }\n\n    fn(resolve, reject)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e异步实现了，我们再回过头看看同步是否正常运行：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let p = new Prometheus((resolve, reject) =\x3e {\n  resolve(\x27hello\x27)\n})\n\np.then(val =\x3e {\n    console.log(val)\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e p = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Prometheus(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27hello\x27\x3c\/span\x3e)\n})\n\np.then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(val)\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e发现报错信息：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22TypeError: handler.onReject is not a function\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22bash hljs\x22\x3e\x3ccode class=\x22bash\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3eTypeError: handler.onReject is not a \x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e因为同步执行的时候，\x3ccode\x3efulfill\x3c\/code\x3e 里 \x3ccode\x3ehandler\x3c\/code\x3e 是 \x3ccode\x3e{}\x3c\/code\x3e，所以会报错。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 三种状态\nconst PENDING = Symbol()\nconst FULFILLED = Symbol()\nconst REJECTED = Symbol()\n\nfunction Prometheus (fn) {\n    \/\/ fn 必须是函数\n    if (typeof fn !== \x27function\x27) {\n        throw new Error(\x27fn must be a function!\x27)\n    }\n\n    let state = PENDING \/\/ 初始状态是 PENDING\n    let value = null \/\/ 返回值\n    let handler = {}\n\n    function fulfill (result) {\n        state = FULFILLED\n        value = result\n        next(handler)\n    }\n\n    \/\/ 完成时调用的方法，这里做了容错\n    function resolve (result) {\n        try {\n            fulfill(result)\n        } catch (err) {\n            reject(err)\n        }\n    }\n\n    \/\/ 拒绝时调用的方法\n    function reject (error) {\n        state = REJECTED\n        value = error\n        next(handler)\n    }\n\n    function next({ onFulfill, onReject }) {\n        switch (state) {\n            case FULFILLED:\n                onFulfill \x26amp;\x26amp; onFulfill(value)\n                break\n            case REJECTED:\n                onReject \x26amp;\x26amp; onReject(value)\n                break\n            case PENDING:\n                handler = { onFulfill, onReject }\n        }\n    }\n\n    this.then = function (onFulfill, onReject) {\n        next({onFulfill, onReject})\n    }\n\n    fn(resolve, reject)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 三种状态\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e PENDING = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e FULFILLED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e REJECTED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ePrometheus\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3efn\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ fn 必须是函数\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e fn !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fn must be a function!\x27\x3c\/span\x3e)\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e state = PENDING \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始状态是 PENDING\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e value = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回值\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e handler = {}\n\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efulfill\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        state = FULFILLED\n        value = result\n        next(handler)\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 完成时调用的方法，这里做了容错\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eresolve\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n            fulfill(result)\n        } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n            reject(err)\n        }\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 拒绝时调用的方法\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ereject\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerror\x3c\/span\x3e) \x3c\/span\x3e{\n        state = REJECTED\n        value = error\n        next(handler)\n    }\n\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3enext\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e{ onFulfill, onReject }\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eswitch\x3c\/span\x3e (state) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e FULFILLED:\n                onFulfill \x26amp;\x26amp; onFulfill(value)\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e REJECTED:\n                onReject \x26amp;\x26amp; onReject(value)\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e PENDING:\n                handler = { onFulfill, onReject }\n        }\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.then = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eonFulfill, onReject\x3c\/span\x3e) \x3c\/span\x3e{\n        next({onFulfill, onReject})\n    }\n\n    fn(resolve, reject)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e现在同步也可以正常运行了，接下来看看多个 \x3ccode\x3ethen\x3c\/code\x3e 链式调用：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let p = new Prometheus((resolve, reject) =\x3e {\n  resolve(\x27hello\x27)\n})\n\np.then(val =\x3e {\n    console.log(val)\n    return \x27world\x27\n}).then(val =\x3e {\n    console.log(val)\n})\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e p = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Prometheus(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n  resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27hello\x27\x3c\/span\x3e)\n})\n\np.then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(val)\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27world\x27\x3c\/span\x3e\n}).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(val)\n})\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e执行代码会发现如下报错信息：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22TypeError: Cannot read property \x27then\x27 of undefined\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs applescript\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3eTypeError: Cannot \x3cspan class=\x22hljs-built_in\x22\x3eread\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eproperty\x3c\/span\x3e \x27\x3cspan class=\x22hljs-keyword\x22\x3ethen\x3c\/span\x3e\x27 \x3cspan class=\x22hljs-keyword\x22\x3eof\x3c\/span\x3e undefined\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e原因是 \x3ccode\x3ethen\x3c\/code\x3e 方法没有返回 \x3ccode\x3ePromise\x3c\/code\x3e。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 三种状态\nconst PENDING = Symbol()\nconst FULFILLED = Symbol()\nconst REJECTED = Symbol()\n\nfunction Prometheus (fn) {\n    \/\/ fn 必须是函数\n    if (typeof fn !== \x27function\x27) {\n        throw new Error(\x27fn must be a function!\x27)\n    }\n\n    let state = PENDING \/\/ 初始状态是 PENDING\n    let value = null \/\/ 返回值\n    let handler = {}\n\n    function fulfill (result) {\n        state = FULFILLED\n        value = result\n        next(handler)\n    }\n\n    \/\/ 完成时调用的方法，这里做了容错\n    function resolve (result) {\n        try {\n            fulfill(result)\n        } catch (err) {\n            reject(err)\n        }\n    }\n\n    \/\/ 拒绝时调用的方法\n    function reject (error) {\n        state = REJECTED\n        value = error\n        next(handler)\n    }\n\n    function next({ onFulfill, onReject }) {\n        switch (state) {\n            case FULFILLED:\n                onFulfill \x26amp;\x26amp; onFulfill(value)\n                break\n            case REJECTED:\n                onReject \x26amp;\x26amp; onReject(value)\n                break\n            case PENDING:\n                handler = { onFulfill, onReject }\n        }\n    }\n\n    this.then = function (onFulfill, onReject) {\n        return new Prometheus((resolve, reject) =\x3e {\n            next({\n                onFulfill: val =\x3e {\n                    resolve(onFulfill(val))\n                },\n                onReject: err =\x3e {\n                    reject(onReject(err))\n                }\n            })\n        })\n    }\n\n    fn(resolve, reject)\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 三种状态\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e PENDING = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e FULFILLED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e REJECTED = \x3cspan class=\x22hljs-built_in\x22\x3eSymbol\x3c\/span\x3e()\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ePrometheus\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3efn\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ fn 必须是函数\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3etypeof\x3c\/span\x3e fn !== \x3cspan class=\x22hljs-string\x22\x3e\x27function\x27\x3c\/span\x3e) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eError\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27fn must be a function!\x27\x3c\/span\x3e)\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e state = PENDING \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始状态是 PENDING\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e value = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 返回值\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e handler = {}\n\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3efulfill\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        state = FULFILLED\n        value = result\n        next(handler)\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 完成时调用的方法，这里做了容错\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eresolve\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n            fulfill(result)\n        } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n            reject(err)\n        }\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 拒绝时调用的方法\x3c\/span\x3e\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ereject\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerror\x3c\/span\x3e) \x3c\/span\x3e{\n        state = REJECTED\n        value = error\n        next(handler)\n    }\n\n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3enext\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e{ onFulfill, onReject }\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3eswitch\x3c\/span\x3e (state) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e FULFILLED:\n                onFulfill \x26amp;\x26amp; onFulfill(value)\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e REJECTED:\n                onReject \x26amp;\x26amp; onReject(value)\n                \x3cspan class=\x22hljs-keyword\x22\x3ebreak\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ecase\x3c\/span\x3e PENDING:\n                handler = { onFulfill, onReject }\n        }\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.then = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eonFulfill, onReject\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Prometheus(\x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eresolve, reject\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n            next({\n                \x3cspan class=\x22hljs-attr\x22\x3eonFulfill\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n                    resolve(onFulfill(val))\n                },\n                \x3cspan class=\x22hljs-attr\x22\x3eonReject\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n                    reject(onReject(err))\n                }\n            })\n        })\n    }\n\n    fn(resolve, reject)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e再次运行，正确打印出结果。\x3c\/p\x3e\n\x3cp\x3e到此，一个非常简单的 Promise 就实现了，当然，这里其实还有很多细节没有考虑，具体还要参考 \x3ca href=\x22https:\/\/promisesaplus.com\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ePromise\/A\x2b\x3c\/a\x3e。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>从零实现一个简单的 Promise</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000010410543">https://segmentfault.com/a/1190000010410543</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/g2l5bwplc0q/" target="_blank">https://alili.tech/archive/g2l5bwplc0q/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/z09muaar7j/">2年前端应该会哪些技能<aside class="dates">2019-02-01</aside></a></li><li><a href="/archive/ke982v6qrfg/">CSS 性能优化笔记<aside class="dates">2019-02-01</aside></a></li><li><a href="/archive/if1i2hs28ah/">H5打造3d场景不完全攻略（二）: Amazing CSS3D<aside class="dates">2019-02-01</aside></a></li><li><a href="/archive/s4apghsr7o/">JS原生一步步实现前端路由和单页面应用<aside class="dates">2019-02-01</aside></a></li><li><a href="/archive/hjgkntbgqek/">JavaScript 中对大量数据的多重过滤<aside class="dates">2019-02-01</aside></a></li><li><a href="/archive/h1hfvr2a2nj/">JavaScript 中的错误处理机制<aside class="dates">2019-02-01</aside></a></li><li><a href="/archive/a0ukpm125gm/">JavaScript 数组分组的实现<aside class="dates">2019-02-01</aside></a></li><li><a href="/archive/fwosouhbhmj/">JavaScript 类型转换深度学习<aside class="dates">2019-02-01</aside></a></li><li><a href="/archive/z193p9xv2p/">JavaScript设计模式之发布-订阅模式（观察者模式）-Part1<aside class="dates">2019-02-01</aside></a></li><li><a href="/archive/6i7sr0vgkxm/">Javascript中的时间<aside class="dates">2019-02-01</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>